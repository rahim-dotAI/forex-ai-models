name: Run AI Forex Brain Pipeline

on:
  push:
    paths:
      - 'colab_trigger.txt'
    branches:
      - main
  workflow_dispatch:

jobs:
  run-forex-brain:
    runs-on: ubuntu-latest
    env:
      FOREX_PAT: ${{ secrets.FOREX_PAT }}
      BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
      ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
      GIT_USER_NAME: "Forex AI Bot"
      GIT_USER_EMAIL: "nakatonabira3@gmail.com"
      GITHUB_USERNAME: "rahim-dotAI"
      GITHUB_REPO: "forex-ai-models"
      PYTHONIOENCODING: utf-8
      PYTHONUNBUFFERED: 1

    steps:
      # 0Ô∏è‚É£ Pre-clean any broken submodules
      - name: Remove broken submodules before checkout
        run: |
          echo "üßπ Cleaning any broken .gitmodules or nested repos..."
          rm -f .gitmodules || true
          rm -rf forex_ai_outputs/forex-ai-models || true
          echo "‚úÖ Cleaned potential submodule conflicts"

      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
          lfs: false
          submodules: false
          clean: true
          set-safe-directory: true

      # 2Ô∏è‚É£ Verify required secrets
      - name: Check required secrets
        run: |
          if [ -z "${FOREX_PAT}" ]; then
            echo "‚ùå FOREX_PAT secret is missing!"
            exit 1
          fi
          if [ -z "${BROWSERLESS_TOKEN}" ]; then
            echo "‚ö†Ô∏è BROWSERLESS_TOKEN secret is missing. Live prices will be skipped."
          fi
          if [ -z "${ALPHA_VANTAGE_KEY}" ]; then
            echo "‚ö†Ô∏è ALPHA_VANTAGE_KEY secret is missing. Alpha Vantage data fetch will fail."
          fi

      # 3Ô∏è‚É£ Set up Python 3.11
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'

      # 4Ô∏è‚É£ Upgrade pip & install dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install mplfinance firebase-admin dropbox requests beautifulsoup4 \
            pandas numpy ta yfinance pyppeteer nest_asyncio lightgbm joblib \
            matplotlib alpha_vantage tqdm scikit-learn river jupyter

      # 5Ô∏è‚É£ Create working directories (including Colab-style paths)
      - name: Create working directories
        run: |
          # Create standard working directories in current location
          mkdir -p /home/runner/work/forex-ai-models/forex-alpha-models/csvs
          mkdir -p /home/runner/work/forex-ai-models/forex-alpha-models/pickles
          mkdir -p /home/runner/work/forex-ai-models/forex-alpha-models/logs
          mkdir -p /home/runner/work/forex-ai-models/forex-alpha-models/merged_data_pickles
          mkdir -p /home/runner/work/forex-ai-models/forex-alpha-models/temp_pickles
          
          # Create /content directory structure for Colab compatibility
          sudo mkdir -p /content/forex-automation
          sudo mkdir -p /content/forex-alpha-models/csvs
          sudo mkdir -p /content/forex-alpha-models/pickles
          sudo mkdir -p /content/forex-alpha-models/logs
          sudo mkdir -p /content/forex-alpha-models/merged_data_pickles
          sudo mkdir -p /content/forex-alpha-models/temp_pickles
          sudo mkdir -p /content/forex-alpha-models/forex-ai-models
          
          # Give current user ownership of /content
          sudo chown -R $USER:$USER /content
          sudo chmod -R 755 /content
          
          # Create symlink from working directory to /content
          cd /home/runner/work/forex-ai-models
          ln -sf /content/forex-alpha-models forex-alpha-models 2>/dev/null || true
          
          echo "‚úÖ Working directories created (including Colab paths and symlinks)"

      # 6Ô∏è‚É£ Configure Git globally
      - name: Configure Git
        run: |
          git config --global user.name "${GIT_USER_NAME}"
          git config --global user.email "${GIT_USER_EMAIL}"
          git config --global advice.detachedHead false
          git config --global credential.helper store
          echo "https://${GITHUB_USERNAME}:${FOREX_PAT}@github.com" > ~/.git-credentials
          echo "‚úÖ Git configured with credentials"

      # 7Ô∏è‚É£ Convert notebook to Python script and clean
      - name: Convert notebook to Python script
        run: |
          echo "üìù Converting notebook to Python script..."
          jupyter nbconvert --to python "AI_Forex_Brain_2.ipynb" --output ai_forex_brain_2
          
          echo "üßπ Removing Jupyter-specific commands..."
          # Remove get_ipython() calls (like !pip install)
          sed -i '/get_ipython()/d' ai_forex_brain_2.py
          
          # Remove any remaining IPython magic commands
          sed -i '/^get_ipython/d' ai_forex_brain_2.py
          
          # Patch the script to create directories with parents=True safely
          sed -i 's/folder\.mkdir(exist_ok=True)/folder.mkdir(parents=True, exist_ok=True)/g' ai_forex_brain_2.py
          
          echo "‚úÖ Notebook converted and cleaned successfully"

      # 8Ô∏è‚É£ Execute AI Forex Brain Python Script
      - name: Execute AI Forex Brain Pipeline
        env:
          GITHUB_ACTIONS: "true"
        run: |
          echo "üöÄ Starting AI Forex Brain Pipeline..."
          
          # Function to create all necessary directories
          create_forex_dirs() {
            local base_dir=$1
            mkdir -p "$base_dir/forex-alpha-models/csvs"
            mkdir -p "$base_dir/forex-alpha-models/pickles"
            mkdir -p "$base_dir/forex-alpha-models/logs"
            mkdir -p "$base_dir/forex-alpha-models/merged_data_pickles"
            mkdir -p "$base_dir/forex-alpha-models/temp_pickles"
            mkdir -p "$base_dir/forex-alpha-models/forex-ai-models"
          }
          
          # Create directories in all possible locations
          create_forex_dirs "/home/runner/work/forex-ai-models"
          create_forex_dirs "/home/runner/work/forex-ai-models/forex-ai-models"
          create_forex_dirs "/content"
          create_forex_dirs "/content/forex-automation"
          create_forex_dirs "/content/forex-automation/forex-ai-models"
          create_forex_dirs "/content/forex-automation/forex-ai-models/forex-alpha-models"
          
          # Create symlinks in key locations
          for dir in \
            "/home/runner/work/forex-ai-models" \
            "/home/runner/work/forex-ai-models/forex-ai-models" \
            "/content/forex-automation/forex-ai-models" \
            "/content/forex-automation/forex-ai-models/forex-alpha-models"
          do
            if [ -d "$dir" ]; then
              cd "$dir"
              if [ ! -L "forex-alpha-models" ] && [ ! -d "forex-alpha-models/csvs" ]; then
                rm -rf forex-alpha-models 2>/dev/null || true
                ln -sf /content/forex-alpha-models forex-alpha-models
              fi
            fi
          done
          
          # Run the pipeline from the repo directory
          cd /home/runner/work/forex-ai-models/forex-ai-models
          
          # Create a monitor script that periodically creates directories
          cat > monitor_dirs.sh << 'EOF'
#!/bin/bash
while true; do
  for dir in \
    "/content/forex-automation/forex-ai-models/forex-alpha-models/csvs" \
    "/content/forex-automation/forex-ai-models/forex-alpha-models/pickles" \
    "/content/forex-automation/forex-ai-models/forex-alpha-models/logs"
  do
    mkdir -p "$dir" 2>/dev/null || true
  done
  sleep 5
done
EOF
          chmod +x monitor_dirs.sh
          ./monitor_dirs.sh &
          MONITOR_PID=$!
          
          # Run the pipeline
          python ai_forex_brain_2.py
          
          # Kill the monitor script
          kill $MONITOR_PID 2>/dev/null || true
        continue-on-error: false
        timeout-minutes: 120

      # 8Ô∏è‚É£ Upload logs as artifacts
      - name: Upload pipeline logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: forex-pipeline-logs
          path: |
            forex-alpha-models/logs/*.log
            forex_pipeline.log
          retention-days: 7

      # 9Ô∏è‚É£ Upload generated pickles as artifacts
      - name: Upload generated pickles
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: forex-pickles
          path: |
            forex-alpha-models/merged_data_pickles/*.pkl
            forex-alpha-models/pickles/*.pkl
          retention-days: 3

      # üîü Upload signals JSON
      - name: Upload signals JSON
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: forex-signals
          path: |
            forex-alpha-models/forex-ai-models/broker_signals.json
            forex-alpha-models/forex-ai-models/ensemble_signals.json
            forex-alpha-models/forex-ai-models/latest_signals.json
          retention-days: 7

      # 1Ô∏è‚É£1Ô∏è‚É£ Commit and push results
      - name: Commit and push results
        if: success()
        env:
          GIT_AUTH_TOKEN: ${{ secrets.FOREX_PAT }}
        run: |
          cd forex-alpha-models/forex-ai-models || exit 0
          
          echo "üì¶ Adding changes to git..."
          git add -A
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚úÖ No changes to commit"
            exit 0
          fi
          
          # Commit changes
          git commit -m "ü§ñ Auto-update: AI Forex Brain Pipeline [$(date '+%Y-%m-%d %H:%M:%S')]" || echo "No changes to commit"
          
          # Set remote URL with token
          git remote set-url origin https://x-access-token:${GIT_AUTH_TOKEN}@github.com/${GITHUB_USERNAME}/${GITHUB_REPO}.git
          
          # Pull latest changes to avoid conflicts
          git pull --rebase origin main || echo "Nothing to pull"
          
          # Push changes
          git push origin main && echo "‚úÖ Changes pushed successfully" || echo "‚ö†Ô∏è Push failed or no changes to push"

      # 1Ô∏è‚É£2Ô∏è‚É£ Cleanup sensitive files
      - name: Cleanup sensitive data
        if: always()
        run: |
          rm -f ~/.git-credentials
          echo "‚úÖ Cleaned up sensitive files"

      # 1Ô∏è‚É£3Ô∏è‚É£ Summary report
      - name: Pipeline Summary
        if: always()
        run: |
          echo "================================================"
          echo "üéØ AI FOREX BRAIN PIPELINE SUMMARY"
          echo "================================================"
          echo "üìÖ Run Date: $(date)"
          echo "üîß Python Version: $(python --version)"
          echo "üìä Working Directory: $(pwd)"
          echo "================================================"
          
          if [ -f "forex_pipeline.log" ]; then
            echo "üìù Last 20 log entries:"
            tail -n 20 forex_pipeline.log
          fi
          
          echo "================================================"
          echo "‚úÖ Pipeline execution completed"
          echo "================================================"
