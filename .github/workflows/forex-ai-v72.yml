name: Forex AI Pipeline v7.2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-train-test:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jupyter nbconvert pandas numpy matplotlib scikit-learn yfinance ta requests tensorflow joblib

      - name: Verify key files exist
        run: |
          echo "Checking for required files..."
          for f in AI_Forex_Brain_2.ipynb forex_pairs.csv .github/workflows/forex-ai-v72.yml; do
            if [ ! -f "$f" ]; then
              echo "Missing file: $f"
              exit 1
            else
              echo "Found: $f"
            fi
          done

      - name: Display repo structure
        run: |
          echo "Repository structure:"
          ls -R | head -n 50

      - name: Convert notebook to Python script
        run: |
          jupyter nbconvert --to script AI_Forex_Brain_2.ipynb
          echo "Notebook successfully converted to .py file"
          ls -la AI_Forex_Brain_2.py

      - name: Check Python syntax
        run: |
          python3 -m py_compile AI_Forex_Brain_2.py
          echo "Python syntax check passed"

      - name: Run Forex AI Training Pipeline
        run: |
          echo "Starting Forex AI Training Pipeline..."
          python3 AI_Forex_Brain_2.py || exit 1
          echo "Training completed successfully!"

      - name: Save trained models and outputs
        run: |
          mkdir -p output
          cp -r *.pkl *.csv *.png *.json 2>/dev/null || true
          mv *.pkl *.csv *.png *.json output/ 2>/dev/null || true
          echo "Contents of output folder:"
          ls -la output || echo "No output generated."

      - name: Upload output artifacts
        uses: actions/upload-artifact@v4
        with:
          name: forex-ai-v72-output
          path: output/

      - name: Run post-training analysis
        run: |
          python3 scripts/post_analysis.py

      - name: Check notebook JSON
        run: |
          python3 scripts/check_notebook.py

      - name: Display completion summary
        run: |
          echo "Forex AI Pipeline v7.2 completed successfully!"
          echo "Timestamp: $(date)"
          echo "Runner: ${{ runner.name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
