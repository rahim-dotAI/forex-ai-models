name: Run Ultimate Forex AI v7.2

on:
  push:
    branches:
      - main
    paths:
      - 'trigger.txt'
      - 'merged_data_pickles/**'
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:

jobs:
  run-forex-ai:
    runs-on: ubuntu-latest
    timeout-minutes: 55
    env:
      FOREX_PAT: ${{ secrets.FOREX_PAT }}
      BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
      ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
      GIT_USER_NAME: "Rahim AI Bot"
      GIT_USER_EMAIL: "nakatonabira3@gmail.com"
      GITHUB_USERNAME: "rahim-dotAI"
      GITHUB_REPO: "forex-ai-models"
      PYTHONIOENCODING: utf-8

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Check trigger source
      - name: Identify trigger source
        run: |
          if [ -f "trigger.txt" ]; then
            echo "üéØ Triggered by: Colab data upload"
            cat trigger.txt
          else
            echo "üéØ Triggered by: Schedule or manual"
          fi

      # 3Ô∏è‚É£ Verify required secrets
      - name: Check required secrets
        run: |
          if [ -z "${FOREX_PAT}" ]; then
            echo "‚ùå FOREX_PAT secret is missing!"
            exit 1
          fi
          if [ -z "${BROWSERLESS_TOKEN}" ]; then
            echo "‚ö†Ô∏è BROWSERLESS_TOKEN secret is missing."
          fi
          echo "‚úÖ Required secrets verified"

      # 4Ô∏è‚É£ System update
      - name: System update
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y sqlite3
          echo "‚úÖ System setup complete"

      # 5Ô∏è‚É£ Set up Python 3.10 (compatible with all packages)
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: 'pip'

      # 6Ô∏è‚É£ Install Python dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install \
            numpy==1.24.3 \
            pandas==2.0.3 \
            scipy==1.11.1 \
            scikit-learn==1.3.0 \
            requests==2.31.0 \
            joblib==1.3.2 \
            python-dotenv==1.0.0 \
            ta==0.11.0 \
            yfinance==0.2.28 \
            beautifulsoup4==4.12.2 \
            jupyter \
            nbconvert \
            ipykernel
          echo "‚úÖ Dependencies installed"

      # 7Ô∏è‚É£ Create directory structure
      - name: Create directory structure
        run: |
          mkdir -p merged_data_pickles forex-ai-models csvs pickles logs
          echo "‚úÖ Directory structure created"

      # 8Ô∏è‚É£ Verify Jupyter notebook exists
      - name: Check for Jupyter notebook
        run: |
          if [ ! -f "AI_Forex_Brain_2.ipynb" ]; then
            echo "‚ùå AI_Forex_Brain_2.ipynb not found!"
            echo "Available files:"
            ls -la *.ipynb 2>/dev/null || echo "No .ipynb files found"
            exit 1
          fi
          echo "‚úÖ Jupyter notebook found"

          # Validate notebook JSON safely
          if ! python3 -c "import json; json.load(open('AI_Forex_Brain_2.ipynb'))" >/dev/null 2>&1; then
            echo "‚ùå Notebook JSON is corrupted!"
            exit 1
          else
            echo "‚úÖ Notebook JSON is valid"
          fi

      # 9Ô∏è‚É£ Verify data pickles exist
      - name: Check for data pickles
        run: |
          echo "üì¶ Checking for pickle files..."
          PICKLE_COUNT=$(find merged_data_pickles -name "*_2244.pkl" 2>/dev/null | wc -l)
          echo "Found $PICKLE_COUNT pickle files"
          if [ "$PICKLE_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è WARNING: No pickle files found!"
            echo "The script may need to generate data first."
          else
            echo "‚úÖ Data pickles available:"
            ls -lh merged_data_pickles/*_2244.pkl 2>/dev/null | head -10
          fi

      # üîü Restore cached state files
      - name: Restore cached AI state
        uses: actions/cache@v3
        with:
          path: |
            forex-ai-models/*.pkl
            forex-ai-models/*.db
            forex-ai-models/*.json
          key: forex-ai-state-${{ github.sha }}
          restore-keys: |
            forex-ai-state-

      # 1Ô∏è‚É£1Ô∏è‚É£ Execute Forex AI Jupyter Notebook
      - name: Execute Forex AI v7.3 Notebook
        timeout-minutes: 50
        run: |
          echo "üöÄ Starting Ultimate Hybrid Forex Pipeline v7.3..."
          echo "üìÖ Current Day: $(date +%A)"
          echo "üïê Current Time: $(date '+%Y-%m-%d %H:%M:%S')"

          jupyter nbconvert --to notebook --execute AI_Forex_Brain_2.ipynb \
            --ExecutePreprocessor.timeout=3000 \
            --output AI_Forex_Brain_2_executed.ipynb \
            --stdout 2>&1 | tee execution.log || {
            echo "‚ùå Notebook execution failed"
            echo "Last 100 lines of output:"
            tail -100 execution.log
            if [ -f "AI_Forex_Brain_2_executed.ipynb" ]; then
              echo "Checking executed notebook for errors..."
              python3 - <<'EOF'
import json
try:
    with open('AI_Forex_Brain_2_executed.ipynb', 'r') as f:
        nb = json.load(f)
    for cell in nb.get('cells', []):
        for output in cell.get('outputs', []):
            if output.get('output_type') == 'error':
                print('Error found:', output.get('ename'), output.get('evalue'))
                print('Traceback:', '\n'.join(output.get('traceback', [])))
except Exception as e:
    print(f'Could not parse notebook: {e}')
EOF
            fi
            exit 1
          }

          echo "‚úÖ Notebook execution completed successfully"

      # 1Ô∏è‚É£2Ô∏è‚É£ Check generated outputs
      - name: Verify outputs
        run: |
          echo "üìä Checking generated files..."

          if [ -d "forex-ai-models" ]; then
            echo "‚úÖ forex-ai-models directory exists"
            ls -lh forex-ai-models/ || echo "Directory is empty"
          fi

          if [ -f "forex-ai-models/broker_signals.json" ]; then
            echo "‚úÖ Broker signals generated"
            head -20 forex-ai-models/broker_signals.json
          fi

          if [ -f "forex-ai-models/latest_signals.json" ]; then
            echo "‚úÖ Latest signals generated"
            head -20 forex-ai-models/latest_signals.json
          fi

          if [ -f "forex-ai-models/infinite_memory.db" ]; then
            echo "‚úÖ Memory database exists"
            sqlite3 forex-ai-models/infinite_memory.db "SELECT COUNT(*) as total_signals FROM signals_history;" 2>/dev/null || echo "No records yet"
          fi

          if [ -f "forex_pipeline.log" ]; then
            echo "‚úÖ Pipeline log exists"
            echo "Last 30 lines:"
            tail -30 forex_pipeline.log
          fi

      # 1Ô∏è‚É£3Ô∏è‚É£ Upload execution logs
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: forex-ai-logs-${{ github.run_number }}
          path: |
            forex_pipeline.log
            execution.log
            AI_Forex_Brain_2_executed.ipynb
            forex-ai-models/*.json
            forex-ai-models/*.csv
            logs/*.log
          retention-days: 7
          if-no-files-found: warn

      # 1Ô∏è‚É£4Ô∏è‚É£ Upload AI state files
      - name: Upload AI state
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: forex-ai-state-${{ github.run_number }}
          path: |
            forex-ai-models/*.pkl
            forex-ai-models/*.db
          retention-days: 30
          if-no-files-found: warn

      # 1Ô∏è‚É£5Ô∏è‚É£ Update trigger file
      - name: Update trigger file
        if: success()
        run: |
          echo "üìù Updating trigger file with completion status..."
          {
            echo "Last successful run: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "Status: ‚úÖ Completed"
            echo "Iteration: ${{ github.run_number }}"
            echo "Day: $(date +%A)"
          } > trigger.txt
          cat trigger.txt

      # 1Ô∏è‚É£6Ô∏è‚É£ Commit and push all changes
      - name: Commit and push changes
        if: success()
        env:
          GIT_AUTH_TOKEN: ${{ secrets.FOREX_PAT }}
        run: |
          echo "ü™£ Preparing to commit changes..."
          git config user.name "${GIT_USER_NAME}"
          git config user.email "${GIT_USER_EMAIL}"

          git add trigger.txt forex-ai-models/*.json forex-ai-models/*.pkl forex-ai-models/*.csv forex-ai-models/*.db forex_pipeline.log logs/ || true

          if git diff --staged --quiet; then
            echo "‚è≠Ô∏è No changes to commit"
          else
            echo "üìù Committing changes..."
            TRIGGER_SOURCE="Schedule"
            if [ -f "trigger.txt" ]; then
              TRIGGER_SOURCE="Colab Upload"
            fi
            git commit -m "ü§ñ v7.3 Auto-update [$TRIGGER_SOURCE]: $(date '+%Y-%m-%d %H:%M:%S')"
            git remote set-url origin https://x-access-token:${GIT_AUTH_TOKEN}@github.com/${{ github.repository }}.git
            git push origin main && echo "‚úÖ Changes pushed successfully" || echo "‚ö†Ô∏è Push failed"
          fi

      # 1Ô∏è‚É£7Ô∏è‚É£ Generate execution summary
      - name: Generate summary
        if: always()
        run: |
          echo "# üèÜ Forex AI v7.3 Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run #:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "**Day:** $(date +%A)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "trigger.txt" ]; then
            echo "## üéØ Trigger Info" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat trigger.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "forex-ai-models/broker_signals.json" ]; then
            echo "## üìä Latest Broker Signals" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            head -50 forex-ai-models/broker_signals.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "forex-ai-models/latest_signals.json" ]; then
            echo "## üì° Latest Signals" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            head -50 forex-ai-models/latest_signals.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "forex_pipeline.log" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## üìù Recent Log Entries" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -30 forex_pipeline.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      # 1Ô∏è‚É£8Ô∏è‚É£ Cleanup on failure
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "‚ùå Job failed, cleaning up..."
          {
            echo "Last run: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "Status: ‚ùå Failed"
            echo "Day: $(date +%A)"
          } > trigger.txt

          git config user.name "${GIT_USER_NAME}"
          git config user.email "${GIT_USER_EMAIL}"
          git add trigger.txt
          git commit -m "‚ùå v7.3 Run failed: $(date '+%Y-%m-%d %H:%M:%S')" || true
          git remote set-url origin https://x-access-token:${FOREX_PAT}@github.com/${{ github.repository }}.git
          git push origin main || true
