name: Run Ultimate Forex AI v7.2

on:
  push:
    branches:
      - main
    paths:
      - 'trigger.txt'  # Triggered when Colab updates this file
      - 'merged_data_pickles/**'  # Or when new data pickles are uploaded
  schedule:
    # Run every hour (changed from 25 minutes)
    - cron: '0 * * * *'
  workflow_dispatch:  # Manual trigger option

jobs:
  run-forex-ai:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      FOREX_PAT: ${{ secrets.FOREX_PAT }}
      BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
      GIT_USER_NAME: "Rahim AI Bot"
      GIT_USER_EMAIL: "nakatonabira3@gmail.com"
      GITHUB_USERNAME: "rahim-dotAI"
      GITHUB_REPO: "forex-ai-models"
      PYTHONIOENCODING: utf-8

    steps:
      # 0Ô∏è‚É£ Pre-clean any broken submodules
      - name: Remove broken submodules before checkout
        run: |
          echo "üßπ Cleaning any broken .gitmodules or nested repos..."
          rm -f .gitmodules || true
          rm -rf forex_ai_outputs/forex-ai-models || true
          rm -rf forex-alpha-models/forex-ai-models || true
          echo "‚úÖ Cleaned potential submodule conflicts"

      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
          lfs: false
          submodules: false
          clean: true
          set-safe-directory: true

      # 2Ô∏è‚É£ Check trigger source
      - name: Identify trigger source
        run: |
          if [ -f "trigger.txt" ]; then
            echo "üéØ Triggered by: Colab data upload"
            echo "üìÑ Trigger content:"
            cat trigger.txt
          else
            echo "üéØ Triggered by: Schedule or manual"
          fi

      # 3Ô∏è‚É£ Verify required secrets
      - name: Check required secrets
        run: |
          if [ -z "${FOREX_PAT}" ]; then
            echo "‚ùå FOREX_PAT secret is missing!"
            exit 1
          fi
          if [ -z "${BROWSERLESS_TOKEN}" ]; then
            echo "‚ö†Ô∏è BROWSERLESS_TOKEN secret is missing. Live prices may be limited."
          fi
          echo "‚úÖ Required secrets verified"

      # 3Ô∏è‚É£ System update & Git LFS setup
      - name: System update & Git LFS setup
        run: |
          sudo apt-get update -qq || echo "‚ö†Ô∏è Could not update apt, skipping"
          sudo apt-get install -y git-lfs sqlite3 || echo "‚ö†Ô∏è Package install warnings"
          git lfs install || echo "‚ö†Ô∏è Git LFS already initialized"
          git lfs track "*.csv" "*.pkl" "*.db" || echo "‚úÖ Already tracked"
          echo "‚úÖ System setup complete"

      # 4Ô∏è‚É£ Set up Python 3.11
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'

      # 5Ô∏è‚É£ Install Python dependencies (v7.2 requirements)
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install --upgrade \
            numpy==1.26.4 \
            pandas==2.2.0 \
            scipy==1.12.0 \
            scikit-learn==1.4.0 \
            requests==2.31.0 \
            joblib==1.3.2 \
            smtplib-ssl \
            python-dotenv \
            jupyter \
            nbconvert \
            ipykernel
          echo "‚úÖ Dependencies installed"

      # 6Ô∏è‚É£ Create /content symlink for Colab paths
      - name: Create /content symlink
        run: |
          sudo mkdir -p /content
          sudo ln -sf "$(pwd)" /content/forex-alpha-models
          echo "‚úÖ Symlink created: /content/forex-alpha-models -> $(pwd)"

      # 7Ô∏è‚É£ Create necessary directories
      - name: Create directory structure
        run: |
          mkdir -p merged_data_pickles
          mkdir -p forex-ai-models
          mkdir -p output
          echo "‚úÖ Directory structure created"

      # 8Ô∏è‚É£ Restore cached state files (models, databases, memories)
      - name: Restore cached AI state
        uses: actions/cache@v3
        with:
          path: |
            forex-ai-models/*.pkl
            forex-ai-models/*.db
            forex-ai-models/*.json
          key: forex-ai-state-${{ github.sha }}
          restore-keys: |
            forex-ai-state-

      # 9Ô∏è‚É£ Execute Ultimate Forex AI v7.2 Script
      - name: Execute Forex AI v7.2 Notebook
        timeout-minutes: 18
        run: |
          echo "üöÄ Starting Ultimate Hybrid Forex Pipeline v7.2..."
          echo "üìÖ Current Day: $(date +%A)"
          echo "üïê Current Time: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # Check if notebook exists and is valid
          if [ ! -f "AI_Forex_Brain_2.ipynb" ]; then
            echo "‚ùå Notebook file not found!"
            ls -la *.ipynb || echo "No .ipynb files in root"
            exit 1
          fi
          
          echo "üìì Validating notebook format..."
          python3 -c "import json; json.load(open('AI_Forex_Brain_2.ipynb'))" || {
            echo "‚ùå Notebook is not valid JSON. Attempting to fix..."
            python3 -c '
import json
import sys

try:
    with open("AI_Forex_Brain_2.ipynb", "r", encoding="utf-8") as f:
        content = f.read()
    
    nb = json.loads(content)
    
    with open("AI_Forex_Brain_2.ipynb", "w", encoding="utf-8") as f:
        json.dump(nb, f, indent=1, ensure_ascii=False)
    
    print("‚úÖ Notebook JSON fixed and reformatted")
except Exception as e:
    print(f"‚ùå Cannot fix notebook: {e}")
    sys.exit(1)
'
          }
          
          # Convert and run the Jupyter notebook
          jupyter nbconvert --to notebook --execute AI_Forex_Brain_2.ipynb \
            --ExecutePreprocessor.timeout=1000 \
            --output AI_Forex_Brain_2_executed.ipynb || {
            echo "‚ùå AI execution failed"
            cat AI_Forex_Brain_2_executed.ipynb 2>/dev/null | tail -50 || echo "No output notebook"
            exit 1
          }
          
          echo "‚úÖ AI execution completed successfully"

      # üîü Check generated outputs
      - name: Verify outputs
        run: |
          echo "üìä Checking generated files..."
          ls -lh forex-ai-models/ || echo "‚ö†Ô∏è No forex-ai-models directory"
          
          if [ -f "forex-ai-models/broker_signals.json" ]; then
            echo "‚úÖ Signal file generated"
            echo "Preview:"
            head -20 forex-ai-models/broker_signals.json
          else
            echo "‚ö†Ô∏è No signals generated yet"
          fi
          
          if [ -f "forex-ai-models/infinite_memory.db" ]; then
            echo "‚úÖ Memory database exists"
            sqlite3 forex-ai-models/infinite_memory.db "SELECT COUNT(*) FROM signals_history;" || echo "No records yet"
          fi

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload execution logs
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: forex-ai-logs-${{ github.run_number }}
          path: |
            forex_pipeline.log
            forex-ai-models/*.json
            forex-ai-models/*.csv
          retention-days: 7

      # 1Ô∏è‚É£2Ô∏è‚É£ Upload AI state files
      - name: Upload AI state
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: forex-ai-state-${{ github.run_number }}
          path: |
            forex-ai-models/*.pkl
            forex-ai-models/*.db
          retention-days: 30

      # 1Ô∏è‚É£3Ô∏è‚É£ Commit and push all changes
      - name: Commit and push changes
        if: success()
        env:
          GIT_AUTH_TOKEN: ${{ secrets.FOREX_PAT }}
        run: |
          echo "ü™£ Preparing to commit changes..."
          git config user.name "${GIT_USER_NAME}"
          git config user.email "${GIT_USER_EMAIL}"
          
          # Add all relevant files
          git add forex-ai-models/*.json || echo "No JSON files"
          git add forex-ai-models/*.pkl || echo "No PKL files"
          git add forex-ai-models/*.csv || echo "No CSV files"
          git add forex-ai-models/*.db || echo "No DB files"
          git add forex_pipeline.log || echo "No log file"
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "‚è≠Ô∏è No changes to commit"
          else
            echo "üìù Committing changes..."
            git commit -m "ü§ñ v7.2 Auto-update: $(date '+%Y-%m-%d %H:%M:%S') - Competition Round Complete"
            
            # Push with authentication
            git remote set-url origin https://x-access-token:${GIT_AUTH_TOKEN}@github.com/${{ github.repository }}.git
            git push origin main && echo "‚úÖ Changes pushed successfully" || echo "‚ö†Ô∏è Push failed"
          fi

      # 1Ô∏è‚É£4Ô∏è‚É£ Generate execution summary
      - name: Generate summary
        if: always()
        run: |
          echo "# üèÜ Forex AI v7.2 Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run #:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "**Day:** $(date +%A)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "forex-ai-models/broker_signals.json" ]; then
            echo "## üìä Latest Signals" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            head -50 forex-ai-models/broker_signals.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "forex_pipeline.log" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## üìù Recent Log Entries" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -30 forex_pipeline.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      # 1Ô∏è‚É£5Ô∏è‚É£ Cleanup on failure
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "‚ùå Job failed, cleaning up..."
          git reset --hard HEAD || true
          git clean -fd || true
