name: Forex AI Pipeline v72

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-train-test:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jupyter nbconvert pandas numpy matplotlib scikit-learn yfinance ta requests tensorflow joblib

      - name: Verify key files exist
        run: |
          echo "Checking for required files..."
          for f in AI_Forex_Brain_2.ipynb forex_pairs.csv .github/workflows/forex-ai-v72.yml; do
            if [ ! -f "$f" ]; then
              echo "Missing file: $f"
              exit 1
            else
              echo "Found: $f"
            fi
          done

      - name: Display repo structure
        run: |
          echo "Repository structure:"
          ls -R | head -n 50

      - name: Convert notebook to Python script
        run: |
          jupyter nbconvert --to script AI_Forex_Brain_2.ipynb
          echo "Notebook successfully converted to .py file"
          ls -la AI_Forex_Brain_2.py

      - name: Check Python syntax
        run: |
          python3 -m py_compile AI_Forex_Brain_2.py
          echo "Python syntax check passed"

      - name: Run Forex AI Training Pipeline
        run: |
          echo "Starting Forex AI Training Pipeline..."
          python3 AI_Forex_Brain_2.py || exit 1
          echo "Training completed successfully!"

      - name: Save trained models and outputs
        run: |
          mkdir -p output
          cp -r *.pkl *.csv *.png *.json 2>/dev/null || true
          mv *.pkl *.csv *.png *.json output/ 2>/dev/null || true
          echo "Contents of output folder:"
          ls -la output || echo "No output generated."

      - name: Upload output artifacts
        uses: actions/upload-artifact@v4
        with:
          name: forex-ai-v72-output
          path: output/

      - name: Run post-training analysis
        shell: bash
        run: |
          echo "Running basic model performance analysis..."
python3 - <<EOF
import os, glob

print("[SCAN] Checking for model files...")
pkl_files = glob.glob("output/*.pkl")
if pkl_files:
    print("[OK] Found", len(pkl_files), "trained model(s).")
else:
    print("[WARN] No .pkl models found in output/")

csv_files = glob.glob("output/*.csv")
if csv_files:
    print("[INFO] CSV result files detected:")
    for f in csv_files:
        try:
            lines = len(open(f).readlines())
            print("-", f, f"({lines} lines)")
        except Exception as e:
            print("Error reading", f, ":", e)
else:
    print("[WARN] No CSV outputs detected.")
EOF

      - name: Check for Jupyter notebook
        shell: bash
        run: |
          if [ ! -f "AI_Forex_Brain_2.ipynb" ]; then
            echo "AI_Forex_Brain_2.ipynb not found!"
            echo "Available files:"
            ls -la *.ipynb 2>/dev/null || echo "No .ipynb files found"
            exit 1
          fi
          echo "Jupyter notebook found"

python3 - <<EOF
import json, sys
try:
    json.load(open("AI_Forex_Brain_2.ipynb"))
    print("[OK] Notebook JSON is valid")
except Exception as e:
    print("[ERROR] Notebook JSON is corrupted!", e)
    sys.exit(1)
EOF

      - name: Display completion summary
        run: |
          echo "Forex AI Pipeline v7.2 completed successfully!"
          echo "Timestamp: $(date)"
          echo "Runner: ${{ runner.name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
