name: Forex AI Pipeline v7.2 ğŸ§ ğŸ’¹

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-train-test:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: 3.10

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jupyter nbconvert pandas numpy matplotlib scikit-learn yfinance ta requests tensorflow joblib

      - name: Verify key files exist
        run: |
          echo "ğŸ” Checking for required files..."
          for f in "AI_Forex_Brain_2.ipynb" "forex_pairs.csv" ".github/workflows/forex-ai-v72.yml"; do
            if [ ! -f "$f" ]; then
              echo "âŒ Missing file: $f"
              exit 1
            else
              echo "âœ… Found: $f"
            fi
          done

      - name: Display repo structure
        run: |
          echo "ğŸ“‚ Repository structure:"
          ls -R | head -n 50

      - name: Convert notebook to Python script
        run: |
          jupyter nbconvert --to script AI_Forex_Brain_2.ipynb
          echo "âœ… Notebook successfully converted to .py file"
          ls -la AI_Forex_Brain_2.py

      - name: Check Python syntax
        run: |
          python3 -m py_compile AI_Forex_Brain_2.py
          echo "âœ… Python syntax check passed"

      - name: Run Forex AI Training Pipeline
        run: |
          echo "ğŸš€ Starting Forex AI Training Pipeline..."
          python3 AI_Forex_Brain_2.py || exit 1
          echo "âœ… Training completed successfully!"

      - name: Save trained models and outputs
        run: |
          mkdir -p output
          cp -r *.pkl *.csv *.png *.json 2>/dev/null || true
          mv *.pkl *.csv *.png *.json output/ 2>/dev/null || true
          echo "ğŸ“¦ Contents of output folder:"
          ls -la output || echo "âš ï¸ No output generated."

      - name: Upload output artifacts
        uses: actions/upload-artifact@v4
        with:
          name: forex-ai-v72-output
          path: output/

      - name: Run post-training analysis
        run: |
          echo "ğŸ“ˆ Running basic model performance analysis..."
          python3 - <<'EOF'
import os, glob, pandas as pd
print("ğŸ§® Scanning for model files...")
pkl_files = glob.glob("output/*.pkl")
if not pkl_files:
    print("âš ï¸ No .pkl models found in output/")
else:
    print("âœ… Found", len(pkl_files), "trained model(s).")
csv_files = glob.glob("output/*.csv")
if csv_files:
    print("ğŸ“Š CSV result files detected:")
    for f in csv_files:
        print("-", f, "(", len(open(f).readlines()), "lines )")
else:
    print("âš ï¸ No CSV outputs detected.")
EOF

      - name: Check for Jupyter notebook
        run: |
          if [ ! -f "AI_Forex_Brain_2.ipynb" ]; then
            echo "âŒ AI_Forex_Brain_2.ipynb not found!"
            echo "Available files:"
            ls -la *.ipynb 2>/dev/null || echo "No .ipynb files found"
            exit 1
          fi
          echo "âœ… Jupyter notebook found"

          # Validate notebook JSON safely (YAML-compliant)
          python3 - <<'EOF'
import json, sys
try:
    json.load(open("AI_Forex_Brain_2.ipynb"))
    print("âœ… Notebook JSON is valid")
except Exception as e:
    print("âŒ Notebook JSON is corrupted!", e)
    sys.exit(1)
EOF

      - name: Display completion summary
        run: |
          echo "ğŸ¯ Forex AI Pipeline v7.2 completed successfully!"
          echo "Timestamp: $(date)"
          echo "Runner: ${{ runner.name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
