name: Smart Forex Brain Pipeline v18.0

on:
  workflow_dispatch:
  push:
    paths: ['colab_trigger.txt']
    branches: [main]
  schedule:
    - cron: '0 */2 * * 1-5'    # Weekdays: Every 2 hours
    - cron: '*/30 * * * 0,6'   # Weekends: Every 30 minutes

jobs:
  run-forex-brain:
    runs-on: ubuntu-latest
    timeout-minutes: 55

    env:
      FOREX_PAT: ${{ secrets.FOREX_PAT }}
      BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
      ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      PYTHONIOENCODING: utf-8
      PYTHONUNBUFFERED: 1
      GITHUB_ACTIONS: "true"
      SINGLE_RUN_MODE: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
          token: ${{ secrets.FOREX_PAT }}

      - name: Fix Submodules
        run: |
          [ -f ".gitmodules" ] && rm -f .gitmodules && git rm --cached -r forex-alpha-models 2>/dev/null || true
          find . -mindepth 2 -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true

      - name: Detect Day Type
        id: day_info
        run: |
          DAY=$(date +%u)
          DAY_NAME=$(date +'%A')
          echo "day=$DAY" >> $GITHUB_OUTPUT
          echo "day_name=$DAY_NAME" >> $GITHUB_OUTPUT
          
          if [ $DAY -eq 6 ] || [ $DAY -eq 7 ]; then
            echo "is_weekend=true" >> $GITHUB_OUTPUT
            echo "ğŸ“… $DAY_NAME (Weekend)"
          else
            echo "is_weekend=false" >> $GITHUB_OUTPUT
            echo "ğŸ“… $DAY_NAME (Weekday)"
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install Dependencies
        run: |
          pip install -q --no-cache-dir pandas numpy requests beautifulsoup4 scikit-learn \
            jupyter nbconvert nbformat ta yfinance mplfinance firebase-admin dropbox \
            pyppeteer nest_asyncio lightgbm joblib matplotlib alpha_vantage tqdm river scipy

      - name: Configure Git
        run: |
          git config --global user.name "Forex AI Bot"
          git config --global user.email "nakatonabira3@gmail.com"
          echo "https://${{ github.actor }}:${{ secrets.FOREX_PAT }}@github.com" > ~/.git-credentials
          git config --global credential.helper store

      - name: Check Data Status
        id: data
        run: |
          echo "ğŸ“Š Checking existing data files..."
          
          # Count pickle files
          PICKLE_COUNT=$(find data/processed -name "*.pkl" -type f ! -name "*_model.pkl" 2>/dev/null | wc -l)
          echo "pickle_count=$PICKLE_COUNT" >> $GITHUB_OUTPUT
          
          # Run counter
          [ -f ".github/run_history/run_counter.txt" ] && RUN_NUM=$(cat .github/run_history/run_counter.txt) || RUN_NUM=0
          RUN_NUM=$((RUN_NUM + 1))
          echo $RUN_NUM > .github/run_history/run_counter.txt
          echo "run_number=$RUN_NUM" >> $GITHUB_OUTPUT
          
          # Email report check (every 10 runs)
          [ $((RUN_NUM % 10)) -eq 0 ] && echo "send_report=true" >> $GITHUB_OUTPUT || echo "send_report=false" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Status:"
          echo "   Pickle files: $PICKLE_COUNT"
          echo "   Run number: $RUN_NUM"
          
          mkdir -p data/processed database .github/run_history

      - name: Verify Notebook
        run: |
          if [ ! -f "AI_Forex_Brain_2.ipynb" ]; then
            echo "âŒ ERROR: AI_Forex_Brain_2.ipynb not found!"
            ls -la *.ipynb 2>/dev/null || echo "No .ipynb files found"
            exit 1
          fi
          
          echo "âœ… Found AI_Forex_Brain_2.ipynb"
          
          # Check notebook size and structure
          CELLS=$(python -c "
          import nbformat
          with open('AI_Forex_Brain_2.ipynb', 'r') as f:
              nb = nbformat.read(f, 4)
          code_cells = sum(1 for c in nb.cells if c.cell_type=='code')
          print(code_cells)
          " 2>/dev/null || echo "0")
          
          echo "ğŸ“Š Code cells found: $CELLS"

      - name: Create Full Notebook Executor
        run: |
          cat > run_full.py << 'EOF'
          import nbformat, sys, time, json, os, re
          from nbconvert.preprocessors import ExecutePreprocessor
          from datetime import datetime
          
          class VerboseExecutor(ExecutePreprocessor):
              def __init__(self, *args, **kwargs):
                  super().__init__(*args, **kwargs)
                  self.cell_count = 0
                  self.start_time = None
                  self.successful_cells = 0
                  self.failed_cells = 0
              
              def preprocess(self, nb, resources=None, km=None):
                  code_cells = sum(1 for c in nb.cells if c.cell_type=='code')
                  print(f"ğŸ“Š Processing {len(nb.cells)} cells ({code_cells} code cells)...")
                  self.start_time = time.time()
                  return super().preprocess(nb, resources, km)
              
              def preprocess_cell(self, cell, resources, idx):
                  if cell.cell_type != 'code':
                      return cell, resources
                  
                  self.cell_count += 1
                  
                  # Show progress every cell
                  elapsed = time.time() - self.start_time
                  print(f"\n{'â”€'*70}")
                  print(f"â³ Cell {self.cell_count} ({elapsed:.0f}s elapsed)")
                  print(f"{'â”€'*70}")
                  
                  try:
                      cell, resources = super().preprocess_cell(cell, resources, idx)
                      self.successful_cells += 1
                      
                      # Show key outputs from each cell
                      if cell.outputs:
                          for output in cell.outputs:
                              if output.output_type == 'stream':
                                  text = re.sub(r'\x1b\[[0-9;]*m', '', output.text)
                                  lines = text.strip().split('\n')
                                  
                                  # Show lines with important markers
                                  important_lines = [l for l in lines if any(marker in l for marker in 
                                      ['âœ…', 'âš ï¸', 'âŒ', 'ğŸ’°', 'ğŸ§ ', 'ğŸ’¾', 'ğŸ“Š', 'COMPLETE', 'ERROR', 
                                       'Win Rate', 'P&L', 'Iteration', 'Mode:', 'Total', 'Average'])]
                                  
                                  if important_lines:
                                      for line in important_lines[:10]:
                                          print(f"  {line}")
                              
                              elif output.output_type == 'error':
                                  print(f"  âŒ Error: {output.ename}: {output.evalue}")
                  
                  except Exception as e:
                      self.failed_cells += 1
                      print(f"  âš ï¸ Cell {self.cell_count} had errors: {str(e)[:200]}")
                      print(f"  ğŸ”„ Continuing to next cell...")
                  
                  return cell, resources
          
          if not os.path.exists('AI_Forex_Brain_2.ipynb'):
              print("âŒ ERROR: AI_Forex_Brain_2.ipynb not found!")
              sys.exit(1)
          
          with open('AI_Forex_Brain_2.ipynb', 'r') as f:
              nb = nbformat.read(f, as_version=4)
          
          print("="*70)
          print("ğŸš€ STARTING FULL NOTEBOOK EXECUTION")
          print("="*70)
          
          ep = VerboseExecutor(timeout=2400, kernel_name='python3', allow_errors=True)
          start = time.time()
          
          try:
              ep.preprocess(nb, {'metadata': {'path': '.'}})
              duration = time.time() - start
              
              print(f"\n{'='*70}")
              print(f"âœ… EXECUTION COMPLETED")
              print(f"{'='*70}")
              print(f"Total code cells: {ep.cell_count}")
              print(f"Successful: {ep.successful_cells}")
              print(f"Failed: {ep.failed_cells}")
              print(f"Duration: {duration:.1f}s")
              print(f"{'='*70}\n")
              
              report = {
                  'timestamp': datetime.now().isoformat(), 
                  'mode': 'full', 
                  'duration': duration,
                  'cells_executed': ep.cell_count,
                  'successful': ep.successful_cells,
                  'failed': ep.failed_cells,
                  'status': 'success'
              }
              
          except Exception as e:
              duration = time.time() - start
              
              print(f"\n{'='*70}")
              print(f"âš ï¸ EXECUTION COMPLETED WITH ERRORS")
              print(f"{'='*70}")
              print(f"Error: {type(e).__name__}: {str(e)[:200]}")
              print(f"Duration: {duration:.1f}s")
              print(f"Successful cells: {ep.successful_cells}")
              print(f"Failed cells: {ep.failed_cells}")
              print(f"{'='*70}\n")
              
              report = {
                  'timestamp': datetime.now().isoformat(), 
                  'mode': 'full', 
                  'duration': duration,
                  'cells_executed': ep.cell_count,
                  'successful': ep.successful_cells,
                  'failed': ep.failed_cells,
                  'status': 'completed_with_errors',
                  'error': f"{type(e).__name__}: {str(e)[:200]}"
              }
          
          os.makedirs('.github/run_history', exist_ok=True)
          with open('.github/run_history/latest_run.json', 'w') as f: 
              json.dump(report, f, indent=2)
          
          print("âœ… Full notebook execution completed")
          EOF

      - name: Run Full Notebook
        run: |
          echo "ğŸš€ Running full notebook execution..."
          echo "ğŸ“… Day: ${{ steps.day_info.outputs.day_name }}"
          echo "ğŸ”¢ Run: #${{ steps.data.outputs.run_number }}"
          echo "ğŸ““ Notebook: AI_Forex_Brain_2.ipynb"
          echo ""
          echo "â„¹ï¸  This will execute ALL cells in the notebook sequentially"
          echo "â„¹ï¸  Estimated time: 30-50 minutes"
          echo ""
          python run_full.py
        timeout-minutes: 50

      - name: Generate Email Report
        if: steps.data.outputs.send_report == 'true'
        run: |
          cat > report.py << 'EOF'
          import json, os
          from glob import glob
          from datetime import datetime
          
          runs = sorted(glob('.github/run_history/archive/run_*.json'))[-10:]
          if not runs:
              print("No runs to report")
              exit(0)
          
          data = [json.load(open(f)) for f in runs]
          success = sum(1 for r in data if r.get('status') == 'success')
          avg = sum(r.get('duration', 0) for r in data) / len(data)
          
          html = f"""<!DOCTYPE html>
          <html><head><style>
          body{{font-family:Arial;padding:20px;background:#f5f5f5}}
          .container{{max-width:800px;margin:0 auto;background:#fff;padding:30px;border-radius:10px}}
          h1{{color:#2c3e50;border-bottom:3px solid #3498db}}
          .stats{{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:20px 0}}
          .stat{{background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;border-radius:8px;color:#fff}}
          .stat h3{{margin:0;font-size:14px}}
          .stat .val{{font-size:32px;font-weight:bold}}
          </style></head><body><div class="container">
          <h1>ğŸ¤– Forex AI - 10 Run Report</h1>
          <div class="stats">
          <div class="stat"><h3>âœ… Success</h3><p class="val">{success}/{len(data)}</p></div>
          <div class="stat"><h3>â±ï¸ Avg Time</h3><p class="val">{avg:.0f}s</p></div>
          </div></div></body></html>"""
          
          with open('report.html', 'w') as f: f.write(html)
          EOF
          python report.py

      - name: Send Email
        if: steps.data.outputs.send_report == 'true'
        run: |
          cat > email.py << 'EOF'
          import smtplib, os
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from datetime import datetime
          
          sender = os.getenv('GMAIL_USER')
          password = os.getenv('GMAIL_APP_PASSWORD')
          if not sender or not password: exit(0)
          
          with open('report.html') as f: html = f.read()
          msg = MIMEMultipart('alternative')
          msg['Subject'] = f'ğŸ¤– Forex AI Report - {datetime.now().strftime("%Y-%m-%d")}'
          msg['From'] = msg['To'] = sender
          msg.attach(MIMEText(html, 'html'))
          
          try:
              s = smtplib.SMTP('smtp.gmail.com', 587)
              s.starttls()
              s.login(sender, password)
              s.send_message(msg)
              s.quit()
              print("âœ… Email sent")
          except Exception as e:
              print(f"âš ï¸ Email failed: {e}")
          EOF
          python email.py || true

      - name: Extract Metrics
        if: always()
        run: |
          [ ! -f "database/memory_v85.db" ] && echo '{"status":"no_db"}' > .github/run_history/metrics.json && exit 0
          python << 'EOF'
          import sqlite3, json, os
          try:
              conn = sqlite3.connect('database/memory_v85.db')
              c = conn.cursor()
              c.execute("SELECT name FROM sqlite_master WHERE type='table'")
              tables = [r[0] for r in c.fetchall()]
              
              metrics = {}
              if 'completed_trades' in tables:
                  c.execute("SELECT COUNT(*) FROM completed_trades")
                  metrics['trades'] = c.fetchone()[0]
              
              with open('.github/run_history/metrics.json', 'w') as f:
                  json.dump(metrics, f)
          except Exception as e:
              with open('.github/run_history/metrics.json', 'w') as f:
                  json.dump({'error': str(e)}, f)
          EOF

      - name: Commit Data Files
        if: success()
        run: |
          git add -f data/processed/*.pkl database/*.db rl_memory/* rl_models/* omega_state/* .github/run_history/* 2>/dev/null || true
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No changes"
          else
            RUN="${{ steps.data.outputs.run_number }}"
            IS_WEEKEND="${{ steps.day_info.outputs.is_weekend }}"
            TIME="$(date +'%Y-%m-%d %H:%M UTC')"
            
            if [ "$IS_WEEKEND" = "true" ]; then
              MSG="ğŸ–ï¸ Weekend Run"
            else
              MSG="ğŸ”´ Trading Day"
            fi
            
            git commit -m "${MSG} #${RUN} - ${TIME}" || true
            
            for i in {1..3}; do
              git push origin main && break || { 
                [ $i -lt 3 ] && sleep 3 && git pull --rebase origin main || exit 1
              }
            done
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_number }}
          path: |
            .github/run_history/*.json
            report.html
          retention-days: 7
          if-no-files-found: ignore

      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "ğŸ“Š Forex Brain Pipeline - Run #${{ steps.data.outputs.run_number }}"
          echo "ğŸ“… Day: ${{ steps.day_info.outputs.day_name }}"
          echo "â° Time: $(date +'%Y-%m-%d %H:%M UTC')"
          echo "ğŸ“‚ Pickle files: ${{ steps.data.outputs.pickle_count }}"
          [ "${{ steps.data.outputs.send_report }}" = "true" ] && echo "ğŸ“§ Report: SENT" || echo "ğŸ“§ Report: Pending"
          echo "âœ… Execution complete"
          echo "=========================================="
