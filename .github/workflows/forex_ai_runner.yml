name: AI Forex Brain Auto Executor

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * 1-5"

jobs:
  run_notebook:
    runs-on: ubuntu-latest

    env:
      GIT_USER_EMAIL: nakatonabira3@gmail.com
      GIT_USER_NAME: "Abdul Rahim"
      FOREX_PAT: ${{ secrets.FOREX_PAT }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # disable GITHUB_TOKEN default

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install papermill notebook pandas numpy yfinance matplotlib ta seaborn tqdm scikit-learn joblib

      - name: Create Colab /content Path Symlink
        run: |
          echo "ğŸ”— Creating Colab-style /content path..."
          sudo mkdir -p /content
          sudo chmod 777 /content
          ln -s "$(pwd)" /content || true

      - name: Execute Notebook
        run: |
          mkdir -p output
          echo "ğŸš€ Running AI_Forex_Brain 2.ipynb..."
          papermill "AI_Forex_Brain 2.ipynb" "output/AI_Forex_Brain_Executed.ipynb" -k python3

      - name: Upload Executed Notebook
        uses: actions/upload-artifact@v4
        with:
          name: executed-notebook
          path: output/AI_Forex_Brain_Executed.ipynb

      - name: Commit and Push Results
        if: success() || failure()
        run: |
          echo "ğŸ“ Setting up Git user..."
          git config --global user.name "${GIT_USER_NAME}"
          git config --global user.email "${GIT_USER_EMAIL}"

          echo "ğŸ§© Adding updated files..."
          git add -A || true
          git commit -m "ğŸ“ˆ Auto-run update at $(date)" || echo "No changes to commit"

          echo "ğŸš€ Pushing to repo using personal token..."
          git push https://${{ secrets.FOREX_PAT }}@github.com/rahim-dotAI/forex-ai-models.git main || echo "âŒ Push failed, will retry next run"
