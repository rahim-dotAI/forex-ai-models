name: üîÅ Auto Notebook Runner

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"  # every day at midnight UTC

jobs:
  run-notebook:
    runs-on: ubuntu-latest
    env:
      GIT_USER_NAME: "Rahim AI Bot"
      GIT_USER_EMAIL: "nakatonabira3@gmail.com"
      GIT_AUTH_TOKEN: ${{ secrets.FOREX_PAT }}

    steps:
      # -----------------------------
      # 1Ô∏è‚É£ Checkout repo without bot credentials
      # -----------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      # -----------------------------
      # 2Ô∏è‚É£ Setup Python
      # -----------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # -----------------------------
      # 3Ô∏è‚É£ Install dependencies
      # -----------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jupyter nbconvert nbformat pandas numpy yfinance matplotlib ta gitpython

      # -----------------------------
      # 4Ô∏è‚É£ Run notebook with retries
      # -----------------------------
      - name: Run notebook
        run: |
          set -e
          MAX_RETRIES=3
          COUNT=1
          INPUT_NOTEBOOK="AI_Forex_Brain.ipynb"
          OUTPUT_NOTEBOOK="output/AI_Forex_Brain_executed.ipynb"
          mkdir -p output

          while [ $COUNT -le $MAX_RETRIES ]; do
            echo "üöÄ Attempt $COUNT to execute notebook..."
            if jupyter nbconvert --to notebook --execute "$INPUT_NOTEBOOK" --output "$OUTPUT_NOTEBOOK"; then
              echo "‚úÖ Notebook executed successfully!"
              break
            else
              echo "‚ùå Failed on attempt $COUNT"
              COUNT=$((COUNT + 1))
              sleep 5
            fi
          done

      # -----------------------------
      # 5Ô∏è‚É£ Git LFS setup & force PAT remote
      # -----------------------------
      - name: Configure Git + LFS
        run: |
          git lfs install --skip-smudge
          git config --global user.name "${GIT_USER_NAME}"
          git config --global user.email "${GIT_USER_EMAIL}"
          
          # Force use of PAT-authenticated remote instead of GitHub Actions bot
          git remote set-url origin https://x-access-token:${GIT_AUTH_TOKEN}@github.com/rahim-dotAI/forex-ai-models.git

          # Track large files
          git lfs track "*.csv"
          git lfs track "*.pkl"
          git add .gitattributes

      # -----------------------------
      # 6Ô∏è‚É£ Commit and push changes
      # -----------------------------
      - name: Commit and Push Outputs
        run: |
          echo "ü™£ Adding output changes..."
          git add output/*.ipynb || true
          git add *.csv *.pkl || true
          git add .gitattributes || true

          echo "üí¨ Checking for differences..."
          if git diff --cached --quiet; then
            echo "‚úÖ No new changes to commit."
          else
            git commit -m "ü§ñ Auto-update: executed AI_Forex_Brain notebook [$(date -u)]"
            echo "üì§ Pushing with PAT..."
            git push origin main
            echo "‚úÖ Push complete!"
          fi

      # -----------------------------
      # 7Ô∏è‚É£ Upload executed notebook
      # -----------------------------
      - name: Upload notebook as artifact
        uses: actions/upload-artifact@v4
        with:
          name: executed-notebook
          path: output/AI_Forex_Brain_executed.ipynb
