name: AI Forex Brain Auto Executor

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * 1-5"  # Run every weekday at 08:00 AM Uganda time (UTC+3 ‚Üí 05:00 UTC)

jobs:
  run_notebook:
    runs-on: ubuntu-latest

    env:
      GIT_USER_EMAIL: nakatonabira3@gmail.com
      FOREX_PAT: ${{ secrets.FOREX_PAT }}
      BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}

    steps:
      # --------------------------
      # 1Ô∏è‚É£ Checkout Repo
      # --------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --------------------------
      # 2Ô∏è‚É£ Set Up Python
      # --------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --------------------------
      # 3Ô∏è‚É£ Install Dependencies
      # --------------------------
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install papermill notebook pandas numpy yfinance matplotlib ta seaborn tqdm scikit-learn joblib

      # --------------------------
      # 4Ô∏è‚É£ Colab-like /content Path Fix
      # --------------------------
      - name: Create Colab /content Path Symlink
        run: |
          echo "üîó Creating Colab-style /content path..."
          sudo mkdir -p /content
          sudo chmod 777 /content
          ln -s "$(pwd)" /content || true
          echo "‚úÖ Symlink created: /content ‚Üí $(pwd)"

      # --------------------------
      # 5Ô∏è‚É£ Run Notebook with Papermill
      # --------------------------
      - name: Execute AI Forex Brain Notebook
        run: |
          mkdir -p output
          echo "üöÄ Running AI_Forex_Brain 2.ipynb..."
          papermill "AI_Forex_Brain 2.ipynb" "output/AI_Forex_Brain_Executed.ipynb" -k python3

      # --------------------------
      # 6Ô∏è‚É£ Upload Executed Notebook (for review)
      # --------------------------
      - name: Upload Executed Notebook
        uses: actions/upload-artifact@v4
        with:
          name: executed-notebook
          path: output/AI_Forex_Brain_Executed.ipynb

      # --------------------------
      # 7Ô∏è‚É£ Commit & Push Results (Retry Safe)
      # --------------------------
      - name: Commit and Push Results
        if: success() || failure()
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "${GIT_USER_EMAIL}"
          git add output/ || true
          git commit -m "üìà Auto-run: Updated executed notebook at $(date)" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.FOREX_PAT }}@github.com/${{ github.repository }}.git || echo "Push failed, will retry next run"
