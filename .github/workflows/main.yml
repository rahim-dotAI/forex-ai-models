name: Multi-Source Learning System v20.2 - Pipedream Triggered

on:
  workflow_dispatch:  # Manual trigger (Pipedream will use this!)
  push:
    paths: ['colab_trigger.txt']
    branches: [main]
  # REMOVED: schedule section (Pipedream handles timing now)

jobs:
  run-learning-system:
    runs-on: ubuntu-latest
    timeout-minutes: 55
    concurrency:
      group: forex-learning-system
      cancel-in-progress: false

    env:
      FOREX_PAT: ${{ secrets.FOREX_PAT }}
      BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
      ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      GIT_USER_NAME: "Forex AI Bot"
      GIT_USER_EMAIL: "nakatonabira3@gmail.com"
      PYTHONIOENCODING: utf-8
      PYTHONUNBUFFERED: 1
      GITHUB_ACTIONS: "true"
      SINGLE_RUN_MODE: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
          token: ${{ secrets.FOREX_PAT }}

      - name: Fix Submodules
        run: |
          [ -f ".gitmodules" ] && rm -f .gitmodules && git rm --cached -r forex-alpha-models 2>/dev/null || true
          find . -mindepth 2 -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true

      - name: Detect Day Type and Schedule
        id: day_info
        run: |
          HOUR=$(date +%H)
          DAY=$(date +%u)
          DAY_NAME=$(date +'%A')
          
          echo "day=$DAY" >> $GITHUB_OUTPUT
          echo "day_name=$DAY_NAME" >> $GITHUB_OUTPUT
          echo "hour=$HOUR" >> $GITHUB_OUTPUT
          
          # Alpha Vantage runs ONLY at 00:00 UTC
          if [ "$HOUR" = "00" ]; then
            echo "is_alpha_run=true" >> $GITHUB_OUTPUT
            echo "SKIP_ALPHA_VANTAGE=false" >> $GITHUB_ENV
            echo "ðŸŒ™ ALPHA VANTAGE RUN (00:00 UTC)"
          else
            echo "is_alpha_run=false" >> $GITHUB_OUTPUT
            echo "SKIP_ALPHA_VANTAGE=true" >> $GITHUB_ENV
            echo "âš¡ Regular run - Alpha Vantage SKIPPED"
          fi
          
          if [ $DAY -eq 6 ] || [ $DAY -eq 7 ]; then
            echo "is_weekend=true" >> $GITHUB_OUTPUT
            echo "ðŸ–ï¸ $DAY_NAME (Weekend - Intensive Learning)"
          else
            echo "is_weekend=false" >> $GITHUB_OUTPUT
            echo "ðŸ’¼ $DAY_NAME (Weekday - Live Trading)"
          fi
          
          echo ""
          echo "ðŸ“… Current: $DAY_NAME at $HOUR:00 UTC"
          echo "âš¡ Triggered by: Pipedream (Every 2 hours, exact timing!)"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install Dependencies
        run: |
          pip install -q --no-cache-dir pandas numpy requests beautifulsoup4 scikit-learn \
            jupyter nbconvert nbformat ta yfinance mplfinance firebase-admin dropbox \
            pyppeteer nest_asyncio lightgbm joblib matplotlib alpha_vantage tqdm river scipy

      - name: Configure Git
        run: |
          git config --global user.name "Forex AI Bot"
          git config --global user.email "nakatonabira3@gmail.com"
          echo "https://${{ github.actor }}:${{ secrets.FOREX_PAT }}@github.com" > ~/.git-credentials
          git config --global credential.helper store

      - name: Check Data Status
        id: data
        run: |
          echo "ðŸ“Š Checking existing data files..."
          
          PICKLE_COUNT=$(find data/processed -name "*.pkl" -type f ! -name "*_model.pkl" 2>/dev/null | wc -l)
          echo "pickle_count=$PICKLE_COUNT" >> $GITHUB_OUTPUT
          
          if [ -f "rl_memory/experience_replay.json.gz" ]; then
            echo "rl_memory_exists=true" >> $GITHUB_OUTPUT
          else
            echo "rl_memory_exists=false" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "learning_data/learning_outcomes.json" ]; then
            LEARNING_COUNT=$(python3 -c "import json; print(len(json.load(open('learning_data/learning_outcomes.json'))))" 2>/dev/null || echo "0")
            echo "learning_outcomes=$LEARNING_COUNT" >> $GITHUB_OUTPUT
          else
            echo "learning_outcomes=0" >> $GITHUB_OUTPUT
          fi
          
          [ -f ".github/run_history/run_counter.txt" ] && RUN_NUM=$(cat .github/run_history/run_counter.txt) || RUN_NUM=0
          RUN_NUM=$((RUN_NUM + 1))
          echo $RUN_NUM > .github/run_history/run_counter.txt
          echo "run_number=$RUN_NUM" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Status:"
          echo "   Pickle files: $PICKLE_COUNT"
          echo "   RL Memory: $([ -f "rl_memory/experience_replay.json.gz" ] && echo "Yes" || echo "No")"
          echo "   Learning outcomes: $LEARNING_COUNT"
          echo "   Run number: $RUN_NUM"
          
          mkdir -p data/raw/yfinance data/raw/alpha_vantage data/processed data/quarantine \
                   database logs outputs omega_state rl_memory backups learning_data .github/run_history

      - name: Verify Notebook
        run: |
          if [ ! -f "AI_Forex_Brain_2.ipynb" ]; then
            echo "âŒ ERROR: AI_Forex_Brain_2.ipynb not found!"
            exit 1
          fi
          echo "âœ… Found AI_Forex_Brain_2.ipynb"

      - name: Create Enhanced Notebook Executor
        run: |
          cat > run_full.py << 'EOF'
          import nbformat
          import sys
          import time
          import json
          import os
          import re
          from nbconvert.preprocessors import ExecutePreprocessor
          from datetime import datetime
          
          class SmartExecutor(ExecutePreprocessor):
              def __init__(self, *args, **kwargs):
                  super().__init__(*args, **kwargs)
                  self.cell_count = 0
                  self.start_time = None
                  self.successful_cells = 0
                  self.failed_cells = 0
                  self.critical_errors = []
                  self.stage_timings = {}
                  self.current_stage = "Unknown"
              
              def preprocess(self, nb, resources=None, km=None):
                  print("Processing cells...")
                  print("Triggered by: Pipedream (exact 2-hour intervals)")
                  
                  skip_av = os.environ.get('SKIP_ALPHA_VANTAGE', 'false').lower() == 'true'
                  print("Alpha Vantage:", "SKIPPED" if skip_av else "ACTIVE")
                  
                  self.start_time = time.time()
                  return super().preprocess(nb, resources, km)
              
              def detect_stage(self, cell_source):
                  source_lower = cell_source.lower()
                  if 'api_keys' in source_lower:
                      return "API Keys"
                  elif 'environment detection' in source_lower:
                      return "Environment"
                  elif 'github sync' in source_lower:
                      return "GitHub Sync"
                  elif 'alpha vantage' in source_lower and 'fetcher' in source_lower:
                      return "Alpha Vantage"
                  elif 'yfinance' in source_lower and 'fetcher' in source_lower:
                      return "YFinance"
                  elif 'combiner' in source_lower:
                      return "CSV Combiner"
                  elif 'pipeline v6' in source_lower:
                      return "Pipeline v6.1"
                  elif 'trade beacon' in source_lower:
                      return "Trade Beacon v20.2"
                  return self.current_stage
              
              def preprocess_cell(self, cell, resources, idx):
                  if cell.cell_type != 'code':
                      return cell, resources
                  
                  self.cell_count += 1
                  new_stage = self.detect_stage(cell.source)
                  
                  if new_stage != self.current_stage:
                      if self.current_stage in self.stage_timings:
                          self.stage_timings[self.current_stage]['duration'] = time.time() - self.stage_timings[self.current_stage]['start']
                      self.current_stage = new_stage
                      self.stage_timings[new_stage] = {'start': time.time(), 'duration': 0}
                      print(f"STAGE: {new_stage}")
                  
                  elapsed = time.time() - self.start_time
                  print(f"Cell {self.cell_count} | {self.current_stage} | {int(elapsed)}s")
                  
                  try:
                      cell, resources = super().preprocess_cell(cell, resources, idx)
                      self.successful_cells += 1
                      
                      if cell.outputs:
                          for output in cell.outputs:
                              if output.output_type == 'stream':
                                  text = re.sub(r'\x1b\[[0-9;]*m', '', output.text)
                                  important = ['COMPLETE', 'ERROR', 'Win Rate', 'LEARNING', 
                                             'Evaluated', 'learning_outcomes', 'Pipeline v6']
                                  for line in text.split('\n'):
                                      if any(m in line for m in important):
                                          print(f"  {line}")
                  except Exception as e:
                      self.failed_cells += 1
                      print(f"  Error: {str(e)[:100]}")
                  
                  return cell, resources
          
          with open('AI_Forex_Brain_2.ipynb', 'r') as f:
              nb = nbformat.read(f, as_version=4)
          
          print("="*70)
          print("PIPEDREAM-TRIGGERED LEARNING SYSTEM")
          print("="*70)
          
          ep = SmartExecutor(timeout=2400, kernel_name='python3', allow_errors=True)
          start = time.time()
          
          try:
              ep.preprocess(nb, {'metadata': {'path': '.'}})
              duration = time.time() - start
              
              print(f"\n{'='*70}")
              print("EXECUTION COMPLETED")
              print(f"Duration: {round(duration, 1)}s")
              print(f"Success: {ep.successful_cells}, Failed: {ep.failed_cells}")
              print(f"{'='*70}\n")
              
              report = {
                  'timestamp': datetime.now().isoformat(),
                  'trigger': 'pipedream',
                  'duration': duration,
                  'cells_executed': ep.cell_count,
                  'successful': ep.successful_cells,
                  'failed': ep.failed_cells,
                  'status': 'success'
              }
          except Exception as e:
              duration = time.time() - start
              print(f"\nError: {str(e)[:200]}")
              report = {
                  'timestamp': datetime.now().isoformat(),
                  'trigger': 'pipedream',
                  'duration': duration,
                  'status': 'error',
                  'error': str(e)[:200]
              }
          
          os.makedirs('.github/run_history', exist_ok=True)
          with open('.github/run_history/latest_run.json', 'w') as f:
              json.dump(report, f, indent=2)
          EOF

      - name: Run Full Notebook Pipeline
        run: |
          echo "ðŸš€ PIPEDREAM-TRIGGERED RUN"
          echo "=================================="
          echo "âš¡ Triggered at exactly: $(date +'%H:%M UTC')"
          echo "ðŸ“… Day: ${{ steps.day_info.outputs.day_name }}"
          echo "ðŸ”¢ Run: #${{ steps.data.outputs.run_number }}"
          echo ""
          python run_full.py
        timeout-minutes: 50

      - name: Extract Pipeline Metrics
        if: always()
        run: |
          cat > extract_metrics.py << 'EOF'
          import sqlite3
          import json
          import os
          from pathlib import Path
          
          metrics = {'status': 'no_data', 'version': 'v20.2', 'trigger': 'pipedream'}
          
          db_path = Path('database/memory_v85.db')
          if db_path.exists():
              try:
                  conn = sqlite3.connect(str(db_path))
                  c = conn.cursor()
                  c.execute("SELECT COUNT(*), SUM(CASE WHEN hit_tp THEN 1 ELSE 0 END) FROM completed_trades")
                  result = c.fetchone()
                  if result and result[0]:
                      metrics['pipeline_trades'] = result[0]
                      metrics['pipeline_wins'] = result[1] or 0
                  conn.close()
              except:
                  pass
          
          rl_memory = Path('rl_memory/experience_replay.json.gz')
          if rl_memory.exists():
              metrics['rl_memory_size'] = rl_memory.stat().st_size
          
          stats_file = Path('rl_memory/learning_stats.json')
          if stats_file.exists():
              try:
                  with open(stats_file) as f:
                      rl_stats = json.load(f)
                  metrics['rl_trades'] = rl_stats.get('total_trades', 0)
                  metrics['rl_win_rate'] = rl_stats.get('win_rate', 0) * 100
                  metrics['pipeline_v6_learned'] = rl_stats.get('pipeline_v6_learned', 0)
                  metrics['live_validated'] = rl_stats.get('live_validated', 0)
              except:
                  pass
          
          learning_db = Path('learning_data/learning_outcomes.json')
          if learning_db.exists():
              try:
                  with open(learning_db) as f:
                      outcomes = json.load(f)
                  metrics['learning_outcomes_count'] = len(outcomes)
              except:
                  pass
          
          os.makedirs('.github/run_history', exist_ok=True)
          with open('.github/run_history/metrics.json', 'w') as f:
              json.dump(metrics, f, indent=2)
          EOF
          python extract_metrics.py

      - name: Prepare Git for Commit
        if: success()
        run: |
          echo "ðŸ”„ Preparing git..."
          
          if ! git diff --quiet; then
            git stash push -m "Auto-stash - run ${{ steps.data.outputs.run_number }}"
            STASHED=true
          else
            STASHED=false
          fi
          
          git pull --rebase origin main || {
            git rebase --abort 2>/dev/null || true
            git pull --no-rebase origin main
          }
          
          if [ "$STASHED" = "true" ]; then
            git stash pop || echo "âš ï¸ Kept both versions"
          fi

      - name: Commit Everything
        if: success()
        run: |
          echo "ðŸ’¾ Committing changes..."
          git add -A
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No changes"
          else
            RUN="${{ steps.data.outputs.run_number }}"
            DAY="${{ steps.day_info.outputs.day_name }}"
            
            git commit -m "ðŸŽ“ Run #${RUN} - ${DAY} - Pipedream Triggered" || true
            
            for i in {1..5}; do
              if git push origin main; then
                echo "âœ… Successfully pushed"
                break
              else
                if [ $i -lt 5 ]; then
                  sleep 10
                  git pull --rebase origin main || git pull --strategy-option=theirs origin main
                fi
              fi
            done
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: learning-logs-${{ github.run_number }}
          path: |
            .github/run_history/*.json
            logs/*.log
            outputs/*.json
            rl_memory/learning_stats.json
            learning_data/learning_outcomes.json
          retention-days: 7
          if-no-files-found: ignore

      - name: Final Summary
        if: always()
        run: |
          echo "=========================================="
          echo "ðŸŽ“ PIPEDREAM-TRIGGERED RUN SUMMARY"
          echo "=========================================="
          echo "ðŸ“… Day: ${{ steps.day_info.outputs.day_name }}"
          echo "ðŸ”¢ Run: #${{ steps.data.outputs.run_number }}"
          echo "â° Time: $(date +'%Y-%m-%d %H:%M UTC')"
          echo "âš¡ Trigger: Pipedream (exact 2-hour intervals)"
          echo ""
          
          if [ -f ".github/run_history/metrics.json" ]; then
            echo "ðŸ“Š Latest Metrics:"
            cat .github/run_history/metrics.json | python3 -m json.tool 2>/dev/null || true
          fi
          
          echo ""
          echo "âœ… Run complete"
          echo "=========================================="
