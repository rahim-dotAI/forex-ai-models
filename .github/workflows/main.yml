name: Smart Forex Brain Pipeline v18.1 - API Optimized

on:
  workflow_dispatch:
  push:
    paths: ['colab_trigger.txt']
    branches: [main]
  schedule:
    # Main pipeline - Frequent runs with SKIP_ALPHA_VANTAGE
    - cron: '0 */2 * * 1-5'    # Weekdays: Every 2 hours
    - cron: '*/30 * * * 0,6'   # Weekends: Every 30 minutes
    
    # Alpha Vantage ONLY - Once daily at midnight UTC
    - cron: '0 0 * * *'         # Daily midnight: Full run including Alpha Vantage

jobs:
  run-forex-brain:
    runs-on: ubuntu-latest
    timeout-minutes: 55

    env:
      FOREX_PAT: ${{ secrets.FOREX_PAT }}
      BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
      ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      GIT_USER_NAME: "Forex AI Bot"
      GIT_USER_EMAIL: "nakatonabira3@gmail.com"
      PYTHONIOENCODING: utf-8
      PYTHONUNBUFFERED: 1
      GITHUB_ACTIONS: "true"
      SINGLE_RUN_MODE: "true"
      # ğŸ†• Skip Alpha Vantage except at midnight
      SKIP_ALPHA_VANTAGE: ${{ github.event.schedule != '0 0 * * *' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
          token: ${{ secrets.FOREX_PAT }}

      - name: Fix Submodules
        run: |
          [ -f ".gitmodules" ] && rm -f .gitmodules && git rm --cached -r forex-alpha-models 2>/dev/null || true
          find . -mindepth 2 -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true

      - name: Detect Day Type and Schedule
        id: day_info
        run: |
          DAY=$(date +%u)
          DAY_NAME=$(date +'%A')
          HOUR=$(date +%H)
          
          echo "day=$DAY" >> $GITHUB_OUTPUT
          echo "day_name=$DAY_NAME" >> $GITHUB_OUTPUT
          echo "hour=$HOUR" >> $GITHUB_OUTPUT
          
          # Detect if this is the midnight Alpha Vantage run
          if [ "${{ github.event.schedule }}" = "0 0 * * *" ]; then
            echo "is_alpha_run=true" >> $GITHUB_OUTPUT
            echo "ğŸŒ™ MIDNIGHT RUN - Alpha Vantage Data Fetch"
          else
            echo "is_alpha_run=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  REGULAR RUN - Alpha Vantage Skipped"
          fi
          
          if [ $DAY -eq 6 ] || [ $DAY -eq 7 ]; then
            echo "is_weekend=true" >> $GITHUB_OUTPUT
            echo "ğŸ–ï¸ $DAY_NAME (Weekend - Learning Mode)"
          else
            echo "is_weekend=false" >> $GITHUB_OUTPUT
            echo "ğŸ’¼ $DAY_NAME (Weekday - Full Trading)"
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install Dependencies
        run: |
          pip install -q --no-cache-dir pandas numpy requests beautifulsoup4 scikit-learn \
            jupyter nbconvert nbformat ta yfinance mplfinance firebase-admin dropbox \
            pyppeteer nest_asyncio lightgbm joblib matplotlib alpha_vantage tqdm river scipy

      - name: Configure Git
        run: |
          git config --global user.name "Forex AI Bot"
          git config --global user.email "nakatonabira3@gmail.com"
          echo "https://${{ github.actor }}:${{ secrets.FOREX_PAT }}@github.com" > ~/.git-credentials
          git config --global credential.helper store

      - name: Check Data Status
        id: data
        run: |
          echo "ğŸ“Š Checking existing data files..."
          
          # Count pickle files
          PICKLE_COUNT=$(find data/processed -name "*.pkl" -type f ! -name "*_model.pkl" 2>/dev/null | wc -l)
          echo "pickle_count=$PICKLE_COUNT" >> $GITHUB_OUTPUT
          
          # Count RL experience replay
          if [ -f "rl_memory/experience_replay.pkl.gz" ]; then
            echo "rl_memory_exists=true" >> $GITHUB_OUTPUT
          else
            echo "rl_memory_exists=false" >> $GITHUB_OUTPUT
          fi
          
          # Run counter
          [ -f ".github/run_history/run_counter.txt" ] && RUN_NUM=$(cat .github/run_history/run_counter.txt) || RUN_NUM=0
          RUN_NUM=$((RUN_NUM + 1))
          echo $RUN_NUM > .github/run_history/run_counter.txt
          echo "run_number=$RUN_NUM" >> $GITHUB_OUTPUT
          
          # Email report check (every 10 runs)
          [ $((RUN_NUM % 10)) -eq 0 ] && echo "send_report=true" >> $GITHUB_OUTPUT || echo "send_report=false" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Status:"
          echo "   Pickle files: $PICKLE_COUNT"
          echo "   RL Memory exists: $([ -f "rl_memory/experience_replay.pkl.gz" ] && echo "Yes" || echo "No")"
          echo "   Run number: $RUN_NUM"
          echo "   Alpha Vantage: ${{ steps.day_info.outputs.is_alpha_run == 'true' && 'ACTIVE' || 'SKIPPED' }}"
          
          mkdir -p data/raw/yfinance data/raw/alpha_vantage data/processed data/quarantine \
                   database logs outputs omega_state rl_memory rl_models backups .github/run_history

      - name: Verify Notebook
        run: |
          if [ ! -f "AI_Forex_Brain_2.ipynb" ]; then
            echo "âŒ ERROR: AI_Forex_Brain_2.ipynb not found!"
            ls -la *.ipynb 2>/dev/null || echo "No .ipynb files found"
            exit 1
          fi
          
          echo "âœ… Found AI_Forex_Brain_2.ipynb"
          
          # Check notebook structure
          CELLS=$(python -c "
          import nbformat
          with open('AI_Forex_Brain_2.ipynb', 'r') as f:
              nb = nbformat.read(f, 4)
          code_cells = sum(1 for c in nb.cells if c.cell_type=='code')
          print(code_cells)
          " 2>/dev/null || echo "0")
          
          echo "ğŸ“Š Code cells found: $CELLS"
          echo "â„¹ï¸  Expected: API Keys â†’ Env Setup â†’ GitHub Sync â†’ Alpha Vantage â†’ YFinance â†’ Combiner â†’ Pipeline â†’ Trade Beacon"

      - name: Create Enhanced Notebook Executor
        run: |
          cat > run_full.py << 'EOF'
          import nbformat, sys, time, json, os, re
          from nbconvert.preprocessors import ExecutePreprocessor
          from datetime import datetime
          
          class SmartExecutor(ExecutePreprocessor):
              def __init__(self, *args, **kwargs):
                  super().__init__(*args, **kwargs)
                  self.cell_count = 0
                  self.start_time = None
                  self.successful_cells = 0
                  self.failed_cells = 0
                  self.critical_errors = []
                  self.stage_timings = {}
                  self.current_stage = "Unknown"
              
              def preprocess(self, nb, resources=None, km=None):
                  code_cells = sum(1 for c in nb.cells if c.cell_type=='code')
                  print(f"ğŸ“Š Processing {len(nb.cells)} cells ({code_cells} code cells)...")
                  print(f"ğŸ–¥ï¸  Environment: GitHub Actions")
                  print(f"ğŸ“… Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}")
                  
                  # Display Alpha Vantage skip status
                  skip_av = os.environ.get('SKIP_ALPHA_VANTAGE', 'false').lower() == 'true'
                  if skip_av:
                      print(f"â­ï¸  Alpha Vantage: SKIPPED (uses existing data)")
                  else:
                      print(f"ğŸ”½ Alpha Vantage: ACTIVE (fetching fresh data)")
                  
                  self.start_time = time.time()
                  return super().preprocess(nb, resources, km)
              
              def detect_stage(self, cell_source):
                  """Detect pipeline stage from cell content"""
                  source_lower = cell_source.lower()
                  if 'api_keys' in source_lower or 'alpha_vantage_key' in source_lower:
                      return "1ï¸âƒ£ API Keys"
                  elif 'environment detection' in source_lower or 'in_colab' in source_lower:
                      return "2ï¸âƒ£ Environment"
                  elif 'github sync' in source_lower or 'repo_folder' in source_lower:
                      return "3ï¸âƒ£ GitHub Sync"
                  elif 'alpha vantage' in source_lower and 'fetcher' in source_lower:
                      return "4ï¸âƒ£ Alpha Vantage"
                  elif 'yfinance' in source_lower and 'fetcher' in source_lower:
                      return "5ï¸âƒ£ YFinance"
                  elif 'combiner' in source_lower or 'indicator' in source_lower:
                      return "6ï¸âƒ£ CSV Combiner"
                  elif 'ultra-persistent' in source_lower and 'pipeline' in source_lower:
                      return "7ï¸âƒ£ ML Pipeline"
                  elif 'trade beacon' in source_lower or 'deep q-learning' in source_lower:
                      return "8ï¸âƒ£ RL Agent"
                  return self.current_stage
              
              def preprocess_cell(self, cell, resources, idx):
                  if cell.cell_type != 'code':
                      return cell, resources
                  
                  self.cell_count += 1
                  
                  # Detect stage
                  new_stage = self.detect_stage(cell.source)
                  if new_stage != self.current_stage:
                      stage_start = time.time()
                      if self.current_stage in self.stage_timings:
                          self.stage_timings[self.current_stage]['duration'] = stage_start - self.stage_timings[self.current_stage]['start']
                      self.current_stage = new_stage
                      self.stage_timings[new_stage] = {'start': stage_start, 'duration': 0}
                      print(f"\n{'='*70}")
                      print(f"ğŸš€ STAGE: {new_stage}")
                      print(f"{'='*70}")
                  
                  elapsed = time.time() - self.start_time
                  print(f"\nâ³ Cell {self.cell_count} | {self.current_stage} | {elapsed:.0f}s elapsed")
                  
                  try:
                      cell, resources = super().preprocess_cell(cell, resources, idx)
                      self.successful_cells += 1
                      
                      # Extract and display key outputs
                      if cell.outputs:
                          for output in cell.outputs:
                              if output.output_type == 'stream':
                                  text = re.sub(r'\x1b\[[0-9;]*m', '', output.text)
                                  lines = text.strip().split('\n')
                                  
                                  # Key markers for different stages
                                  important_markers = [
                                      'âœ…', 'âš ï¸', 'âŒ', 'ğŸ’°', 'ğŸ§ ', 'ğŸ’¾', 'ğŸ“Š', 'ğŸ–¥ï¸', 'ğŸ”„', 'â­ï¸',
                                      'COMPLETE', 'ERROR', 'FAILED', 'SUCCESS', 'SKIPPED',
                                      'Win Rate', 'P&L', 'Iteration', 'Mode:', 'Total', 'Average',
                                      'Loaded', 'Saved', 'Updated', 'Found', 'Processing',
                                      'Quality', 'Trades', 'Epsilon', 'Experience Replay',
                                      'Pipeline Stats', 'Database', 'Q-Network', 'Backtest',
                                      'API calls', 'Daily API usage', 'Alpha Vantage'
                                  ]
                                  
                                  important_lines = [l for l in lines if any(marker in l for marker in important_markers)]
                                  
                                  if important_lines:
                                      for line in important_lines[:15]:
                                          print(f"  {line}")
                              
                              elif output.output_type == 'error':
                                  error_msg = f"{output.ename}: {output.evalue}"
                                  print(f"  âŒ Error: {error_msg}")
                                  self.critical_errors.append({
                                      'cell': self.cell_count,
                                      'stage': self.current_stage,
                                      'error': error_msg
                                  })
                  
                  except Exception as e:
                      self.failed_cells += 1
                      error_summary = str(e)[:200]
                      print(f"  âš ï¸ Cell {self.cell_count} error: {error_summary}")
                      print(f"  ğŸ”„ Continuing to next cell...")
                      self.critical_errors.append({
                          'cell': self.cell_count,
                          'stage': self.current_stage,
                          'error': error_summary
                      })
                  
                  return cell, resources
          
          if not os.path.exists('AI_Forex_Brain_2.ipynb'):
              print("âŒ ERROR: AI_Forex_Brain_2.ipynb not found!")
              sys.exit(1)
          
          with open('AI_Forex_Brain_2.ipynb', 'r') as f:
              nb = nbformat.read(f, as_version=4)
          
          print("="*70)
          print("ğŸš€ FOREX AI BRAIN - FULL PIPELINE EXECUTION")
          print("="*70)
          
          ep = SmartExecutor(timeout=2400, kernel_name='python3', allow_errors=True)
          start = time.time()
          
          try:
              ep.preprocess(nb, {'metadata': {'path': '.'}})
              duration = time.time() - start
              
              print(f"\n{'='*70}")
              print(f"âœ… EXECUTION COMPLETED")
              print(f"{'='*70}")
              print(f"â±ï¸  Duration: {duration:.1f}s ({duration/60:.1f} min)")
              print(f"ğŸ“Š Cells: {ep.cell_count} total")
              print(f"âœ… Success: {ep.successful_cells}")
              print(f"âš ï¸  Failed: {ep.failed_cells}")
              
              if ep.stage_timings:
                  print(f"\nğŸ“Š Stage Timings:")
                  for stage, timing in ep.stage_timings.items():
                      duration_val = timing.get('duration', 0)
                      if duration_val > 0:
                          print(f"  {stage}: {duration_val:.1f}s")
              
              if ep.critical_errors:
                  print(f"\nâš ï¸  Critical Errors ({len(ep.critical_errors)}):")
                  for err in ep.critical_errors[:5]:
                      print(f"  Cell {err['cell']} ({err['stage']}): {err['error'][:100]}")
              
              print(f"{'='*70}\n")
              
              report = {
                  'timestamp': datetime.now().isoformat(), 
                  'mode': 'full_pipeline', 
                  'duration': duration,
                  'cells_executed': ep.cell_count,
                  'successful': ep.successful_cells,
                  'failed': ep.failed_cells,
                  'status': 'success',
                  'stage_timings': {k: v['duration'] for k, v in ep.stage_timings.items() if 'duration' in v},
                  'critical_errors': len(ep.critical_errors),
                  'alpha_vantage_active': os.environ.get('SKIP_ALPHA_VANTAGE', 'false').lower() != 'true'
              }
              
          except Exception as e:
              duration = time.time() - start
              
              print(f"\n{'='*70}")
              print(f"âš ï¸ EXECUTION COMPLETED WITH ERRORS")
              print(f"{'='*70}")
              print(f"âŒ Error: {type(e).__name__}: {str(e)[:200]}")
              print(f"â±ï¸  Duration: {duration:.1f}s ({duration/60:.1f} min)")
              print(f"âœ… Successful cells: {ep.successful_cells}")
              print(f"âš ï¸  Failed cells: {ep.failed_cells}")
              print(f"{'='*70}\n")
              
              report = {
                  'timestamp': datetime.now().isoformat(), 
                  'mode': 'full_pipeline', 
                  'duration': duration,
                  'cells_executed': ep.cell_count,
                  'successful': ep.successful_cells,
                  'failed': ep.failed_cells,
                  'status': 'completed_with_errors',
                  'error': f"{type(e).__name__}: {str(e)[:200]}",
                  'stage_timings': {k: v['duration'] for k, v in ep.stage_timings.items() if 'duration' in v},
                  'critical_errors': len(ep.critical_errors),
                  'alpha_vantage_active': os.environ.get('SKIP_ALPHA_VANTAGE', 'false').lower() != 'true'
              }
          
          os.makedirs('.github/run_history', exist_ok=True)
          with open('.github/run_history/latest_run.json', 'w') as f: 
              json.dump(report, f, indent=2)
          
          print("âœ… Full notebook execution completed")
          print("ğŸ“ Report saved to .github/run_history/latest_run.json")
          EOF

      - name: Run Full Notebook Pipeline
        run: |
          echo "ğŸš€ STARTING FOREX AI BRAIN PIPELINE"
          echo "=================================="
          echo "ğŸ“… Day: ${{ steps.day_info.outputs.day_name }}"
          echo "ğŸ”¢ Run: #${{ steps.data.outputs.run_number }}"
          echo "â° Hour: ${{ steps.day_info.outputs.hour }}:00 UTC"
          echo "ğŸ““ Notebook: AI_Forex_Brain_2.ipynb"
          echo "ğŸ–¥ï¸  Environment: GitHub Actions"
          echo ""
          
          if [ "${{ steps.day_info.outputs.is_alpha_run }}" = "true" ]; then
            echo "ğŸŒ™ MIDNIGHT RUN - Full pipeline including Alpha Vantage"
            echo "ğŸ“Š Alpha Vantage: âœ… ACTIVE (4 API calls)"
          else
            echo "âš¡ REGULAR RUN - Alpha Vantage skipped"
            echo "ğŸ“Š Alpha Vantage: â­ï¸  SKIPPED (uses existing data)"
          fi
          
          echo ""
          echo "ğŸ“‹ Pipeline Stages:"
          echo "  1ï¸âƒ£  API Keys Configuration"
          echo "  2ï¸âƒ£  Environment Setup"
          echo "  3ï¸âƒ£  GitHub Repository Sync"
          
          if [ "${{ steps.day_info.outputs.is_alpha_run }}" = "true" ]; then
            echo "  4ï¸âƒ£  Alpha Vantage Data Fetch âœ…"
          else
            echo "  4ï¸âƒ£  Alpha Vantage Data Fetch â­ï¸  (skipped)"
          fi
          
          echo "  5ï¸âƒ£  YFinance Data Fetch"
          echo "  6ï¸âƒ£  CSV Combiner & Indicators"
          echo "  7ï¸âƒ£  ML Pipeline (Database Learning)"
          echo "  8ï¸âƒ£  Trade Beacon RL Agent"
          echo ""
          echo "ğŸ’¡ API Optimization:"
          echo "   Daily API usage: 4 calls (16% of 25 limit)"
          echo "   Savings: 44 calls/day vs hourly fetching"
          echo ""
          echo "â±ï¸  Estimated time: 30-50 minutes"
          echo "=================================="
          echo ""
          python run_full.py
        timeout-minutes: 50

      - name: Generate Enhanced Email Report
        if: steps.data.outputs.send_report == 'true'
        run: |
          cat > report.py << 'EOF'
          import json, os
          from glob import glob
          from datetime import datetime
          
          runs = sorted(glob('.github/run_history/archive/run_*.json'))[-10:]
          if not runs:
              print("No runs to report")
              exit(0)
          
          data = [json.load(open(f)) for f in runs]
          success = sum(1 for r in data if r.get('status') == 'success')
          avg_duration = sum(r.get('duration', 0) for r in data) / len(data)
          
          # Extract RL stats if available
          try:
              latest = json.load(open('.github/run_history/latest_run.json'))
              rl_trades = latest.get('rl_trades', 0)
              win_rate = latest.get('win_rate', 0)
              alpha_active = latest.get('alpha_vantage_active', False)
          except:
              rl_trades = 0
              win_rate = 0
              alpha_active = False
          
          html = f"""<!DOCTYPE html>
          <html><head><style>
          body{{font-family:-apple-system,sans-serif;padding:20px;background:#0f172a}}
          .container{{max-width:900px;margin:0 auto;background:#fff;padding:40px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.4)}}
          h1{{color:#2c3e50;border-bottom:3px solid #667eea;padding-bottom:15px}}
          .stats{{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0}}
          .stat{{background:linear-gradient(135deg,#667eea,#764ba2);padding:25px;border-radius:10px;color:#fff;text-align:center}}
          .stat h3{{margin:0;font-size:14px;opacity:0.9}}
          .stat .val{{font-size:36px;font-weight:900;margin:10px 0}}
          .stage{{background:#f8f9fa;padding:15px;border-left:4px solid #667eea;margin:10px 0}}
          .optimization{{background:#dcfce7;padding:15px;border-left:4px solid #10b981;margin:10px 0}}
          </style></head><body><div class="container">
          <h1>ğŸ§  Forex AI Brain - 10 Run Report</h1>
          <p style="color:#666">Generated: {datetime.now().strftime('%Y-%m-%d %H:%M UTC')}</p>
          <div class="stats">
          <div class="stat"><h3>âœ… Success Rate</h3><p class="val">{success}/{len(data)}</p></div>
          <div class="stat"><h3>â±ï¸ Avg Duration</h3><p class="val">{avg_duration/60:.1f}m</p></div>
          <div class="stat"><h3>ğŸ§  RL Trades</h3><p class="val">{rl_trades}</p></div>
          <div class="stat"><h3>ğŸ“Š Win Rate</h3><p class="val">{win_rate:.1f}%</p></div>
          </div>
          <div class="stage">
          <h3>ğŸ“‹ Pipeline Stages</h3>
          <p>âœ… Data Fetching â†’ Indicators â†’ ML Training â†’ RL Agent</p>
          </div>
          <div class="optimization">
          <h3>ğŸ’¡ API Optimization Active</h3>
          <p>Alpha Vantage: 4 calls/day (16% of limit) | Saves 44 calls/day</p>
          <p>Last run Alpha Vantage: {'âœ… Active' if alpha_active else 'â­ï¸ Skipped'}</p>
          </div>
          </div></body></html>"""
          
          with open('report.html', 'w') as f: f.write(html)
          print("âœ… Email report generated")
          EOF
          python report.py

      - name: Send Email Report
        if: steps.data.outputs.send_report == 'true'
        run: |
          cat > email.py << 'EOF'
          import smtplib, os
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          from datetime import datetime
          
          sender = os.getenv('GMAIL_USER')
          password = os.getenv('GMAIL_APP_PASSWORD')
          if not sender or not password: 
              print("âš ï¸ Email credentials not found")
              exit(0)
          
          with open('report.html') as f: html = f.read()
          msg = MIMEMultipart('alternative')
          msg['Subject'] = f'ğŸ§  Forex AI Brain Report - {datetime.now().strftime("%Y-%m-%d")}'
          msg['From'] = msg['To'] = sender
          msg.attach(MIMEText(html, 'html'))
          
          try:
              s = smtplib.SMTP('smtp.gmail.com', 587)
              s.starttls()
              s.login(sender, password)
              s.send_message(msg)
              s.quit()
              print("âœ… Email sent successfully")
          except Exception as e:
              print(f"âš ï¸ Email failed: {e}")
          EOF
          python email.py || true

      - name: Extract Pipeline Metrics
        if: always()
        run: |
          cat > extract_metrics.py << 'EOF'
          import sqlite3, json, os
          from pathlib import Path
          
          metrics = {'status': 'no_data'}
          
          # Check database
          db_path = Path('database/memory_v85.db')
          if db_path.exists():
              try:
                  conn = sqlite3.connect(str(db_path))
                  c = conn.cursor()
                  
                  # Pipeline stats
                  c.execute("SELECT COUNT(*), SUM(CASE WHEN hit_tp THEN 1 ELSE 0 END) FROM completed_trades")
                  result = c.fetchone()
                  if result and result[0]:
                      metrics['pipeline_trades'] = result[0]
                      metrics['pipeline_wins'] = result[1] or 0
                      metrics['pipeline_win_rate'] = (result[1] / result[0] * 100) if result[0] else 0
                  
                  conn.close()
              except Exception as e:
                  metrics['db_error'] = str(e)
          
          # Check RL memory
          rl_memory = Path('rl_memory/experience_replay.pkl.gz')
          if rl_memory.exists():
              metrics['rl_memory_size'] = rl_memory.stat().st_size
          
          # Check learning stats
          stats_file = Path('rl_memory/learning_stats.json')
          if stats_file.exists():
              try:
                  with open(stats_file) as f:
                      rl_stats = json.load(f)
                  metrics['rl_trades'] = rl_stats.get('total_trades', 0)
                  metrics['rl_win_rate'] = rl_stats.get('win_rate', 0) * 100
                  metrics['rl_pnl'] = rl_stats.get('total_pnl', 0)
              except:
                  pass
          
          # Add Alpha Vantage optimization info
          metrics['alpha_vantage_optimized'] = True
          metrics['daily_api_calls'] = 4
          metrics['api_usage_percent'] = 16
          
          # Save metrics
          os.makedirs('.github/run_history', exist_ok=True)
          with open('.github/run_history/metrics.json', 'w') as f:
              json.dump(metrics, f, indent=2)
          
          print("âœ… Metrics extracted:")
          for key, value in metrics.items():
              print(f"  {key}: {value}")
          EOF
          python extract_metrics.py

      - name: Commit All Changes
        if: success()
        run: |
          # Add all relevant files with specific patterns
          git add -f \
            data/raw/*/*.csv \
            data/processed/*.pkl \
            data/quarantine/* \
            database/*.db \
            logs/*.log \
            outputs/*.json \
            omega_state/*.json \
            rl_memory/*.pkl* \
            rl_memory/*.json* \
            rl_models/*.npz \
            backups/* \
            .github/run_history/* \
            2>/dev/null || true
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            RUN="${{ steps.data.outputs.run_number }}"
            IS_WEEKEND="${{ steps.day_info.outputs.is_weekend }}"
            IS_ALPHA="${{ steps.day_info.outputs.is_alpha_run }}"
            DAY="${{ steps.day_info.outputs.day_name }}"
            TIME="$(date +'%Y-%m-%d %H:%M UTC')"
            
            # Extract key metrics for commit message
            if [ -f ".github/run_history/metrics.json" ]; then
              METRICS=$(cat .github/run_history/metrics.json)
              RL_TRADES=$(echo "$METRICS" | grep -o '"rl_trades":[0-9]*' | grep -o '[0-9]*' || echo "0")
            else
              RL_TRADES="0"
            fi
            
            # Build commit message
            if [ "$IS_ALPHA" = "true" ]; then
              MSG="ğŸŒ™ Midnight Alpha Vantage Run #${RUN} - ${DAY}"
            elif [ "$IS_WEEKEND" = "true" ]; then
              MSG="ğŸ–ï¸ Weekend Learning Run #${RUN} - ${DAY}"
            else
              MSG="ğŸ”´ Live Trading Run #${RUN} - ${DAY}"
            fi
            
            MSG="${MSG} | RL: ${RL_TRADES} trades | ${TIME}"
            
            git commit -m "${MSG}" || true
            
            # Push with retry
            for i in {1..3}; do
              git push origin main && break || { 
                [ $i -lt 3 ] && sleep 5 && git pull --rebase origin main || exit 1
              }
            done
            
            echo "âœ… Changes committed and pushed"
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs-${{ github.run_number }}
          path: |
            .github/run_history/*.json
            report.html
            logs/*.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Final Summary
        if: always()
        run: |
          echo "=========================================="
          echo "ğŸ§  FOREX AI BRAIN PIPELINE SUMMARY"
          echo "=========================================="
          echo "ğŸ“… Day: ${{ steps.day_info.outputs.day_name }}"
          echo "ğŸ”¢ Run: #${{ steps.data.outputs.run_number }}"
          echo "â° Time: $(date +'%Y-%m-%d %H:%M UTC')"
          echo "ğŸ–¥ï¸  Env: GitHub Actions"
          echo ""
          
          if [ "${{ steps.day_info.outputs.is_alpha_run }}" = "true" ]; then
            echo "ğŸŒ™ Alpha Vantage: ACTIVE (4 API calls made)"
          else
            echo "â­ï¸  Alpha Vantage: SKIPPED (next run at midnight)"
          fi
          
          echo ""
          echo "ğŸ“‚ Data Files:"
          echo "   Processed pickles: ${{ steps.data.outputs.pickle_count }}"
          echo "   RL Memory: ${{ steps.data.outputs.rl_memory_exists }}"
          echo ""
          
          if [ -f ".github/run_history/metrics.json" ]; then
            echo "ğŸ“Š Metrics:"
            cat .github/run_history/metrics.json | grep -E '"(rl_trades|rl_win_rate|pipeline_trades|pipeline_win_rate)"' || true
            echo ""
          fi
          
          if [ -f ".github/run_history/latest_run.json" ]; then
            echo "â±ï¸  Execution:"
            cat .github/run_history/latest_run.json | grep -E '"(status|duration|successful|failed)"' || true
            echo ""
          fi
          
          echo "ğŸ’¡ API Optimization:"
          echo "   Daily usage: 4/25 calls (16%)"
          echo "   Savings: 44 calls/day"
          echo ""
          
          [ "${{ steps.data.outputs.send_report }}" = "true" ] && echo "ğŸ“§ Email Report: SENT" || echo "ğŸ“§ Email Report: Next at run $(( (${{ steps.data.outputs.run_number }} / 10 + 1) * 10 ))"
          echo ""
          echo "âœ… Pipeline execution complete"
          echo "=========================================="
              RL_TRADES=$(echo "$METRICS
