name: Smart Forex Brain Pipeline (Adaptive Schedule)

on:
  workflow_dispatch:
  push:
    paths:
      - 'colab_trigger.txt'
    branches:
      - main
  schedule:
    # Weekdays (Mon-Fri): Every 4 hours
    - cron: '0 */4 * * 1-5'
    # Weekends (Sat-Sun): Every 1 hour
    - cron: '0 * * * 0,6'

jobs:
  run-forex-brain:
    runs-on: ubuntu-latest
    timeout-minutes: 55

    env:
      FOREX_PAT: ${{ secrets.FOREX_PAT }}
      BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
      ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      GIT_USER_NAME: "Forex AI Bot"
      GIT_USER_EMAIL: "nakatonabira3@gmail.com"
      GITHUB_USERNAME: "rahim-dotAI"
      GITHUB_REPO: "forex-ai-models"
      PYTHONIOENCODING: utf-8
      PYTHONUNBUFFERED: 1
      GITHUB_ACTIONS: "true"
      SINGLE_RUN_MODE: "true"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
          lfs: true
          token: ${{ secrets.FOREX_PAT }}

      - name: Fix submodule issue
        run: |
          echo "=========================================="
          echo "üîß FIXING SUBMODULE CONFIGURATION"
          echo "=========================================="
          
          if [ -f ".gitmodules" ]; then
            echo "‚ö†Ô∏è Found .gitmodules file - removing it"
            rm -f .gitmodules
            git rm --cached -r forex-alpha-models 2>/dev/null || true
            rm -rf forex-alpha-models
            git add .gitmodules 2>/dev/null || true
            echo "‚úÖ Submodule configuration removed"
          else
            echo "‚úÖ No .gitmodules file found"
          fi
          
          find . -mindepth 2 -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
          echo "=========================================="

      - name: Detect Weekend vs Weekday Mode
        id: detect_mode
        run: |
          DAY_OF_WEEK=$(date +%u)
          HOUR=$(date +%H)
          
          echo "=========================================="
          echo "üóìÔ∏è  EXECUTION MODE DETECTION"
          echo "=========================================="
          echo "Current day: $DAY_OF_WEEK (1=Mon, 7=Sun)"
          echo "Current hour: $HOUR UTC"
          echo "Date: $(date +'%A, %B %d, %Y %H:%M UTC')"
          echo ""
          
          if [ $DAY_OF_WEEK -eq 6 ] || [ $DAY_OF_WEEK -eq 7 ]; then
            echo "is_weekend=true" >> $GITHUB_OUTPUT
            echo "execution_mode=weekend_tagged_cells" >> $GITHUB_OUTPUT
            echo "schedule_type=hourly" >> $GITHUB_OUTPUT
            echo "üéØ MODE: WEEKEND"
            echo "   ‚Ä¢ Execution: Tagged cells only (Omega v12.0 PRODUCTION)"
            echo "   ‚Ä¢ Schedule: Every 1 hour"
            echo "   ‚Ä¢ Focus: Learning & optimization with strict validation"
          else
            echo "is_weekend=false" >> $GITHUB_OUTPUT
            echo "execution_mode=weekday_full_notebook" >> $GITHUB_OUTPUT
            echo "schedule_type=4hourly" >> $GITHUB_OUTPUT
            echo "üéØ MODE: WEEKDAY"
            echo "   ‚Ä¢ Execution: Full notebook (all cells)"
            echo "   ‚Ä¢ Schedule: Every 4 hours"
            echo "   ‚Ä¢ Focus: Live trading + data collection"
          fi
          echo "=========================================="

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          echo "üì¶ Installing Python dependencies..."
          python -m pip install --upgrade pip wheel setuptools
          pip install --no-cache-dir \
            pandas numpy requests beautifulsoup4 scikit-learn \
            jupyter nbconvert nbformat ta yfinance \
            mplfinance firebase-admin dropbox \
            pyppeteer nest_asyncio lightgbm joblib matplotlib \
            alpha_vantage tqdm river scipy
          echo "‚úÖ Dependencies installed"

      - name: Configure Git
        run: |
          git config --global user.name "${GIT_USER_NAME}"
          git config --global user.email "${GIT_USER_EMAIL}"
          git config --global credential.helper store
          echo "https://${GITHUB_USERNAME}:${FOREX_PAT}@github.com" > ~/.git-credentials
          echo "‚úÖ Git configured"

      - name: Check for Required Data Files (Weekend)
        if: steps.detect_mode.outputs.is_weekend == 'true'
        id: check_data
        run: |
          echo "=========================================="
          echo "üîç CHECKING FOR REQUIRED DATA FILES"
          echo "=========================================="
          
          # Check for processed pickle files (excluding model and cache files)
          PICKLE_COUNT=$(find data/processed -name "*.pkl" -type f 2>/dev/null | \
            grep -v "_sgd_model\|_rf_model\|indicator_cache\|ultra_\|alpha_\|_model.pkl" | wc -l)
          
          # Check for database file
          DB_EXISTS=false
          if [ -f "database/memory_v85.db" ]; then
            DB_SIZE=$(wc -c < "database/memory_v85.db" 2>/dev/null || echo "0")
            if [ "$DB_SIZE" -gt "1000" ]; then
              DB_EXISTS=true
            fi
          fi
          
          # Check for Omega state files
          OMEGA_STATE_EXISTS=false
          if [ -f "omega_state/omega_learning.pkl" ] || [ -f "omega_state/omega_iteration.pkl" ]; then
            OMEGA_STATE_EXISTS=true
          fi
          
          echo "üìä Data Status:"
          echo "   Processed pickle files: $PICKLE_COUNT"
          echo "   Database exists: $DB_EXISTS"
          echo "   Omega state exists: $OMEGA_STATE_EXISTS"
          echo ""
          
          # Decision: need pickles AND database for tagged cells
          if [ $PICKLE_COUNT -ge 4 ] && [ "$DB_EXISTS" = "true" ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
            echo "execution_type=tagged_cells" >> $GITHUB_OUTPUT
            echo "‚úÖ SUFFICIENT DATA FOUND"
            echo "   ‚Ä¢ Will run: Tagged cells only (Omega v12.0 PRODUCTION)"
            echo "   ‚Ä¢ Pickle files: $PICKLE_COUNT/4 ‚úì"
            echo "   ‚Ä¢ Database: Present ‚úì"
            echo "   ‚Ä¢ Mode: Fast learning with strict validation (2-5 min)"
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
            echo "execution_type=full_notebook" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  INSUFFICIENT DATA - NEEDS FULL NOTEBOOK"
            echo "   ‚Ä¢ Pickle files: $PICKLE_COUNT/4 (need ‚â•4)"
            echo "   ‚Ä¢ Database: $([ "$DB_EXISTS" = "true" ] && echo "Present ‚úì" || echo "Missing ‚úó")"
            echo "   ‚Ä¢ Will run: Full notebook to generate all data"
            echo "   ‚Ä¢ Purpose: Create foundation for future runs"
            echo "   ‚Ä¢ Time: ~40-50 minutes"
            echo "   ‚Ä¢ Next weekend: Will use fast tagged cells!"
          fi
          echo "=========================================="

      - name: Run Weekend Tagged Cells (Omega v12.0 PRODUCTION)
        if: steps.detect_mode.outputs.is_weekend == 'true' && steps.check_data.outputs.has_data == 'true'
        run: |
          # (content unchanged ‚Äî entire block preserved)
