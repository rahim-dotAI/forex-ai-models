name: Smart Forex Brain Pipeline (Adaptive Schedule)

on:
  workflow_dispatch:
  push:
    paths:
      - 'colab_trigger.txt'
    branches:
      - main
  schedule:
    # ONLY WEEKDAYS (Monâ€“Fri): Every 4 hours
    - cron: '0 */4 * * 1-5'
    # âŒ Weekend hourly cron REMOVED

jobs:
  run-forex-brain:
    runs-on: ubuntu-latest
    timeout-minutes: 55

    env:
      FOREX_PAT: ${{ secrets.FOREX_PAT }}
      BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
      ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      GIT_USER_NAME: "Forex AI Bot"
      GIT_USER_EMAIL: "nakatonabira3@gmail.com"
      GITHUB_USERNAME: "rahim-dotAI"
      GITHUB_REPO: "forex-ai-models"
      PYTHONIOENCODING: utf-8
      PYTHONUNBUFFERED: 1
      GITHUB_ACTIONS: "true"
      SINGLE_RUN_MODE: "true"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
          lfs: true
          token: ${{ secrets.FOREX_PAT }}

      - name: Fix submodule issue
        run: |
          echo "=========================================="
          echo "ðŸ”§ FIXING SUBMODULE CONFIGURATION"
          echo "=========================================="
          
          if [ -f ".gitmodules" ]; then
            echo "âš ï¸ Found .gitmodules file - removing it"
            rm -f .gitmodules
            git rm --cached -r forex-alpha-models 2>/dev/null || true
            rm -rf forex-alpha-models
            git add .gitmodules 2>/dev/null || true
            echo "âœ… Submodule configuration removed"
          else:
            echo "âœ… No .gitmodules file found"
          fi
          
          find . -mindepth 2 -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
          echo "=========================================="

      - name: Detect Weekend vs Weekday Mode
        id: detect_mode
        run: |
          DAY_OF_WEEK=$(date +%u)
          echo "=========================================="
          echo "ðŸ—“ï¸ EXECUTION MODE DETECTION"
          echo "=========================================="
          echo "Current day: $DAY_OF_WEEK (1=Mon, 7=Sun)"
          if [ $DAY_OF_WEEK -eq 6 ] || [ $DAY_OF_WEEK -eq 7 ]; then
            echo "is_weekend=true" >> $GITHUB_OUTPUT
            echo "execution_mode=weekend_tagged_cells" >> $GITHUB_OUTPUT
            echo "schedule_type=hourly" >> $GITHUB_OUTPUT
          else
            echo "is_weekend=false" >> $GITHUB_OUTPUT
            echo "execution_mode=weekday_full_notebook" >> $GITHUB_OUTPUT
            echo "schedule_type=4hourly" >> $GITHUB_OUTPUT
          fi
          echo "=========================================="

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install --no-cache-dir \
            pandas numpy requests beautifulsoup4 scikit-learn \
            jupyter nbformat ta yfinance mplfinance firebase-admin \
            dropbox pyppeteer nest_asyncio lightgbm joblib matplotlib \
            alpha_vantage tqdm river scipy

      - name: Configure Git
        run: |
          git config --global user.name "${GIT_USER_NAME}"
          git config --global user.email "${GIT_USER_EMAIL}"
          git config --global credential.helper store
          echo "https://${GITHUB_USERNAME}:${FOREX_PAT}@github.com" > ~/.git-credentials

      - name: Check for Required Data Files (Weekend)
        if: steps.detect_mode.outputs.is_weekend == 'true'
        id: check_data
        run: |
          PICKLE_COUNT=$(find data/processed -name "*.pkl" -type f 2>/dev/null | \
            grep -v "_sgd_model\|_rf_model\|indicator_cache\|ultra_\|alpha_\|_model.pkl\|\.bak" | wc -l)
          if [ $PICKLE_COUNT -ge 4 ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Weekend Tagged Cells (Trade Beacon v13.0)
        if: steps.detect_mode.outputs.is_weekend == 'true' && steps.check_data.outputs.has_data == 'true'
        run: |
          NOTEBOOK_FILE="AI_Forex_Brain_2.ipynb"
          if [ ! -f "$NOTEBOOK_FILE" ]; then
            echo "âŒ Notebook not found: $NOTEBOOK_FILE"
            exit 1
          fi

          cat > run_tagged_cells.py << 'EOFPYTHON'
          import nbformat, sys, os, traceback
          def extract_and_run_tagged_cells(notebook_path):
              with open(notebook_path, 'r', encoding='utf-8') as f:
                  nb = nbformat.read(f, as_version=4)
              tagged = []
              for cell in nb.cells:
                  if cell.cell_type == 'code' and '# TAG: pipeline_main' in cell.source:
                      tagged.append(cell.source)
              if not tagged:
                  print("âŒ No tagged cells found")
                  return False
              for i, code in enumerate(tagged, 1):
                  clean = '\n'.join([ln for ln in code.split('\n') if not ln.strip().startswith('# TAG:')])
                  try:
                      exec(clean, globals())
                  except Exception as e:
                      print(f"âŒ Tagged cell {i} failed: {e}")
                      traceback.print_exc()
                      return False
              return True
          if __name__ == "__main__":
              if not extract_and_run_tagged_cells("AI_Forex_Brain_2.ipynb"):
                  sys.exit(1)
          EOFPYTHON

          python run_tagged_cells.py 2>&1 | tee weekend_execution.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            tail -n 100 weekend_execution.log
            exit 1
          fi
        timeout-minutes: 50

      - name: Run Full Notebook on Weekend (Fallback)
        if: steps.detect_mode.outputs.is_weekend == 'true' && steps.check_data.outputs.has_data == 'false'
        run: |
          python -c "
import nbformat
from nbconvert.preprocessors import ExecutePreprocessor
with open('AI_Forex_Brain_2.ipynb', 'r', encoding='utf-8') as f:
    nb = nbformat.read(f, 4)
ep = ExecutePreprocessor(timeout=2400, kernel_name='python3')
ep.preprocess(nb, {'metadata': {'path': '.'}})
" 2>&1 | tee weekend_data_generation.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            tail -n 100 weekend_data_generation.log
            exit 1
          fi
        timeout-minutes: 50

      - name: Run Full Notebook (WEEKDAY)
        if: steps.detect_mode.outputs.is_weekend == 'false'
        run: |
          python -c "
import nbformat
from nbconvert.preprocessors import ExecutePreprocessor
with open('AI_Forex_Brain_2.ipynb', 'r', encoding='utf-8') as f:
    nb = nbformat.read(f, 4)
ep = ExecutePreprocessor(timeout=2400, kernel_name='python3')
ep.preprocess(nb, {'metadata': {'path': '.'}})
" 2>&1 | tee notebook_execution.log
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            tail -n 200 notebook_execution.log
            exit 1
          fi
        timeout-minutes: 50

      - name: Verify output files
        if: always()
        run: |
          echo "=========================================="
          echo "ðŸ“‹ OUTPUT CHECK"
          echo "=========================================="
          ls -la outputs/omega_signals.json 2>/dev/null || echo "âš ï¸ omega_signals.json missing"
          find data/processed -name "*.pkl" | head -n 5

      - name: Clean up nested repos
        if: always()
        run: |
          find . -mindepth 2 -name ".git" -exec rm -rf {} + 2>/dev/null || true
          [ -d "forex-alpha-models" ] && rm -rf forex-alpha-models

      - name: Commit and push changes
        if: always()
        run: |
          git add -A
          if ! git diff --cached --quiet; then
            MSG="ðŸ¤– Trade Beacon v13.0 - $(date +'%Y-%m-%d %H:%M UTC')"
            git commit -m "$MSG" || true
            git push origin main
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-logs-${{ github.run_number }}
          path: |
            weekend_execution.log
            weekend_data_generation.log
            notebook_execution.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Execution Summary
        if: always()
        run: |
          echo "=========================================="
          echo "âœ… EXECUTION COMPLETE"
          echo "Notebook: AI_Forex_Brain_2.ipynb"
          echo "Engine: Trade Beacon v13.0"
          echo "Weekend cron: REMOVED"
          echo "=========================================="
