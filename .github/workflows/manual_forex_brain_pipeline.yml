name: Smart Forex Brain Pipeline (Cell-Specific Execution)

on:
  workflow_dispatch:
  push:
    paths:
      - 'colab_trigger.txt'
    branches:
      - main
  schedule:
    - cron: '0 */4 * * *'

jobs:
  run-forex-brain:
    runs-on: ubuntu-latest
    timeout-minutes: 55

    env:
      FOREX_PAT: ${{ secrets.FOREX_PAT }}
      BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
      ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      GIT_USER_NAME: "Forex AI Bot"
      GIT_USER_EMAIL: "nakatonabira3@gmail.com"
      GITHUB_USERNAME: "rahim-dotAI"
      GITHUB_REPO: "forex-ai-models"
      PYTHONIOENCODING: utf-8
      PYTHONUNBUFFERED: 1
      GITHUB_ACTIONS: "true"
      SINGLE_RUN_MODE: "true"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
          lfs: true
          token: ${{ secrets.FOREX_PAT }}

      - name: Detect Weekend vs Weekday Mode
        id: detect_mode
        run: |
          DAY_OF_WEEK=$(date +%u)
          
          echo "=========================================="
          echo "üóìÔ∏è  DAY DETECTION"
          echo "=========================================="
          echo "Current day: $DAY_OF_WEEK (1=Mon, 7=Sun)"
          echo "Date: $(date +'%A, %B %d, %Y %H:%M UTC')"
          
          if [ $DAY_OF_WEEK -eq 6 ] || [ $DAY_OF_WEEK -eq 7 ]; then
            echo "is_weekend=true" >> $GITHUB_OUTPUT
            echo "execution_mode=weekend_v85_only" >> $GITHUB_OUTPUT
            echo "üéØ MODE: WEEKEND (v8.5 Pipeline Only)"
          elif [ $DAY_OF_WEEK -eq 1 ]; then
            echo "is_weekend=false" >> $GITHUB_OUTPUT
            echo "execution_mode=monday_full" >> $GITHUB_OUTPUT
            echo "üéØ MODE: MONDAY (Targeted Cell Execution)"
          else
            echo "is_weekend=false" >> $GITHUB_OUTPUT
            echo "execution_mode=weekday_smart" >> $GITHUB_OUTPUT
            echo "üéØ MODE: WEEKDAY (Smart Detection)"
          fi
          echo "=========================================="

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install --no-cache-dir \
            pandas numpy requests beautifulsoup4 scikit-learn jupyter nbconvert ta nbformat

      - name: Configure Git
        run: |
          git config --global user.name "${GIT_USER_NAME}"
          git config --global user.email "${GIT_USER_EMAIL}"
          git config --global credential.helper store
          echo "https://${GITHUB_USERNAME}:${FOREX_PAT}@github.com" > ~/.git-credentials

      - name: Check data availability (Weekday Smart Mode Only)
        if: steps.detect_mode.outputs.execution_mode == 'weekday_smart'
        id: check_data
        run: |
          echo "=========================================="
          echo "CHECKING DATA FOR SMART MODE"
          echo "=========================================="
          
          MERGED_PKL_COUNT=$(find . -maxdepth 1 -name "*_2244.pkl" -type f -size +10k 2>/dev/null | wc -l)
          
          echo "üìä Found $MERGED_PKL_COUNT merged pickle files"
          
          if [ $MERGED_PKL_COUNT -ge 4 ]; then
            echo "decision=v85_only" >> $GITHUB_OUTPUT
            echo "‚úÖ DECISION: Run v8.5 only"
          else
            echo "decision=full_pipeline" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  DECISION: Run full pipeline"
          fi
          echo "=========================================="

      - name: Verify data files exist (Weekend/Smart v8.5 mode)
        if: |
          steps.detect_mode.outputs.is_weekend == 'true' || 
          (steps.detect_mode.outputs.execution_mode == 'weekday_smart' && steps.check_data.outputs.decision == 'v85_only')
        run: |
          echo "=========================================="
          echo "VERIFYING DATA FILES"
          echo "=========================================="
          
          PICKLE_COUNT=$(find . -maxdepth 1 -name "*_2244.pkl" -type f 2>/dev/null | wc -l)
          
          if [ $PICKLE_COUNT -lt 4 ]; then
            echo "‚ùå ERROR: Only $PICKLE_COUNT/4 pickle files found"
            echo "Available files:"
            ls -lh *.pkl 2>/dev/null || echo "No pickle files"
            exit 1
          fi
          
          echo "‚úÖ Found all required data files ($PICKLE_COUNT)"
          echo "Files:"
          ls -lh *_2244.pkl
          echo "=========================================="

      - name: Run v8.5 Pipeline (Weekend or Data Exists)
        if: |
          steps.detect_mode.outputs.is_weekend == 'true' || 
          (steps.detect_mode.outputs.execution_mode == 'weekday_smart' && steps.check_data.outputs.decision == 'v85_only')
        run: |
          echo "=========================================="
          echo "üü¢ RUNNING FULL v8.5.1 PIPELINE"
          echo "=========================================="
          echo "Mode: ${{ steps.detect_mode.outputs.execution_mode }}"
          echo ""
          
          PIPELINE_FILE=""
          if [ -f "forex_pipeline_v851.py" ]; then
            PIPELINE_FILE="forex_pipeline_v851.py"
          elif [ -f "forex_pipeline_v85.py" ]; then
            PIPELINE_FILE="forex_pipeline_v85.py"
          elif [ -f "Ultimate_Forex_Pipeline_v851.py" ]; then
            PIPELINE_FILE="Ultimate_Forex_Pipeline_v851.py"
          fi
          
          if [ -z "$PIPELINE_FILE" ]; then
            echo "‚ùå ERROR: Could not find v8.5 pipeline file!"
            exit 1
          fi
          
          echo "‚úÖ Found: $PIPELINE_FILE"
          python "$PIPELINE_FILE" 2>&1 | tee pipeline_output.log
          
          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Pipeline failed with exit code $EXIT_CODE"
            tail -n 100 pipeline_output.log
            exit $EXIT_CODE
          fi
          
          echo "‚úÖ Pipeline completed successfully"
        timeout-minutes: 25

      - name: Run Targeted Cell (Monday or Missing Data)
        if: |
          steps.detect_mode.outputs.execution_mode == 'monday_full' ||
          (steps.detect_mode.outputs.execution_mode == 'weekday_smart' && steps.check_data.outputs.decision == 'full_pipeline')
        run: |
          echo "=========================================="
          echo "üéØ RUNNING TARGETED CELL FROM NOTEBOOK"
          echo "=========================================="
          echo "Mode: ${{ steps.detect_mode.outputs.execution_mode }}"
          echo ""
          
          # Check if notebook exists
          if [ ! -f "AI_Forex_Brain_2.ipynb" ]; then
            echo "‚ùå ERROR: AI_Forex_Brain_2.ipynb not found!"
            ls -lh *.ipynb 2>/dev/null || echo "No notebooks found"
            exit 1
          fi
          
          # Create Python script to extract and run specific cell
          cat > extract_cell.py << 'EOF'
          import nbformat
          import sys
          import re
          
          def extract_tagged_cell(notebook_path, tag="pipeline_main"):
              """Extract cell with specific tag from notebook"""
              with open(notebook_path, 'r', encoding='utf-8') as f:
                  nb = nbformat.read(f, as_version=4)
              
              # Look for cell with matching tag
              for cell in nb.cells:
                  if cell.cell_type == 'code':
                      # Check metadata tags
                      tags = cell.get('metadata', {}).get('tags', [])
                      if tag in tags:
                          print(f"Found cell with tag '{tag}'")
                          return cell.source
                      
                      # Alternative: Check for marker comment
                      if f"# TAG: {tag}" in cell.source or f"# @{tag}" in cell.source:
                          print(f"Found cell with marker comment '{tag}'")
                          return cell.source
              
              print(f"No cell found with tag '{tag}'")
              print("Available tags in notebook:")
              for i, cell in enumerate(nb.cells):
                  if cell.cell_type == 'code':
                      tags = cell.get('metadata', {}).get('tags', [])
                      if tags:
                          print(f"  Cell {i}: {tags}")
                      # Check for marker comments
                      if '# TAG:' in cell.source or '# @' in cell.source:
                          markers = re.findall(r'# TAG: (\w+)|# @(\w+)', cell.source)
                          if markers:
                              print(f"  Cell {i}: {[m for m in markers[0] if m]}")
              
              return None
          
          if __name__ == "__main__":
              notebook = sys.argv[1] if len(sys.argv) > 1 else "AI_Forex_Brain_2.ipynb"
              tag = sys.argv[2] if len(sys.argv) > 2 else "pipeline_main"
              
              code = extract_tagged_cell(notebook, tag)
              
              if code:
                  # Clean IPython magics
                  code = re.sub(r'^%.*$', '', code, flags=re.MULTILINE)
                  code = re.sub(r'^!.*$', '', code, flags=re.MULTILINE)
                  code = code.replace('get_ipython()', '# get_ipython()')
                  
                  # Fix paths for GitHub Actions
                  code = code.replace('Path("/content")', 'Path(".")')
                  code = code.replace('"forex-alpha-models"', '"."')
                  
                  # Write to file
                  with open('targeted_cell.py', 'w', encoding='utf-8') as f:
                      f.write(code)
                  
                  print(f"Extracted {len(code)} characters to targeted_cell.py")
              else:
                  sys.exit(1)
          EOF
          
          # Extract the targeted cell
          echo "Extracting targeted cell from notebook..."
          python extract_cell.py "AI_Forex_Brain_2.ipynb" "pipeline_main"
          
          if [ ! -f "targeted_cell.py" ]; then
            echo "‚ùå Failed to extract cell"
            exit 1
          fi
          
          echo ""
          echo "First 20 lines of extracted code:"
          head -20 targeted_cell.py
          echo ""
          
          # Run the extracted cell
          echo "Running extracted cell..."
          python targeted_cell.py 2>&1 | tee pipeline_output.log
          
          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "‚ùå Cell execution failed with exit code $EXIT_CODE"
            echo ""
            echo "Last 100 lines of output:"
            tail -n 100 pipeline_output.log
            exit $EXIT_CODE
          fi
          
          echo ""
          echo "‚úÖ Cell executed successfully"
        timeout-minutes: 50

      - name: Commit and push changes
        if: always()
        run: |
          git add -A
          
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            MODE="${{ steps.detect_mode.outputs.execution_mode }}"
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S UTC')
            
            git commit -m "ü§ñ Auto-update [$MODE]: $TIMESTAMP" || true
            
            echo "Syncing with remote..."
            for i in {1..3}; do
              echo "Attempt $i: Pulling latest changes..."
              if git pull --rebase origin main 2>&1 | grep -q "CONFLICT"; then
                echo "‚ö†Ô∏è  Conflict detected, resolving with ours strategy..."
                git checkout --ours .
                git add -A
                git rebase --continue || true
              fi
              
              echo "Attempt $i: Pushing to GitHub..."
              if git push origin main 2>&1; then
                echo "‚úÖ Successfully pushed on attempt $i"
                break
              else
                echo "‚ö†Ô∏è  Push failed on attempt $i"
                if [ $i -lt 3 ]; then
                  echo "Waiting 3 seconds before retry..."
                  sleep 3
                  git fetch origin main
                  git reset --soft origin/main
                  git add -A
                  git commit -m "ü§ñ Auto-update [$MODE]: $TIMESTAMP" || true
                else
                  echo "‚ùå All push attempts failed"
                  exit 1
                fi
              fi
            done
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs-${{ github.run_number }}
          path: |
            pipeline_output.log
            targeted_cell.py
            extract_cell.py
            forex_pipeline_v85.log
            pipeline.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "üìä EXECUTION SUMMARY"
          echo "=========================================="
          echo "Mode: ${{ steps.detect_mode.outputs.execution_mode }}"
          echo "Weekend: ${{ steps.detect_mode.outputs.is_weekend }}"
          echo "Date: $(date +'%A, %B %d, %Y %H:%M UTC')"
          echo ""
          echo "Generated Files:"
          
          # Check each file individually with proper quoting
          if [ -f "broker_signals.json" ]; then
            FILE_SIZE=$(wc -c < "broker_signals.json" 2>/dev/null || echo "0")
            echo "  ‚úÖ broker_signals.json (${FILE_SIZE} bytes)"
          fi
          
          if [ -f "ensemble_signals.json" ]; then
            FILE_SIZE=$(wc -c < "ensemble_signals.json" 2>/dev/null || echo "0")
            echo "  ‚úÖ ensemble_signals.json (${FILE_SIZE} bytes)"
          fi
          
          if [ -f "learning_v85.pkl" ]; then
            FILE_SIZE=$(wc -c < "learning_v85.pkl" 2>/dev/null || echo "0")
            echo "  ‚úÖ learning_v85.pkl (${FILE_SIZE} bytes)"
          fi
          
          if [ -f "iteration_v85.pkl" ]; then
            FILE_SIZE=$(wc -c < "iteration_v85.pkl" 2>/dev/null || echo "0")
            echo "  ‚úÖ iteration_v85.pkl (${FILE_SIZE} bytes)"
          fi
          
          if [ -f "memory_v85.db" ]; then
            FILE_SIZE=$(wc -c < "memory_v85.db" 2>/dev/null || echo "0")
            echo "  ‚úÖ memory_v85.db (${FILE_SIZE} bytes)"
          fi
          
          echo "=========================================="
