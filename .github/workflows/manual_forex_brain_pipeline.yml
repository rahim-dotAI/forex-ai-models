name: Smart Forex Brain Pipeline (Weekend-Aware Auto-Detect)

on:
  workflow_dispatch:
  push:
    paths:
      - 'colab_trigger.txt'
    branches:
      - main
  schedule:
    - cron: '0 */4 * * *'  # Every 4 hours

jobs:
  run-forex-brain:
    runs-on: ubuntu-latest
    timeout-minutes: 55

    env:
      FOREX_PAT: ${{ secrets.FOREX_PAT }}
      BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
      ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
      GMAIL_USER: ${{ secrets.GMAIL_USER }}
      GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      GIT_USER_NAME: "Forex AI Bot"
      GIT_USER_EMAIL: "nakatonabira3@gmail.com"
      GITHUB_USERNAME: "rahim-dotAI"
      GITHUB_REPO: "forex-ai-models"
      PYTHONIOENCODING: utf-8
      PYTHONUNBUFFERED: 1
      GITHUB_ACTIONS: "true"
      SINGLE_RUN_MODE: "true"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
          lfs: false
          token: ${{ secrets.FOREX_PAT }}

      - name: Detect Weekend vs Weekday Mode
        id: detect_mode
        run: |
          DAY_OF_WEEK=$(date +%u)
          
          echo "=========================================="
          echo "üóìÔ∏è  DAY DETECTION"
          echo "=========================================="
          echo "Current day: $DAY_OF_WEEK (1=Mon, 7=Sun)"
          echo "Date: $(date +'%A, %B %d, %Y %H:%M UTC')"
          
          if [ $DAY_OF_WEEK -eq 6 ] || [ $DAY_OF_WEEK -eq 7 ]; then
            echo "is_weekend=true" >> $GITHUB_OUTPUT
            echo "execution_mode=weekend_v85_only" >> $GITHUB_OUTPUT
            echo "üéØ MODE: WEEKEND (v8.5 Pipeline Only)"
          elif [ $DAY_OF_WEEK -eq 1 ]; then
            echo "is_weekend=false" >> $GITHUB_OUTPUT
            echo "execution_mode=monday_full" >> $GITHUB_OUTPUT
            echo "üéØ MODE: MONDAY (Full Pipeline)"
          else
            echo "is_weekend=false" >> $GITHUB_OUTPUT
            echo "execution_mode=weekday_smart" >> $GITHUB_OUTPUT
            echo "üéØ MODE: WEEKDAY (Smart Detection)"
          fi
          echo "=========================================="

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install --no-cache-dir \
            pandas numpy requests beautifulsoup4 scikit-learn jupyter nbconvert

      - name: Configure Git
        run: |
          git config --global user.name "${GIT_USER_NAME}"
          git config --global user.email "${GIT_USER_EMAIL}"
          git config --global credential.helper store
          echo "https://${GITHUB_USERNAME}:${FOREX_PAT}@github.com" > ~/.git-credentials

      - name: Check data availability (Weekday Smart Mode Only)
        if: steps.detect_mode.outputs.execution_mode == 'weekday_smart'
        id: check_data
        run: |
          echo "=========================================="
          echo "CHECKING DATA FOR SMART MODE"
          echo "=========================================="
          
          MERGED_PKL_COUNT=$(find . -maxdepth 1 -name "*_2244.pkl" -type f -size +10k 2>/dev/null | wc -l)
          
          echo "üìä Found $MERGED_PKL_COUNT merged pickle files"
          
          if [ $MERGED_PKL_COUNT -ge 4 ]; then
            echo "decision=v85_only" >> $GITHUB_OUTPUT
            echo "‚úÖ DECISION: Run v8.5 only"
          else
            echo "decision=full_pipeline" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  DECISION: Run full pipeline"
          fi
          echo "=========================================="

      - name: Verify data files exist (Weekend/Smart v8.5 mode)
        if: |
          steps.detect_mode.outputs.is_weekend == 'true' || 
          (steps.detect_mode.outputs.execution_mode == 'weekday_smart' && steps.check_data.outputs.decision == 'v85_only')
        run: |
          echo "=========================================="
          echo "VERIFYING DATA FILES"
          echo "=========================================="
          
          PICKLE_COUNT=$(find . -maxdepth 1 -name "*_2244.pkl" -type f 2>/dev/null | wc -l)
          
          if [ $PICKLE_COUNT -lt 4 ]; then
            echo "‚ùå ERROR: Only $PICKLE_COUNT/4 pickle files found"
            echo "Available files:"
            ls -lh *.pkl 2>/dev/null || echo "No pickle files"
            exit 1
          fi
          
          echo "‚úÖ Found all required data files ($PICKLE_COUNT)"
          echo "Files:"
          ls -lh *_2244.pkl
          echo "=========================================="

      - name: Convert notebook and extract v8.5 pipeline
        if: |
          steps.detect_mode.outputs.is_weekend == 'true' || 
          (steps.detect_mode.outputs.execution_mode == 'weekday_smart' && steps.check_data.outputs.decision == 'v85_only')
        run: |
          echo "=========================================="
          echo "EXTRACTING PIPELINE CODE FROM NOTEBOOK"
          echo "=========================================="
          
          # Convert notebook to Python
          jupyter nbconvert --to python "AI_Forex_Brain_2.ipynb" --output ai_forex_brain_2
          
          # Remove IPython magic commands
          sed -i '/get_ipython()/d' ai_forex_brain_2.py
          sed -i '/^get_ipython/d' ai_forex_brain_2.py
          
          # Extract v8.5 pipeline section
          python3 << 'EXTRACT_EOF'
          import re
          
          with open("ai_forex_brain_2.py", "r", encoding="utf-8") as f:
              content = f.read()
          
          # Find v8.5 pipeline (look for the main script marker)
          pattern = r'(#!/usr/bin/env python3.*?""".*?Forex.*?Pipeline.*?v8\.5.*?""".*?if __name__ == "__main__":.*?main\(\))'
          
          match = re.search(pattern, content, re.DOTALL | re.IGNORECASE)
          
          if match:
              pipeline_code = match.group(1)
              
              # Fix paths for GitHub Actions
              pipeline_code = pipeline_code.replace('Path("/content")', 'Path(".")')
              pipeline_code = pipeline_code.replace('"forex-alpha-models"', '"."')
              pipeline_code = pipeline_code.replace('"merged_data_pickles"', '"."')
              pipeline_code = pipeline_code.replace('"forex-ai-models"', '"."')
              
              with open("forex_pipeline_v85.py", "w", encoding="utf-8") as f:
                  f.write(pipeline_code)
              
              print(f"‚úÖ Pipeline extracted ({len(pipeline_code.splitlines())} lines)")
          else:
              print("‚ùå Could not find v8.5 pipeline marker!")
              exit(1)
          EXTRACT_EOF
          
          echo "=========================================="

      - name: Run v8.5 Pipeline Only (Weekend or Data Exists)
        if: |
          steps.detect_mode.outputs.is_weekend == 'true' || 
          (steps.detect_mode.outputs.execution_mode == 'weekday_smart' && steps.check_data.outputs.decision == 'v85_only')
        run: |
          echo "=========================================="
          echo "üü¢ RUNNING v8.5 PIPELINE ONLY"
          echo "=========================================="
          echo "Mode: ${{ steps.detect_mode.outputs.execution_mode }}"
          echo ""
          
          if [ ! -f "forex_pipeline_v85.py" ]; then
            echo "‚ùå ERROR: forex_pipeline_v85.py not found!"
            exit 1
          fi
          
          python forex_pipeline_v85.py 2>&1 | tee pipeline_output.log
          
          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Pipeline failed"
            tail -n 100 pipeline_output.log
            exit $EXIT_CODE
          fi
        timeout-minutes: 20

      - name: Run Full Pipeline (Monday or Missing Data)
        if: |
          steps.detect_mode.outputs.execution_mode == 'monday_full' ||
          (steps.detect_mode.outputs.execution_mode == 'weekday_smart' && steps.check_data.outputs.decision == 'full_pipeline')
        run: |
          echo "=========================================="
          echo "üî¥ RUNNING FULL PIPELINE"
          echo "=========================================="
          echo "Mode: ${{ steps.detect_mode.outputs.execution_mode }}"
          echo ""
          
          # Convert full notebook
          jupyter nbconvert --to python "AI_Forex_Brain_2.ipynb" --output ai_forex_brain_full
          sed -i '/get_ipython()/d' ai_forex_brain_full.py
          
          # Fix paths
          sed -i 's|Path("/content")|Path(".")|g' ai_forex_brain_full.py
          sed -i 's|"forex-alpha-models"|"."|g' ai_forex_brain_full.py
          
          python ai_forex_brain_full.py 2>&1 | tee pipeline_output.log
          
          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Full pipeline failed"
            exit $EXIT_CODE
          fi
        timeout-minutes: 50

      - name: Commit and push changes
        if: always()
        run: |
          git add -A
          
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            MODE="${{ steps.detect_mode.outputs.execution_mode }}"
            git commit -m "ü§ñ Auto-update [$MODE]: $(date +'%Y-%m-%d %H:%M:%S UTC')" || true
            
            # Pull and push with retry
            for i in {1..3}; do
              git pull --rebase origin main && git push origin main && break
              echo "Retry $i failed, waiting..."
              sleep 2
            done
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs-${{ github.run_number }}
          path: |
            pipeline_output.log
            pipeline.log
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "üìä EXECUTION SUMMARY"
          echo "=========================================="
          echo "Mode: ${{ steps.detect_mode.outputs.execution_mode }}"
          echo "Weekend: ${{ steps.detect_mode.outputs.is_weekend }}"
          echo "Date: $(date +'%A, %B %d, %Y %H:%M UTC')"
          echo "=========================================="
