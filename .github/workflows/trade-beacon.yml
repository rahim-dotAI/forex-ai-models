name: AI Forex Trading System

on:
  workflow_dispatch:

  push:
    paths:
      - colab_trigger.txt

  schedule:
    - cron: "*/10 * * * 1-5"

env:
  PYTHON_VERSION: "3.10"
  ENTRY_SCRIPT: "trade_beacon.py"
  MAX_DAILY_TRIGGER_RUNS: "10"

jobs:
  forex-trading:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install holidays jq

      - name: ðŸ” Decide run mode
        id: decide
        shell: bash
        run: |
          set -e

          EVENT="${GITHUB_EVENT_NAME}"
          TODAY="$(date -u +%Y-%m-%d)"
          STATE_FILE="trigger_state.json"

          # Initialize state if missing or invalid
          if [ ! -f "$STATE_FILE" ]; then
            echo "{\"date\":\"$TODAY\",\"trigger_count\":0,\"mode\":\"trigger\"}" > "$STATE_FILE"
          fi

          # Load state safely
          STORED_DATE=$(jq -r '.date // empty' "$STATE_FILE")
          COUNT=$(jq -r '.trigger_count // 0' "$STATE_FILE")
          MODE=$(jq -r '.mode // "trigger"' "$STATE_FILE")

          # Reset at midnight UTC
          if [ "$STORED_DATE" != "$TODAY" ]; then
            COUNT=0
            MODE="trigger"
          fi

          RUN=false

          # Manual run always allowed
          if [ "$EVENT" = "workflow_dispatch" ]; then
            RUN=true
          fi

          # Trigger-file push mode
          if [ "$MODE" = "trigger" ] && [ "$EVENT" = "push" ]; then
            if [ "$COUNT" -lt "$MAX_DAILY_TRIGGER_RUNS" ]; then
              RUN=true
              COUNT=$((COUNT + 1))
              if [ "$COUNT" -ge "$MAX_DAILY_TRIGGER_RUNS" ]; then
                MODE="schedule"
              fi
            fi
          fi

          # Schedule mode
          if [ "$MODE" = "schedule" ] && [ "$EVENT" = "schedule" ]; then
            RUN=true
          fi

          # Save updated state
          echo "{\"date\":\"$TODAY\",\"trigger_count\":$COUNT,\"mode\":\"$MODE\"}" > "$STATE_FILE"

          # Output for GitHub Actions
          echo "run=$RUN" >> "$GITHUB_OUTPUT"
          echo "mode=$MODE" >> "$GITHUB_OUTPUT"

          echo "âœ… State file:"
          cat "$STATE_FILE"

      - name: ðŸ“… Check trading day
        if: steps.decide.outputs.run == 'true'
        id: market
        run: |
          python << 'EOF'
          import datetime, holidays, os

          today = datetime.date.today()
          us = holidays.US()

          skip = today.weekday() >= 5 or today in us

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"skip={'true' if skip else 'false'}\n")
          EOF

      - name: ðŸš€ Run Trading Bot
        if: steps.decide.outputs.run == 'true' && steps.market.outputs.skip != 'true'
        env:
          ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
          BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
          MARKETAUX_API_KEY: ${{ secrets.MARKETAUX_API_KEY }}
        run: |
          python ${{ env.ENTRY_SCRIPT }}

      - name: ðŸ’¾ Commit runtime data
        if: steps.decide.outputs.run == 'true'
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "Trade Beacon Bot"

          git add trigger_state.json logs/ signal_state/ memory/ || true

          if ! git diff --cached --quiet; then
            git commit -m "ðŸ”„ Trade beacon run $(date -u +"%Y-%m-%d %H:%M UTC")"
            git push
          fi

      - name: ðŸ“¦ Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-logs-${{ github.run_number }}
          path: |
            logs/
            signal_state/
            memory/
          if-no-files-found: ignore
