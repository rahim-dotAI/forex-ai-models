name: AI Forex Trading System

on:
  workflow_dispatch:

  push:
    paths:
      - colab_trigger.txt

  schedule:
    - cron: "*/10 * * * 1-5"

env:
  PYTHON_VERSION: "3.10"
  ENTRY_SCRIPT: "trade_beacon.py"
  MAX_DAILY_TRIGGER_RUNS: "10"

jobs:
  forex-trading:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install holidays jq

      - name: ðŸ”¢ Decide if bot should run
        id: decide
        shell: bash
        run: |
          set -e

          EVENT="${GITHUB_EVENT_NAME}"
          TODAY="$(date -u +%Y-%m-%d)"
          STATE_FILE="trigger_state.json"

          RUN=false

          # Initialize state file if missing
          if [ ! -f "$STATE_FILE" ]; then
            echo "{\"date\":\"$TODAY\",\"count\":0}" > "$STATE_FILE"
          fi

          STORED_DATE=$(jq -r '.date' "$STATE_FILE")
          COUNT=$(jq -r '.count' "$STATE_FILE")

          # Reset count at midnight UTC
          if [ "$STORED_DATE" != "$TODAY" ]; then
            COUNT=0
            echo "{\"date\":\"$TODAY\",\"count\":0}" > "$STATE_FILE"
          fi

          # Manual run always allowed
          if [ "$EVENT" = "workflow_dispatch" ]; then
            RUN=true
          fi

          # Scheduled runs always allowed
          if [ "$EVENT" = "schedule" ]; then
            RUN=true
          fi

          # Push trigger (limited per day)
          if [ "$EVENT" = "push" ]; then
            if [ "$COUNT" -lt "$MAX_DAILY_TRIGGER_RUNS" ]; then
              RUN=true
              COUNT=$((COUNT + 1))
              echo "{\"date\":\"$TODAY\",\"count\":$COUNT}" > "$STATE_FILE"
            else
              echo "ðŸš« Daily trigger limit reached ($COUNT)"
            fi
          fi

          echo "run=$RUN" >> "$GITHUB_OUTPUT"

      - name: ðŸ“… Check trading day
        if: steps.decide.outputs.run == 'true'
        id: market
        run: |
          python << 'EOF'
          import datetime, holidays, os

          today = datetime.date.today()
          us = holidays.US()

          if today.weekday() >= 5:
              print("skip=true")
          elif today in us:
              print("skip=true")
          else:
              print("skip=false")

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"skip={'true' if today.weekday() >= 5 or today in us else 'false'}\n")
          EOF

      - name: ðŸš€ Run Trading Bot
        if: steps.decide.outputs.run == 'true' && steps.market.outputs.skip != 'true'
        env:
          ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
          BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
          MARKETAUX_API_KEY: ${{ secrets.MARKETAUX_API_KEY }}
        run: |
          python ${{ env.ENTRY_SCRIPT }}

      - name: ðŸ’¾ Commit runtime data
        if: steps.decide.outputs.run == 'true'
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "Trade Beacon Bot"

          git add trigger_state.json logs/ signal_state/ memory/ || true

          if ! git diff --cached --quiet; then
            git commit -m "ðŸ”„ Trade beacon run $(date -u +"%Y-%m-%d %H:%M UTC")"
            git push
          fi

      - name: ðŸ“¦ Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-logs-${{ github.run_number }}
          path: |
            logs/
            signal_state/
            memory/
          if-no-files-found: ignore
