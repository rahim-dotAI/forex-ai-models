name: AI Forex Trading System

on:
  # Scheduled runs (GitHub timing may lag â€” handled in code)
  schedule:
    - cron: "*/10 * * * 1-5"   # Every 10 minutes, Monâ€“Fri (UTC)

  # Manual run
  workflow_dispatch:
    inputs:
      mode:
        description: 'Trading Mode'
        required: false
        type: choice
        options:
          - default
          - aggressive
          - conservative
        default: 'default'

env:
  PYTHON_VERSION: "3.10"
  ENTRY_SCRIPT: "trade_beacon.py"

jobs:
  forex-trading:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install holidays jq

      # Optional mode override (manual / API trigger)
      - name: âš™ï¸ Apply mode override
        if: github.event.inputs.mode != 'default'
        run: |
          MODE="${{ github.event.inputs.mode }}"
          echo "ðŸŽ¯ Applying mode: $MODE"

          if [ -f config.json ]; then
            jq --arg mode "$MODE" '.mode = $mode' config.json > tmp.json && mv tmp.json config.json
          else
            cat > config.json << 'EOF'
          {
            "mode": "aggressive",
            "settings": {
              "aggressive": {
                "threshold": 30,
                "min_adx": null,
                "rsi_oversold": 40,
                "rsi_overbought": 60
              },
              "conservative": {
                "threshold": 50,
                "min_adx": 20,
                "rsi_oversold": 35,
                "rsi_overbought": 65
              }
            }
          }
          EOF
            jq --arg mode "$MODE" '.mode = $mode' config.json > tmp.json && mv tmp.json config.json
          fi

          cat config.json

      - name: ðŸ“… Check trading day
        id: market
        run: |
          python << 'EOF'
          import datetime, holidays, os

          today = datetime.date.today()
          us = holidays.US()
          skip = today.weekday() >= 5 or today in us

          print("Market open" if not skip else "Market closed")

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"skip={'true' if skip else 'false'}\n")
          EOF

      - name: ðŸ¤– Run Trade Beacon
        if: steps.market.outputs.skip != 'true'
        run: |
          echo "ðŸ¤– Running Trade Beacon..."
          python ${{ env.ENTRY_SCRIPT }}

      # ðŸ”‘ THIS IS THE IMPORTANT PART FOR YOUR DASHBOARD
      - name: ðŸ’¾ Commit dashboard & signals
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "Trade Beacon Bot"

          git add -f signal_state/dashboard_state.json signals.csv config.json || true

          if ! git diff --cached --quiet; then
            git commit -m "ðŸ“Š Trade Beacon update $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
          else
            echo "âœ… No dashboard changes"
          fi

      - name: ðŸ“¦ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trade-beacon-artifacts
          path: |
            signal_state/
            signals.csv
            config.json
          if-no-files-found: ignore
