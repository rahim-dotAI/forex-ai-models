name: AI Forex Trading System

on:
  schedule:
    - cron: "*/10 * * * 1-5"   # Every 10 minutes, Monâ€“Fri
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  ENTRY_SCRIPT: "trade_beacon.py"
  TRIGGER_FILE: "colab_trigger.txt"

jobs:
  forex-trading:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install holidays jq

      - name: ğŸ§  Check trigger file
        id: trigger
        run: |
          if [[ ! -f "${{ env.TRIGGER_FILE }}" ]]; then
            echo "run=false" >> $GITHUB_OUTPUT
            echo "â­ No trigger file found â€” skipping run"
          else
            echo "run=true" >> $GITHUB_OUTPUT
            echo "ğŸš€ Trigger file detected"
          fi

      - name: ğŸ›‘ Exit if no trigger
        if: steps.trigger.outputs.run != 'true'
        run: exit 0

      - name: ğŸ§  Check market status
        run: |
          python << 'EOF'
          from market_status import is_market_open
          if not is_market_open():
              print("âŒ Market closed â€” exiting")
              exit(0)
          print("âœ… Market open")
          EOF

      - name: ğŸ¤– Run Trade Beacon
        run: |
          echo "ğŸ¤– Starting Trade Beacon..."
          python trade_beacon.py

      - name: ğŸ’¾ Commit dashboard & signals
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          git add -f dashboard_state.json signals.csv
          git commit -m "ğŸ”„ Trade update $(date -u '+%Y-%m-%d %H:%M UTC')" || echo "No changes to commit"
          git push

      - name: ğŸ“¦ Upload logs artifact
        uses: actions/upload-artifact@v4
        with:
          name: trading-logs
          path: |
            logs/
            signals.csv
            dashboard_state.json
