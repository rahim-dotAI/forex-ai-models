name: Trade Beacon v2.0.3 - AI Forex Signal Generator

on:
  # Scheduled runs every 15 minutes during market hours (Mon-Fri)
  schedule:
    - cron: "*/15 * * * 1-5"   # Every 15 minutes, Monâ€“Fri (UTC)
  
  # External trigger from cron-job.org for reliability
  repository_dispatch:
    types: [trade-signal-check]
  
  # Manual execution with full configuration
  workflow_dispatch:
    inputs:
      mode:
        description: 'Trading Mode'
        required: false
        type: choice
        options:
          - default
          - aggressive
          - conservative
        default: 'default'
      sentiment:
        description: 'Enable Sentiment Analysis'
        required: false
        type: boolean
        default: false
      force_run:
        description: 'Force run (ignore market hours)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.10"
  ENTRY_SCRIPT: "trade_beacon.py"
  PERFORMANCE_SCRIPT: "performance_tracker.py"

# CRITICAL: Prevent concurrent runs to avoid race conditions
concurrency:
  group: trade-beacon-v2-${{ github.workflow }}
  cancel-in-progress: false  # Wait for previous run to complete

jobs:
  forex-signal-generation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
          # Install system dependencies
          sudo apt-get update && sudo apt-get install -y jq
          
          echo "âœ… Dependencies installed"
          pip list
      
      # Apply mode override for manual/API triggers
      - name: âš™ï¸ Configure trading parameters
        if: github.event.inputs.mode != 'default' && github.event.inputs.mode != ''
        run: |
          MODE="${{ github.event.inputs.mode }}"
          SENTIMENT="${{ github.event.inputs.sentiment }}"
          
          echo "ðŸŽ¯ Configuring Trade Beacon v2.0.3"
          echo "   Mode: $MODE"
          echo "   Sentiment Analysis: $SENTIMENT"
          
          if [ -f config.json ]; then
            # Update existing config
            jq --arg mode "$MODE" --argjson sentiment "$SENTIMENT" \
               '.mode = $mode | .use_sentiment = $sentiment' \
               config.json > tmp.json && mv tmp.json config.json
          else
            # Create new config with v2.0.3 structure
            cat > config.json << 'EOF'
          {
            "mode": "aggressive",
            "use_sentiment": false,
            "settings": {
              "aggressive": {
                "threshold": 48,
                "min_adx": 20,
                "rsi_oversold": 35,
                "rsi_overbought": 65,
                "min_volume_ratio": 1.1,
                "volume_penalty": 10,
                "min_risk_reward": 1.5,
                "atr_stop_multiplier": 2.5,
                "atr_target_multiplier": 5.0,
                "max_correlated_signals": 2,
                "max_signal_age_minutes": 60
              },
              "conservative": {
                "threshold": 58,
                "min_adx": 25,
                "rsi_oversold": 30,
                "rsi_overbought": 70,
                "min_volume_ratio": 1.3,
                "volume_penalty": 15,
                "min_risk_reward": 2.0,
                "atr_stop_multiplier": 3.0,
                "atr_target_multiplier": 6.0,
                "max_correlated_signals": 1,
                "max_signal_age_minutes": 45
              }
            },
            "advanced": {
              "enable_session_filtering": true,
              "enable_correlation_filter": true,
              "enable_performance_optimization": true,
              "cache_ttl_minutes": 5,
              "parallel_workers": 5,
              "session_bonuses": {
                "ASIAN": {
                  "JPY_pairs": 5,
                  "AUD_NZD_pairs": 5,
                  "other": 0
                },
                "EUROPEAN": {
                  "EUR_GBP_pairs": 5,
                  "EUR_GBP_crosses": 3,
                  "other": 0
                },
                "OVERLAP": {
                  "all_major_pairs": 3
                },
                "US": {
                  "USD_majors": 5,
                  "other": 0
                }
              },
              "validation": {
                "max_price_change_pct": 0.05,
                "max_signal_age_seconds": 300,
                "min_sl_pips": {
                  "JPY_pairs": 15,
                  "other": 10
                },
                "max_spread_ratio": 0.3
              }
            },
            "risk_management": {
              "max_daily_risk_pips": 200,
              "max_open_positions": 5,
              "max_correlated_exposure": 2,
              "stop_trading_on_drawdown_pips": 150
            },
            "performance_tuning": {
              "auto_adjust_thresholds": false,
              "min_trades_for_optimization": 30,
              "optimization_interval_days": 7,
              "target_win_rate": 0.55
            }
          }
          EOF
            
            # Apply manual override
            jq --arg mode "$MODE" --argjson sentiment "$SENTIMENT" \
               '.mode = $mode | .use_sentiment = $sentiment' \
               config.json > tmp.json && mv tmp.json config.json
          fi
          
          echo "ðŸ“„ Active configuration:"
          cat config.json | jq '.'
      
      - name: ðŸ“… Validate market hours
        id: market
        run: |
          python << 'EOF'
          import datetime
          import holidays
          import os
          import sys
          
          # Check if force run is enabled
          force_run = "${{ github.event.inputs.force_run }}" == "true"
          
          if force_run:
              print("âš¡ Force run enabled - bypassing market hours check")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("skip=false\n")
                  f.write("status=Force run enabled\n")
              sys.exit(0)
          
          today = datetime.date.today()
          us_holidays = holidays.US()
          
          # Check if weekend
          is_weekend = today.weekday() >= 5
          
          # Check if US holiday
          is_holiday = today in us_holidays
          
          # Determine if we should skip
          should_skip = is_weekend or is_holiday
          
          if should_skip:
              if is_weekend:
                  status = f"Weekend ({today.strftime('%A')})"
              else:
                  status = f"US Holiday: {us_holidays.get(today)}"
              print(f"â­ï¸ Skipping: {status}")
          else:
              status = f"Market open ({today.strftime('%A, %B %d, %Y')})"
              print(f"âœ… {status}")
          
          # Write outputs
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"skip={'true' if should_skip else 'false'}\n")
              f.write(f"status={status}\n")
          EOF
      
      - name: ðŸ” Pre-run diagnostics
        if: steps.market.outputs.skip != 'true'
        run: |
          echo "ðŸ” System Diagnostics:"
          echo "   Python: $(python --version)"
          echo "   Date: $(date -u)"
          echo "   Config exists: $([ -f config.json ] && echo 'Yes' || echo 'No')"
          
          if [ -f signal_state/signal_history.json ]; then
            echo "   Signal history exists: Yes"
            SIGNAL_COUNT=$(jq '.signals | length' signal_state/signal_history.json 2>/dev/null || echo "0")
            echo "   Tracked signals: $SIGNAL_COUNT"
          else
            echo "   Signal history exists: No"
          fi
          
          echo ""
          echo "ðŸ“Š Configuration:"
          if [ -f config.json ]; then
            jq -r '"   Mode: \(.mode)\n   Sentiment: \(.use_sentiment)\n   Threshold (aggressive): \(.settings.aggressive.threshold)\n   Threshold (conservative): \(.settings.conservative.threshold)"' config.json
          fi
      
      - name: ðŸ¤– Execute Trade Beacon v2.0.3
        if: steps.market.outputs.skip != 'true'
        env:
          newsapi_key: ${{ secrets.newsapi_key }}
          MARKETAUX_API_KEY: ${{ secrets.MARKETAUX_API_KEY }}
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸš€ Trade Beacon v2.0.3 - Signal Generator"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          python ${{ env.ENTRY_SCRIPT }}
          EXIT_CODE=$?
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Trade Beacon completed successfully"
          else
            echo "âŒ Trade Beacon exited with code $EXIT_CODE"
            exit $EXIT_CODE
          fi
      
      - name: ðŸ“Š Run performance analysis
        if: steps.market.outputs.skip != 'true'
        continue-on-error: true
        run: |
          echo "ðŸ“Š Analyzing performance metrics..."
          
          if [ -f ${{ env.PERFORMANCE_SCRIPT }} ]; then
            python ${{ env.PERFORMANCE_SCRIPT }} || {
              echo "âš ï¸ Performance analysis failed, continuing..."
            }
          else
            echo "âš ï¸ Performance tracker not found"
          fi
      
      - name: â­ï¸ Skip notification
        if: steps.market.outputs.skip == 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â­ï¸ Run skipped: ${{ steps.market.outputs.status }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ðŸ” Validate outputs
        if: steps.market.outputs.skip != 'true'
        run: |
          echo "ðŸ” Validating generated files..."
          
          # Check dashboard state
          if [ -f signal_state/dashboard_state.json ]; then
            echo "âœ… Dashboard state generated"
            SIGNAL_COUNT=$(jq '.active_signals' signal_state/dashboard_state.json)
            echo "   Active signals: $SIGNAL_COUNT"
          else
            echo "âŒ Dashboard state missing"
            exit 1
          fi
          
          # Check health file
          if [ -f signal_state/health.json ]; then
            echo "âœ… Health check generated"
            STATUS=$(jq -r '.status' signal_state/health.json)
            echo "   System status: $STATUS"
          else
            echo "âš ï¸ Health check missing"
          fi
          
          # Check signal history
          if [ -f signal_state/signal_history.json ]; then
            echo "âœ… Signal history exists"
          else
            echo "âš ï¸ Signal history missing (may be first run)"
          fi
      
      # CRITICAL: Commit and push with advanced conflict resolution
      - name: ðŸ’¾ Commit signals and dashboard
        if: steps.market.outputs.skip != 'true'
        run: |
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # File-based locking with automatic cleanup
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          LOCK_FILE=".github/.trade-beacon-v2.lock"
          LOCK_ACQUIRED=0
          MAX_LOCK_WAIT=120  # 2 minutes
          
          cleanup_lock() {
            if [ $LOCK_ACQUIRED -eq 1 ]; then
              rm -rf "$LOCK_FILE" 2>/dev/null || true
              echo "ðŸ”“ Lock released"
            fi
          }
          
          trap cleanup_lock EXIT INT TERM
          
          # Acquire lock
          echo "ðŸ”’ Acquiring commit lock..."
          for i in $(seq 1 24); do
            if mkdir "$LOCK_FILE" 2>/dev/null; then
              echo "âœ… Lock acquired"
              LOCK_ACQUIRED=1
              break
            fi
            echo "â³ Waiting for lock (attempt $i/24)..."
            sleep 5
          done
          
          if [ $LOCK_ACQUIRED -eq 0 ]; then
            echo "âŒ Failed to acquire lock after ${MAX_LOCK_WAIT}s"
            exit 1
          fi
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Configure Git identity
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "Trade Beacon Bot v2.0.3"
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Stage changes
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "ðŸ“¦ Staging changes..."
          git add -f signal_state/*.json 2>/dev/null || true
          git add -f signals.csv 2>/dev/null || true
          git add -f config.json 2>/dev/null || true
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Commit if changes exist
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if ! git diff --staged --quiet; then
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            MODE=$(jq -r '.mode // "unknown"' config.json 2>/dev/null || echo "unknown")
            SIGNALS=$(jq '.active_signals // 0' signal_state/dashboard_state.json 2>/dev/null || echo "0")
            
            COMMIT_MSG="ðŸ“Š Trade Beacon v2.0.3 | ${MODE} mode | ${SIGNALS} signals | ${TIMESTAMP}

[skip ci]"
            
            git commit -m "$COMMIT_MSG" || {
              echo "âš ï¸ Commit failed, continuing..."
            }
            echo "âœ… Changes committed"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Sync with remote (with conflict resolution)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "ðŸ”„ Syncing with remote..."
          MAX_SYNC_RETRIES=5
          
          for attempt in $(seq 1 $MAX_SYNC_RETRIES); do
            echo "   Sync attempt $attempt/$MAX_SYNC_RETRIES..."
            
            # Fetch latest
            if ! git fetch origin main; then
              echo "âš ï¸ Fetch failed, retrying..."
              sleep 2
              continue
            fi
            
            # Attempt merge
            if git merge origin/main --no-edit -m "Auto-merge: Sync v2.0.3 [skip ci]"; then
              echo "âœ… Merged successfully"
              break
            else
              # Handle conflicts
              if git diff --name-only --diff-filter=U | grep -q .; then
                echo "âš ï¸ Resolving merge conflicts..."
                
                # Keep our version of generated files (they're authoritative)
                git checkout --ours signal_state/ 2>/dev/null || true
                git checkout --ours signals.csv 2>/dev/null || true
                
                # Keep their version of config (manual changes take precedence)
                git checkout --theirs config.json 2>/dev/null || true
                
                git add signal_state/ signals.csv config.json 2>/dev/null || true
                
                if git commit -m "Auto-resolve: Trade Beacon v2.0.3 conflicts [skip ci]"; then
                  echo "âœ… Conflicts resolved"
                  break
                fi
              else
                # Non-conflict merge failure
                if [ $attempt -lt $MAX_SYNC_RETRIES ]; then
                  BACKOFF=$((2 ** attempt))
                  echo "âš ï¸ Merge failed, retrying in ${BACKOFF}s..."
                  git merge --abort 2>/dev/null || true
                  sleep $BACKOFF
                else
                  echo "âŒ Merge failed after $MAX_SYNC_RETRIES attempts"
                  git merge --abort 2>/dev/null || true
                  exit 1
                fi
              fi
            fi
          done
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Push changes with exponential backoff
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "ðŸ“¤ Pushing changes..."
          MAX_PUSH_RETRIES=5
          
          for attempt in $(seq 1 $MAX_PUSH_RETRIES); do
            echo "   Push attempt $attempt/$MAX_PUSH_RETRIES..."
            
            if git push origin main; then
              echo "âœ… Changes pushed successfully"
              break
            else
              if [ $attempt -lt $MAX_PUSH_RETRIES ]; then
                BACKOFF=$((2 ** attempt))
                echo "âš ï¸ Push failed, retrying in ${BACKOFF}s..."
                sleep $BACKOFF
                
                # Re-sync before retry
                git fetch origin main
                git merge origin/main --no-edit -m "Auto-merge: Push retry [skip ci]" || {
                  git merge --abort 2>/dev/null || true
                }
              else
                echo "âš ï¸ Standard push failed, attempting force-with-lease..."
                if git push --force-with-lease origin main; then
                  echo "âœ… Force-pushed successfully (this should be rare)"
                else
                  echo "âŒ All push attempts exhausted"
                  exit 1
                fi
              fi
            fi
          done
      
      - name: ðŸ“¦ Upload workflow artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trade-beacon-v2.0.3-${{ github.run_number }}
          path: |
            signal_state/
            signals.csv
            config.json
          retention-days: 7
          if-no-files-found: warn
      
      - name: ðŸ“Š Workflow summary
        if: always()
        run: |
          echo "## ðŸ“Š Trade Beacon v2.0.3 - Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.market.outputs.skip }}" == "true" ]; then
            echo "**Status:** â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** ${{ steps.market.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âœ… Completed" >> $GITHUB_STEP_SUMMARY
            
            if [ -f signal_state/dashboard_state.json ]; then
              MODE=$(jq -r '.mode // "unknown"' signal_state/dashboard_state.json)
              SIGNALS=$(jq '.active_signals // 0' signal_state/dashboard_state.json)
              WIN_RATE=$(jq '.stats.win_rate // 0' signal_state/dashboard_state.json)
              TOTAL_PIPS=$(jq '.stats.total_pips // 0' signal_state/dashboard_state.json)
              
              echo "**Mode:** $MODE" >> $GITHUB_STEP_SUMMARY
              echo "**Active Signals:** $SIGNALS" >> $GITHUB_STEP_SUMMARY
              echo "**Win Rate:** ${WIN_RATE}%" >> $GITHUB_STEP_SUMMARY
              echo "**Total Pips:** $TOTAL_PIPS" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -f signal_state/health.json ]; then
              HEALTH=$(jq -r '.status // "unknown"' signal_state/health.json)
              echo "**System Health:** $HEALTH" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
