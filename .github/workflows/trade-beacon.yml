name: Trade Beacon v2.0.6 â€“ Forex Signal Generator

on:
  schedule:
    - cron: "*/15 * * * 1-5"

  repository_dispatch:
    types: [trade-signal-check, performance-check]

  workflow_dispatch:
    inputs:
      mode:
        description: 'Trading Mode'
        required: false
        type: choice
        options: [default, aggressive, conservative]
        default: 'default'
      sentiment:
        description: 'Enable Sentiment Analysis'
        required: false
        type: boolean
        default: false
      run_backtest:
        description: 'Run Backtest (optional)'
        required: false
        type: boolean
        default: false
      reset_performance:
        description: 'Reset Performance History (DANGER)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.10"
  ENTRY_SCRIPT: "trade_beacon.py"
  PERFORMANCE_SCRIPT: "performance_tracker.py"

concurrency:
  group: trade-beacon-v2-${{ github.workflow }}
  cancel-in-progress: false

jobs:
  forex-trading:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update && sudo apt-get install -y jq bc

      - name: ğŸ“‹ Verify system files
        run: |
          for f in ${{ env.ENTRY_SCRIPT }} ${{ env.PERFORMANCE_SCRIPT }} requirements.txt; do
            [ -f "$f" ] || { echo "âŒ Missing $f"; exit 1; }
          done
          mkdir -p signal_state
          echo "âœ… System verified"

      # v2.0.6 CONFIGURATION
      - name: âš™ï¸ Apply v2.0.6 configuration
        if: github.event.inputs.mode != 'default' && github.event.inputs.mode != ''
        run: |
          MODE="${{ github.event.inputs.mode }}"
          SENTIMENT="${{ github.event.inputs.sentiment }}"

          jq --arg mode "$MODE" --argjson sentiment "$SENTIMENT" '
          .mode = $mode |
          .use_sentiment = $sentiment |
          .settings.aggressive.threshold = 42 |
          .settings.aggressive.min_adx = 15 |
          .settings.aggressive.min_volume_ratio = 1.0 |
          .settings.conservative.threshold = 55 |
          .settings.conservative.min_adx = 22 |
          .settings.conservative.min_volume_ratio = 1.2 |
          .advanced.validation.max_signal_age_seconds = 600 |
          .advanced.validation.min_sl_pips = {"JPY_pairs":12,"other":7} |
          .advanced.session_bonuses.LATE_US = {"all_major_pairs":0} |
          .performance_tuning.auto_adjust_thresholds = false |
          .performance_tracking.equity_curve = {"enabled": false}
          ' config.json > tmp.json && mv tmp.json config.json

          echo "ğŸ“„ v2.0.6 configuration applied"
          jq '.' config.json

      - name: ğŸ¤– Run Trade Beacon v2.0.6
        env:
          newsapi_key: ${{ secrets.newsapi_key }}
          MARKETAUX_API_KEY: ${{ secrets.MARKETAUX_API_KEY }}
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
        run: |
          echo "ğŸš€ Trade Beacon v2.0.6"
          python ${{ env.ENTRY_SCRIPT }}

      - name: ğŸ“Š Optional Backtest (Disabled until validation)
        if: github.event.inputs.run_backtest == 'true'
        run: |
          echo "âš ï¸ Backtest enabled"
          python backtest.py || echo "âš ï¸ Backtest failed or not implemented"

      - name: ğŸ” Validate outputs
        run: |
          jq '.active_signals' signal_state/dashboard_state.json
          jq '.status' signal_state/health.json

      - name: ğŸ’¾ Commit state
        run: |
          git config user.name "Trade Beacon v2.0.6"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add signal_state/*.json signals.csv config.json || true
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ“Š Trade Beacon v2.0.6 | Signals update [skip ci]"
            git push origin main
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: ğŸ“¦ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trade-beacon-v2.0.6-run-${{ github.run_number }}
          path: |
            signal_state/
            signals.csv
            config.json
          retention-days: 7
