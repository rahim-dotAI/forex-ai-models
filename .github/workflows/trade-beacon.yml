name: Trade Beacon v2.1.2 ‚Äì Forex Signal Generator

on:
  schedule:
    # Run every 15 minutes during market hours (Mon-Fri)
    - cron: "*/15 * * * 1-5"
  
  repository_dispatch:
    types: [trade-signal-check, performance-check]
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'Trading Mode'
        required: false
        type: choice
        options: [default, aggressive, conservative]
        default: 'default'
      
      sentiment:
        description: 'Enable Sentiment Analysis'
        required: false
        type: boolean
        default: false
      
      run_backtest:
        description: 'Run Backtest'
        required: false
        type: boolean
        default: false
      
      reset_performance:
        description: 'RESET PERFORMANCE (type YES to confirm)'
        required: false
        default: 'NO'
      
      allow_optimization:
        description: 'ALLOW threshold optimization (if min trades met)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.10"
  ENTRY_SCRIPT: "trade_beacon.py"

concurrency:
  group: trade-beacon-v2.1.2-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  forex-trading:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python environment
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: requirements.txt
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update && sudo apt-get install -y jq bc
      
      - name: Verify system files
        run: |
          echo "üîç Verifying critical files..."
          for f in $ENTRY_SCRIPT requirements.txt performance_tracker.py config.json; do
            if [ ! -f "$f" ]; then
              echo "‚ùå Missing critical file: $f"
              exit 1
            fi
          done
          echo "‚úÖ All critical files present"
          
          # Ensure directories exist
          mkdir -p signal_state
          
          # Verify Python syntax
          python -m py_compile $ENTRY_SCRIPT
          python -m py_compile performance_tracker.py
          echo "‚úÖ Python syntax validation passed"
      
      - name: Validate tracker version alignment
        run: |
          echo "üîç Validating PerformanceTracker version..."
          TRACKER_VER=$(python -c "from performance_tracker import TRACKER_VERSION; print(TRACKER_VERSION)" 2>/dev/null || echo "unknown")
          BEACON_VER=$(grep -oP '"signal_generator_version": "\K[0-9.]+' $ENTRY_SCRIPT | head -1 || echo "unknown")
          
          echo "Tracker version: $TRACKER_VER"
          echo "Beacon version: $BEACON_VER"
          
          if [ "$TRACKER_VER" != "$BEACON_VER" ]; then
            echo "‚ö†Ô∏è  Version mismatch detected (non-fatal)"
          else
            echo "‚úÖ Versions aligned: $TRACKER_VER"
          fi
      
      - name: Validate configuration
        run: |
          echo "üîç Validating config.json..."
          jq empty config.json || exit 1
          
          # Check required config fields
          jq -e '.mode' config.json > /dev/null || exit 1
          jq -e '.settings' config.json > /dev/null || exit 1
          
          # Snapshot original config for forensic baseline (once)
          if [ ! -f config.runtime.base.json ]; then
            cp config.json config.runtime.base.json
            git add config.runtime.base.json 2>/dev/null || true
            echo "üì∏ Created config baseline snapshot"
          fi
          
          echo "‚úÖ Configuration valid"
      
      - name: Reset performance history (DESTRUCTIVE - guarded)
        if: github.event.inputs.reset_performance == 'YES'
        run: |
          echo "‚ö†Ô∏è  PERFORMANCE RESET INITIATED"
          rm -f signal_state/signal_history.json
          rm -f signal_state/last_optimization.json
          rm -f signal_state/dashboard_state.json
          rm -f signal_state/trading_paused.json
          echo "üî• PERFORMANCE RESET COMPLETE - All history cleared"
      
      - name: Clean stale pause files
        run: |
          echo "üßπ Checking for stale pause files..."
          
          if [ -f signal_state/trading_paused.json ]; then
            PAUSED_UNTIL=$(jq -r '.paused_until // "unknown"' signal_state/trading_paused.json)
            
            if [ "$PAUSED_UNTIL" != "unknown" ]; then
              # Convert to timestamp for comparison
              PAUSE_TS=$(date -d "$PAUSED_UNTIL" +%s 2>/dev/null || echo "0")
              NOW_TS=$(date +%s)
              
              if [ "$NOW_TS" -gt "$PAUSE_TS" ]; then
                echo "‚ö†Ô∏è  Found expired pause file (until: $PAUSED_UNTIL)"
                rm -f signal_state/trading_paused.json
                echo "‚úÖ Stale pause file removed"
              else
                echo "‚è∏Ô∏è  Valid pause active until: $PAUSED_UNTIL"
              fi
            fi
          else
            echo "‚úÖ No pause file present"
          fi
      
      - name: Apply runtime overrides
        if: github.event.inputs.mode != 'default' && github.event.inputs.mode != '' && github.event.inputs.sentiment != ''
        run: |
          echo "‚öôÔ∏è  Applying runtime configuration..."
          
          MODE="${{ github.event.inputs.mode }}"
          SENTIMENT="${{ github.event.inputs.sentiment }}"
          
          # Use default from config if not specified or empty
          if [ -z "$MODE" ] || [ "$MODE" = "default" ]; then
            MODE=$(jq -r '.mode' config.json)
          fi
          
          # Default sentiment to false if empty
          if [ -z "$SENTIMENT" ]; then
            SENTIMENT="false"
          fi
          
          jq \
            --arg mode "$MODE" \
            --argjson sentiment "$SENTIMENT" \
            '.mode = $mode | .use_sentiment = $sentiment' \
            config.json > tmp.json && mv tmp.json config.json
          
          echo "‚úÖ Configuration updated: mode=$MODE, sentiment=$SENTIMENT"
      
      - name: Allow threshold optimization (if eligible)
        if: github.event.inputs.allow_optimization == 'true'
        run: |
          echo "üîß Allowing threshold optimization..."
          jq '.performance_tuning.auto_adjust_thresholds = true' \
            config.json > tmp.json && mv tmp.json config.json
          
          # Reset last optimization timestamp to allow immediate run
          rm -f signal_state/last_optimization.json
          
          echo "‚úÖ Optimization enabled (will run if min_trades_for_optimization met)"
          echo "‚ÑπÔ∏è  Note: Actual optimization depends on:"
          echo "   - Minimum trade count threshold"
          echo "   - Time since last optimization"
          echo "   - Performance below target expectancy"
          
          # Log eligibility criteria for forensics
          MIN_TRADES=$(jq -r '.performance_tuning.min_trades_for_optimization // 50' config.json)
          CURRENT_TRADES=$(jq -r '.stats.total_trades // 0' signal_state/signal_history.json 2>/dev/null || echo "0")
          
          echo "üìä Optimization eligibility:"
          echo "   Current trades: $CURRENT_TRADES"
          echo "   Required trades: $MIN_TRADES"
          
          if [ "$CURRENT_TRADES" -ge "$MIN_TRADES" ]; then
            echo "   ‚úÖ Trade count threshold MET"
          else
            echo "   ‚ö†Ô∏è  Trade count threshold NOT MET (need $((MIN_TRADES - CURRENT_TRADES)) more)"
          fi
      
      - name: Pre-run health check
        run: |
          echo "üè• Running pre-flight health check..."
          
          # Check if system is paused and exit early if so
          if [ -f signal_state/trading_paused.json ]; then
            PAUSED_UNTIL=$(jq -r '.paused_until // "unknown"' signal_state/trading_paused.json)
            echo "‚õî Trading is currently paused until: $PAUSED_UNTIL"
            echo "‚õî Skipping execution to prevent signal emission during cooldown"
            
            # Create status report
            echo "paused" > signal_state/run_status.txt
            echo "System paused - no execution" >> signal_state/run_status.txt
            
            exit 0
          fi
          
          # Display current performance if available
          if [ -f signal_state/signal_history.json ]; then
            echo "üìä Current Performance:"
            jq -r '.stats | "Total Trades: \(.total_trades // 0) | Win Rate: \(.win_rate // 0)% | Total Pips: \(.total_pips // 0) | Expectancy: \(.expectancy_pips // 0)"' \
              signal_state/signal_history.json || echo "No stats available yet"
          fi
          
          echo "‚úÖ Pre-flight check complete - system ready"
      
      - name: Run Trade Beacon v2.1.2
        env:
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          MARKETAUX_API_KEY: ${{ secrets.MARKETAUX_API_KEY }}
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
        run: |
          echo "üöÄ Starting Trade Beacon v2.1.2..."
          python $ENTRY_SCRIPT
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Trade Beacon exited with error code: $EXIT_CODE"
            exit $EXIT_CODE
          fi
          
          echo "‚úÖ Trade Beacon completed successfully"
          
          # Log optimization decision if optimization was allowed
          if [ -f signal_state/last_optimization.json ]; then
            echo ""
            echo "üìä Optimization Decision:"
            jq -r '"Reason: \(.reason // "N/A")\nOld Threshold: \(.old_threshold // "N/A")\nNew Threshold: \(.new_threshold // "N/A")"' \
              signal_state/last_optimization.json || echo "Optimization data not available"
          elif [ "${{ github.event.inputs.allow_optimization }}" == "true" ]; then
            echo ""
            echo "‚ÑπÔ∏è  Optimization was ALLOWED but NOT EXECUTED"
            echo "   Possible reasons:"
            
            CURRENT_TRADES=$(jq -r '.stats.total_trades // 0' signal_state/signal_history.json 2>/dev/null || echo "0")
            MIN_TRADES=$(jq -r '.performance_tuning.min_trades_for_optimization // 50' config.json)
            
            if [ "$CURRENT_TRADES" -lt "$MIN_TRADES" ]; then
              echo "   ‚ùå Not enough trades ($CURRENT_TRADES < $MIN_TRADES)"
            fi
            
            # Check if interval was met (14 days default)
            if [ -f signal_state/last_optimization.json.backup ]; then
              LAST_OPT=$(jq -r '.timestamp // ""' signal_state/last_optimization.json.backup 2>/dev/null || echo "")
              if [ -n "$LAST_OPT" ]; then
                echo "   ‚ö†Ô∏è  Optimization interval not met (last run: $LAST_OPT)"
              fi
            fi
            
            EXPECTANCY=$(jq -r '.stats.expectancy_pips // 0' signal_state/signal_history.json 2>/dev/null || echo "0")
            MIN_EXPECTANCY=$(jq -r '.performance_tuning.optimization_inputs.min_expectancy // 0.5' config.json)
            
            if (( $(echo "$EXPECTANCY >= $MIN_EXPECTANCY" | bc -l) )); then
              echo "   ‚úÖ Expectancy above threshold ($EXPECTANCY >= $MIN_EXPECTANCY)"
            fi
          fi
      
      - name: Validate output files
        if: always()
        run: |
          echo "üîç Validating output files..."
          
          # Check dashboard state
          if [ -f signal_state/dashboard_state.json ]; then
            jq empty signal_state/dashboard_state.json || exit 1
            echo "‚úÖ Dashboard state valid"
          else
            echo "‚ö†Ô∏è  Dashboard state not found"
          fi
          
          # Check health file
          if [ -f signal_state/health.json ]; then
            jq empty signal_state/health.json || exit 1
            STATUS=$(jq -r '.status // "unknown"' signal_state/health.json)
            echo "üìä System health: $STATUS"
          fi
      
      - name: Optional backtest
        if: github.event.inputs.run_backtest == 'true'
        run: |
          echo "üß™ Running backtest..."
          if [ -f backtest.py ]; then
            python backtest.py || echo "‚ö†Ô∏è  Backtest failed, continuing..."
          else
            echo "‚ö†Ô∏è  backtest.py not found, skipping..."
          fi
      
      - name: Display comprehensive performance summary
        if: always()
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä TRADE BEACON v2.1.2 PERFORMANCE SUMMARY"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          if [ -f signal_state/signal_history.json ]; then
            echo ""
            echo "üìà Overall Statistics:"
            jq -r '.stats | 
              "Total Trades: \(.total_trades // 0)\n" +
              "Resolved: \(.total_resolved // 0)\n" +
              "Wins: \(.wins // 0)\n" +
              "Losses: \(.losses // 0)\n" +
              "Expired: \(.expired // 0)\n" +
              "Win Rate: \(.win_rate // 0)%\n" +
              "Total Pips: \(.total_pips // 0)\n" +
              "Avg Win: \(.avg_win // 0) pips\n" +
              "Avg Loss: \(.avg_loss // 0) pips\n" +
              "Expectancy: \(.expectancy_pips // 0) pips/trade\n" +
              "Validated: \(.validated // false)"' \
              signal_state/signal_history.json || echo "Stats not available"
            
            echo ""
            echo "üìä Analytics by Session:"
            jq -r '.analytics.by_session // {} | to_entries[] | 
              "\(.key): \(.value.trades // 0) trades, \(.value.win_rate // 0)% WR, \(.value.total_pips // 0) pips"' \
              signal_state/signal_history.json 2>/dev/null || echo "No session data"
            
            echo ""
            echo "üéØ Analytics by Confidence:"
            jq -r '.analytics.by_confidence // {} | to_entries[] | 
              "\(.key): \(.value.trades // 0) trades, \(.value.win_rate // 0)% WR, \(.value.total_pips // 0) pips"' \
              signal_state/signal_history.json 2>/dev/null || echo "No confidence data"
          else
            echo "‚ö†Ô∏è  No performance history available yet"
          fi
          
          echo ""
          if [ -f signal_state/dashboard_state.json ]; then
            echo "üîî Active Signals:"
            jq -r '.active_signals // 0' signal_state/dashboard_state.json || echo "0"
            
            echo ""
            echo "üì° System Status:"
            jq -r '.system | 
              "Version: \(.version // "unknown")\n" +
              "Signal Only Mode: \(.signal_only_mode // true)\n" +
              "Performance Tracking: \(.performance_tracking_enabled // false)\n" +
              "Optimization: \(.optimization_enabled // false)"' \
              signal_state/dashboard_state.json || echo "Status not available"
          fi
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      
      - name: Check for alerts
        if: always()
        run: |
          if [ -f signal_state/health.json ]; then
            STATUS=$(jq -r '.status // "unknown"' signal_state/health.json)
            
            if [ "$STATUS" = "paused" ]; then
              echo "‚ö†Ô∏è  ALERT: Trading is PAUSED"
              jq -r '.issues // [] | .[]' signal_state/health.json 2>/dev/null || echo "No issue details"
            elif [ "$STATUS" = "warning" ]; then
              echo "‚ö†Ô∏è  WARNING: System issues detected"
              jq -r '.issues // [] | .[]' signal_state/health.json 2>/dev/null || echo "No issue details"
            elif [ "$STATUS" != "ok" ]; then
              echo "‚ùå ERROR: System in bad state: $STATUS"
              jq -r '.issues // [] | .[]' signal_state/health.json 2>/dev/null || echo "No issue details"
            fi
          fi
      
      - name: Commit state changes
        run: |
          git config user.name "Trade Beacon v2.1.2 [bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add all state files (including baseline snapshot if new)
          git add signal_state/*.json config.json config.runtime.base.json signals.csv 2>/dev/null || true
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            # Create detailed commit message with safe fallbacks
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            ACTIVE=$(jq -r '.active_signals // 0' signal_state/dashboard_state.json 2>/dev/null || echo "0")
            SESSION=$(jq -r '.session // "UNKNOWN"' signal_state/dashboard_state.json 2>/dev/null || echo "UNKNOWN")
            
            git commit -m "üìä Trade Beacon v2.1.2 update [$TIMESTAMP]
            
            Session: $SESSION
            Active Signals: $ACTIVE
            Run: #${{ github.run_number }}
            
            [skip ci]"
            
            echo "‚úÖ Changes committed"
          fi
      
      - name: Push changes
        run: |
          git push origin HEAD:main || {
            echo "‚ö†Ô∏è  Push failed, will retry on next run"
            exit 0
          }
          echo "‚úÖ Changes pushed to repository"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trade-beacon-v2.1.2-run-${{ github.run_number }}
          path: |
            signal_state/
            signals.csv
            config.json
          retention-days: 30
          compression-level: 9
