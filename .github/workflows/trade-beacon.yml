name: AI Forex Trading System

on:
  # Scheduled runs (GitHub timing may lag ‚Äî handled in code)
  schedule:
    - cron: "*/15 * * * 1-5"   # Every 15 minutes, Mon‚ÄìFri (UTC)
  
  # External trigger from cron-job.org (IMPORTANT!)
  repository_dispatch:
    types: [trade-signal-check]
  
  # Manual run
  workflow_dispatch:
    inputs:
      mode:
        description: 'Trading Mode'
        required: false
        type: choice
        options:
          - default
          - aggressive
          - conservative
        default: 'default'
      sentiment:
        description: 'Enable Sentiment Analysis'
        required: false
        type: boolean
        default: true

env:
  PYTHON_VERSION: "3.10"
  ENTRY_SCRIPT: "trade_beacon.py"

# CRITICAL: Concurrency control to prevent race conditions
concurrency:
  group: trade-beacon-${{ github.workflow }}
  cancel-in-progress: false  # Wait for previous run to finish

jobs:
  forex-trading:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Install jq as system package (not Python package)
          sudo apt-get update && sudo apt-get install -y jq
      
      # Optional mode override (manual / API trigger)
      - name: ‚öôÔ∏è Apply mode override
        if: github.event.inputs.mode != 'default' && github.event.inputs.mode != ''
        run: |
          MODE="${{ github.event.inputs.mode }}"
          SENTIMENT="${{ github.event.inputs.sentiment }}"
          echo "üéØ Applying mode: $MODE"
          echo "üì∞ Sentiment analysis: $SENTIMENT"
          
          if [ -f config.json ]; then
            jq --arg mode "$MODE" --argjson sentiment "$SENTIMENT" \
               '.mode = $mode | .use_sentiment = $sentiment' \
               config.json > tmp.json && mv tmp.json config.json
          else
            echo "Creating new config.json with mode: $MODE"
            cat > config.json << EOF
          {
            "mode": "$MODE",
            "use_sentiment": ${SENTIMENT:-true},
            "settings": {
              "aggressive": {
                "threshold": 30,
                "min_adx": 15,
                "rsi_oversold": 45,
                "rsi_overbought": 55,
                "min_volume_ratio": 0.8,
                "volume_penalty": 5
              },
              "conservative": {
                "threshold": 50,
                "min_adx": 20,
                "rsi_oversold": 35,
                "rsi_overbought": 65,
                "min_volume_ratio": 1.0,
                "volume_penalty": 10
              }
            }
          }
          EOF
          fi
          
          echo "üìÑ Current config.json:"
          cat config.json
      
      - name: üìÖ Check trading day
        id: market
        run: |
          python << 'EOF'
          import datetime, holidays, os
          
          today = datetime.date.today()
          us = holidays.US()
          skip = today.weekday() >= 5 or today in us
          
          status = "Market closed" if skip else "Market open"
          print(status)
          
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"skip={'true' if skip else 'false'}\n")
              f.write(f"status={status}\n")
          EOF
      
      - name: ü§ñ Run Trade Beacon
        if: steps.market.outputs.skip != 'true'
        env:
          newsapi_key: ${{ secrets.newsapi_key }}
          MARKETAUX_API_KEY: ${{ secrets.MARKETAUX_API_KEY }}
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
        run: |
          echo "ü§ñ Running Trade Beacon v2.0..."
          python ${{ env.ENTRY_SCRIPT }}
      
      - name: ‚è≠Ô∏è Skip message
        if: steps.market.outputs.skip == 'true'
        run: |
          echo "‚è≠Ô∏è Skipping run: ${{ steps.market.outputs.status }}"
      
      # üîë CRITICAL: Commit dashboard & signals with improved error handling
      - name: üíæ Commit dashboard & signals
        if: steps.market.outputs.skip != 'true'
        run: |
          # File-based locking mechanism with proper cleanup
          LOCK_FILE=".github/.trade-beacon.lock"
          LOCK_ACQUIRED=0
          
          # Cleanup function
          cleanup_lock() {
            if [ $LOCK_ACQUIRED -eq 1 ]; then
              rm -rf "$LOCK_FILE" 2>/dev/null || true
              echo "üîì Lock released"
            fi
          }
          
          # Set trap for cleanup on exit
          trap cleanup_lock EXIT INT TERM
          
          # Wait for lock (max 2 minutes)
          echo "üîí Acquiring lock..."
          for i in {1..24}; do
            if mkdir "$LOCK_FILE" 2>/dev/null; then
              echo "‚úÖ Lock acquired"
              LOCK_ACQUIRED=1
              break
            fi
            echo "‚è≥ Waiting for lock... (attempt $i/24)"
            sleep 5
          done
          
          if [ $LOCK_ACQUIRED -eq 0 ]; then
            echo "‚ùå Failed to acquire lock after 2 minutes"
            exit 1
          fi
          
          # Configure Git
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "Trade Beacon Bot"
          
          # Stage changes
          git add -f signal_state/*.json signals.csv config.json 2>/dev/null || true
          
          # Commit if changes exist
          if ! git diff --staged --quiet; then
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')
            git commit -m "üìä Trade Beacon v2.0 update ${TIMESTAMP} [skip ci]" || {
              echo "‚ö†Ô∏è Commit failed, continuing..."
            }
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi
          
          # Pull and merge latest changes
          echo "üîÑ Syncing with remote..."
          MAX_RETRIES=5
          
          for i in $(seq 1 $MAX_RETRIES); do
            git fetch origin main || {
              echo "‚ö†Ô∏è Fetch failed, retrying..."
              sleep 2
              continue
            }
            
            if git merge origin/main --no-edit -m "Auto-merge: Sync [skip ci]"; then
              echo "‚úÖ Merged successfully"
              break
            else
              # Handle merge conflicts
              if git diff --name-only --diff-filter=U | grep -q .; then
                echo "‚ö†Ô∏è Resolving conflicts..."
                
                # Keep our version of generated files
                git checkout --ours signal_state/ 2>/dev/null || true
                git checkout --ours signals.csv 2>/dev/null || true
                git checkout --ours config.json 2>/dev/null || true
                
                git add signal_state/ signals.csv config.json 2>/dev/null || true
                git commit -m "Auto-merge: Resolved conflicts [skip ci]" || true
                echo "‚úÖ Conflicts resolved"
                break
              else
                if [ $i -lt $MAX_RETRIES ]; then
                  WAIT=$((2 ** i))
                  echo "‚ö†Ô∏è Merge failed, retrying in ${WAIT}s..."
                  sleep $WAIT
                  git merge --abort 2>/dev/null || true
                else
                  echo "‚ùå Merge failed after $MAX_RETRIES attempts"
                  git merge --abort 2>/dev/null || true
                  exit 1
                fi
              fi
            fi
          done
          
          # Push changes with retry
          echo "üîÑ Pushing changes..."
          for i in $(seq 1 5); do
            if git push origin main; then
              echo "‚úÖ Pushed successfully"
              break
            else
              if [ $i -lt 5 ]; then
                WAIT=$((2 ** i))
                echo "‚ö†Ô∏è Push failed, retrying in ${WAIT}s..."
                sleep $WAIT
                
                # Re-sync before retry
                git fetch origin main
                git merge origin/main --no-edit -m "Auto-merge: Retry [skip ci]" || {
                  git merge --abort 2>/dev/null || true
                }
              else
                echo "‚ö†Ô∏è Standard push failed, trying force-with-lease..."
                if git push --force-with-lease origin main; then
                  echo "‚úÖ Force-pushed (this should be rare)"
                else
                  echo "‚ùå All push attempts failed"
                  exit 1
                fi
              fi
            fi
          done
      
      - name: üì¶ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trade-beacon-v2-${{ github.run_number }}
          path: |
            signal_state/
            signals.csv
            config.json
          retention-days: 7
          if-no-files-found: ignore
