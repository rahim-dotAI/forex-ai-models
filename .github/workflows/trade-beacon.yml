name: AI Forex Trading System

on:
  workflow_dispatch:
  push:
    paths:
      - 'colab_trigger.txt'
  schedule:
    - cron: "*/10 0-23 * * 1-5"  # fallback schedule after trigger limit reached (UTC)

env:
  PYTHON_VERSION: "3.10"
  ENTRY_SCRIPT: "trade_beacon.py"
  MAX_RUNS_PER_DAY: 10

jobs:
  forex-trading:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install holidays jq

      - name: üî¢ Determine if trigger should run
        id: trigger_count
        run: |
          set -e
          TRIGGER_RUN=false
          TODAY=$(date -u +%Y-%m-%d)
          COUNT_FILE="trigger_count.json"

          # Initialize count file if not exists
          if [ ! -f "$COUNT_FILE" ]; then
            echo "{}" > "$COUNT_FILE"
          fi

          # Get today's run count
          TODAY_COUNT=$(jq -r --arg day "$TODAY" '.[$day] // 0' "$COUNT_FILE")

          echo "‚ÑπÔ∏è Today's trigger count: $TODAY_COUNT"

          # Check event type
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            TRIGGER_RUN=true
          elif [[ "$GITHUB_EVENT_NAME" == "push" ]]; then
            FILE_CHANGED=$(jq -r '[.commits[].modified[]?, .commits[].added[]?] | .[]' "$GITHUB_EVENT_PATH" || true)
            if echo "$FILE_CHANGED" | grep -q 'colab_trigger.txt'; then
              TRIGGER_RUN=true
            fi
          elif [[ "$GITHUB_EVENT_NAME" == "schedule" ]]; then
            TRIGGER_RUN=true
          fi

          # Only allow triggers if count < MAX_RUNS
          if [[ $TODAY_COUNT -ge $MAX_RUNS_PER_DAY ]]; then
            TRIGGER_RUN=false
          fi

          echo "trigger_run=$TRIGGER_RUN" >> $GITHUB_OUTPUT

      - name: üìÖ Check trading day
        id: check_market
        run: |
          python << 'EOF'
import datetime, holidays, os, sys

today = datetime.date.today()
us = holidays.US()
github_output = os.environ.get('GITHUB_OUTPUT', '')

if today.weekday() >= 5 or today in us:
    print(f"üö´ Market closed ({'Weekend' if today.weekday() >= 5 else 'Holiday'})")
    if github_output:
        with open(github_output, 'a') as f:
            f.write("skip=true\n")
    sys.exit(0)

print("‚úÖ Market open")
if github_output:
    with open(github_output, 'a') as f:
        f.write("skip=false\n")
EOF

      - name: üöÄ Run Trading Bot
        if: steps.trigger_count.outputs.trigger_run == 'true' && steps.check_market.outputs.skip != 'true'
        env:
          ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
          BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
          MARKETAUX_API_KEY: ${{ secrets.MARKETAUX_API_KEY }}
        run: python ${{ env.ENTRY_SCRIPT }}

      - name: üíæ Commit live trading data
        if: steps.trigger_count.outputs.trigger_run == 'true' && steps.check_market.outputs.skip != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "Trade Beacon Bot"

          git add -f signal_state/*.json 2>/dev/null || true
          git add -f memory/*.json 2>/dev/null || true
          git add -f logs/*.log 2>/dev/null || true

          if ! git diff --staged --quiet; then
            timestamp=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "üîÑ Live signal update - ${timestamp}"
            git push
            echo "‚úÖ Data committed and pushed"
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi

      - name: üîÅ Update daily trigger count and disable push if max reached
        if: steps.trigger_count.outputs.trigger_run == 'true'
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          COUNT_FILE="trigger_count.json"

          # Increment count
          TODAY_COUNT=$(jq -r --arg day "$TODAY" '.[$day] // 0' "$COUNT_FILE")
          NEW_COUNT=$((TODAY_COUNT + 1))
          jq --arg day "$TODAY" --argjson count $NEW_COUNT '.[$day]=$count' "$COUNT_FILE" > tmp.json && mv tmp.json "$COUNT_FILE"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "Trade Beacon Bot"
          git add "$COUNT_FILE"

          # Disable push trigger if max reached
          if [[ $NEW_COUNT -ge $MAX_RUNS_PER_DAY ]]; then
            echo "üîí Max runs reached today, disabling push trigger in YAML"
            yq eval '.on.push = null' -i .github/workflows/forex-trading.yml
            git add .github/workflows/forex-trading.yml
          fi

          if ! git diff --staged --quiet; then
            git commit -m "üîÑ Updated trigger count and workflow triggers"
            git push
          fi

      - name: üîÑ Re-enable push trigger at midnight UTC
        if: always()
        run: |
          HOUR=$(date -u +%H)
          if [[ "$HOUR" == "00" ]]; then
            echo "‚è∞ Midnight UTC ‚Äì re-enabling push trigger"
            yq eval '.on.push = {"paths":["colab_trigger.txt"]}' -i .github/workflows/forex-trading.yml
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "Trade Beacon Bot"
            git add .github/workflows/forex-trading.yml
            if ! git diff --staged --quiet; then
              git commit -m "üîÑ Re-enabled push trigger for new day"
              git push
            fi
          fi

      - name: üì¶ Upload logs (backup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-logs-${{ github.run_number }}
          path: |
            logs/
            signal_state/
            memory/
          retention-days: 7
          if-no-files-found: ignore
