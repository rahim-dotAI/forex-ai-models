name: Trade Beacon v2.0.6 â€“ Forex Signal Generator

on:
  schedule:
    - cron: "*/15 * * * 1-5"

  repository_dispatch:
    types: [trade-signal-check, performance-check]

  workflow_dispatch:
    inputs:
      mode:
        description: 'Trading Mode'
        required: false
        type: choice
        options: [default, aggressive, conservative]
        default: 'default'
      sentiment:
        description: 'Enable Sentiment Analysis'
        required: false
        type: boolean
        default: false
      run_backtest:
        description: 'Run Backtest (optional)'
        required: false
        type: boolean
        default: false
      reset_performance:
        description: 'Reset Performance History (DANGER)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.10"
  ENTRY_SCRIPT: "trade_beacon.py"
  PERFORMANCE_SCRIPT: "performance_tracker.py"

concurrency:
  group: trade-beacon-v2-${{ github.workflow }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  forex-trading:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update && sudo apt-get install -y jq bc

      - name: ğŸ“‹ Verify system files
        run: |
          for f in ${{ env.ENTRY_SCRIPT }} ${{ env.PERFORMANCE_SCRIPT }} requirements.txt; do
            [ -f "$f" ] || { echo "âŒ Missing $f"; exit 1; }
          done
          mkdir -p signal_state
          echo "âœ… System verified"

      - name: ğŸ—‘ï¸ Reset performance history
        if: github.event.inputs.reset_performance == 'true'
        run: |
          echo "âš ï¸ RESETTING PERFORMANCE HISTORY"
          rm -f signal_state/signal_history.json
          rm -f signal_state/last_optimization.json
          echo "âœ… Performance history cleared"

      - name: âš™ï¸ Apply v2.0.6 configuration
        if: github.event.inputs.mode != 'default' && github.event.inputs.mode != ''
        run: |
          MODE="${{ github.event.inputs.mode }}"
          SENTIMENT="${{ github.event.inputs.sentiment }}"

          jq --arg mode "$MODE" --argjson sentiment "$SENTIMENT" '
          .mode = $mode |
          .use_sentiment = $sentiment |
          .settings.aggressive.threshold = 60 |
          .settings.aggressive.min_adx = 20 |
          .settings.aggressive.min_volume_ratio = 1.0 |
          .settings.aggressive.volume_penalty = 0 |
          .settings.aggressive.min_risk_reward = 2.0 |
          .settings.aggressive.atr_stop_multiplier = 1.8 |
          .settings.aggressive.atr_target_multiplier = 4.0 |
          .settings.aggressive.max_correlated_signals = 2 |
          .settings.conservative.threshold = 70 |
          .settings.conservative.min_adx = 22 |
          .settings.conservative.min_volume_ratio = 1.0 |
          .settings.conservative.volume_penalty = 0 |
          .settings.conservative.min_risk_reward = 2.5 |
          .settings.conservative.atr_stop_multiplier = 2.0 |
          .settings.conservative.atr_target_multiplier = 5.0 |
          .settings.conservative.max_correlated_signals = 1 |
          .advanced.validation.max_signal_age_seconds = 900 |
          .advanced.validation.min_sl_pips = {"JPY_pairs":20,"other":12} |
          .advanced.session_bonuses.LATE_US = {"all_major_pairs":0} |
          .performance_tuning.auto_adjust_thresholds = false |
          .performance_tracking.enable = true |
          .performance_tracking.equity_curve.enabled = true |
          .performance_tracking.equity_curve.max_points = 1000 |
          .risk_management.equity_protection.enable = false
          ' config.json > tmp.json && mv tmp.json config.json

          echo "ğŸ“„ v2.0.6 configuration applied"
          jq '.' config.json

      - name: ğŸ”„ Resolve previous signals
        run: |
          echo "ğŸ” Checking for signals to resolve..."
          if [ -f signal_state/dashboard_state.json ]; then
            OPEN_COUNT=$(jq '.signals | map(select(.status == "OPEN")) | length' signal_state/dashboard_state.json 2>/dev/null || echo "0")
            echo "ğŸ“‹ Found $OPEN_COUNT open signals to check"
          else
            echo "â„¹ï¸ No previous signals found"
          fi

      - name: ğŸ¤– Run Trade Beacon v2.0.6
        env:
          newsapi_key: ${{ secrets.newsapi_key }}
          MARKETAUX_API_KEY: ${{ secrets.MARKETAUX_API_KEY }}
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
        run: |
          echo "ğŸš€ Trade Beacon v2.0.6 - Signal Generator Mode"
          python ${{ env.ENTRY_SCRIPT }}

      - name: ğŸ“Š Optional Backtest
        if: github.event.inputs.run_backtest == 'true'
        run: |
          echo "âš ï¸ Backtest enabled"
          if [ -f backtest.py ]; then
            python backtest.py || echo "âš ï¸ Backtest failed"
          else
            echo "âš ï¸ backtest.py not found"
          fi

      - name: ğŸ” Validate outputs
        run: |
          echo "ğŸ“Š Validating dashboard state..."
          jq '.active_signals, .stats, .system.version' signal_state/dashboard_state.json
          
          echo "ğŸ¥ Validating health status..."
          jq '.status, .signal_count, .system_info.version' signal_state/health.json
          
          if [ -f signal_state/signal_history.json ]; then
            RESOLVED=$(jq '.stats.total_resolved // 0' signal_state/signal_history.json)
            TOTAL=$(jq '.signals | length' signal_state/signal_history.json)
            echo "ğŸ“ˆ Performance: $RESOLVED resolved / $TOTAL total signals"
          fi

      - name: ğŸ“ˆ Display performance summary
        if: always()
        run: |
          if [ -f signal_state/signal_history.json ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š PERFORMANCE SUMMARY (v2.0.6)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            jq -r '
              "Total Trades: \(.stats.total_trades // 0)",
              "Resolved: \(.stats.total_resolved // 0)",
              "Win Rate: \(.stats.win_rate // 0)%",
              "Total Pips: \(.stats.total_pips // 0)",
              "Expectancy: \(.stats.expectancy // 0)",
              "Avg Win: \(.stats.avg_win // 0) pips",
              "Avg Loss: \(.stats.avg_loss // 0) pips"
            ' signal_state/signal_history.json
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "â„¹ï¸ No performance history available yet"
          fi

      - name: ğŸ’¾ Commit state (local only)
        run: |
          git config user.name "Trade Beacon v2.0.6"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add signal_state/*.json signals.csv config.json || true
          
          if ! git diff --staged --quiet; then
            SIGNAL_COUNT=$(jq '.active_signals // 0' signal_state/dashboard_state.json 2>/dev/null || echo "0")
            RESOLVED=$(jq '.stats.total_resolved // 0' signal_state/signal_history.json 2>/dev/null || echo "0")
            
            git commit -m "ğŸ“Š Trade Beacon v2.0.6 | Signals: $SIGNAL_COUNT active, $RESOLVED resolved [skip ci]"
            echo "âœ… Changes committed locally (not pushed)"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: ğŸš€ Push changes (ONLY if committed)
        run: |
          if git rev-parse --verify HEAD >/dev/null 2>&1; then
            if git diff --cached --quiet; then
              echo "â„¹ï¸ No new commits to push"
            else
              git push origin HEAD:main
              echo "âœ… Changes pushed to repo"
            fi
          else
            echo "â„¹ï¸ No commit history found yet"
          fi

      - name: ğŸ“¦ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trade-beacon-v2.0.6-run-${{ github.run_number }}
          path: |
            signal_state/
            signals.csv
            config.json
          retention-days: 7

      - name: ğŸš¨ Notify on failure
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ WORKFLOW FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -f signal_state/health.json ]; then
            echo "Health Status:"
            jq '.' signal_state/health.json
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
