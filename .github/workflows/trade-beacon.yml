name: AI Forex Trading System

on:
  schedule:
    # Runs every 10 minutes, Monday-Friday during trading hours (00:00-23:50 UTC)
    - cron: '*/10 * * * 1-5'
  
  workflow_dispatch:  # Allow manual triggers
    inputs:
      force_run:
        description: 'Force run even on weekends'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.10'
  TZ: 'UTC'

jobs:
  forex-trading:
    runs-on: ubuntu-latest
    
    # Prevent concurrent runs
    concurrency:
      group: forex-trading
      cancel-in-progress: false
    
    steps:
      - name: ğŸ“… Check if trading day
        id: check_day
        run: |
          DAY=$(date +%u)  # 1=Monday, 7=Sunday
          if [ "$DAY" -eq 6 ] || [ "$DAY" -eq 7 ]; then
            echo "weekend=true" >> $GITHUB_OUTPUT
            echo "ğŸ–ï¸ Weekend detected - skipping"
          else
            echo "weekend=false" >> $GITHUB_OUTPUT
            echo "âœ… Trading day - proceeding"
          fi
      
      - name: â­ï¸ Skip weekend runs
        if: steps.check_day.outputs.weekend == 'true' && github.event.inputs.force_run != 'true'
        run: |
          echo "â¸ï¸ Markets closed on weekends"
          exit 0
      
      - name: ğŸ”„ Checkout code
        if: steps.check_day.outputs.weekend == 'false' || github.event.inputs.force_run == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: ğŸ Setup Python
        if: steps.check_day.outputs.weekend == 'false' || github.event.inputs.force_run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        if: steps.check_day.outputs.weekend == 'false' || github.event.inputs.force_run == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests yfinance python-dateutil pytz
      
      - name: ğŸ“‚ Create required directories
        if: steps.check_day.outputs.weekend == 'false' || github.event.inputs.force_run == 'true'
        run: |
          mkdir -p data/raw/yfinance
          mkdir -p data/processed
          mkdir -p database
          mkdir -p logs
          mkdir -p outputs
          mkdir -p memory
          mkdir -p signal_state
      
      - name: ğŸ” Setup API keys
        if: steps.check_day.outputs.weekend == 'false' || github.event.inputs.force_run == 'true'
        env:
          ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
          BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
          MARKETAUX_API_KEY: ${{ secrets.MARKETAUX_API_KEY }}
        run: |
          echo "âœ… API keys configured"
          echo "ALPHA_VANTAGE_KEY=${ALPHA_VANTAGE_KEY}" >> $GITHUB_ENV
          echo "BROWSERLESS_TOKEN=${BROWSERLESS_TOKEN}" >> $GITHUB_ENV
          echo "MARKETAUX_API_KEY=${MARKETAUX_API_KEY}" >> $GITHUB_ENV
      
      - name: ğŸ“¥ Restore cached data
        if: steps.check_day.outputs.weekend == 'false' || github.event.inputs.force_run == 'true'
        uses: actions/cache@v4
        with:
          path: |
            data/
            memory/
            signal_state/
            database/
          key: forex-data-${{ github.run_number }}
          restore-keys: |
            forex-data-
      
      - name: ğŸš€ Run Forex Trading System
        if: steps.check_day.outputs.weekend == 'false' || github.event.inputs.force_run == 'true'
        run: |
          echo "ğŸ¯ Starting 10-minute trading cycle..."
          python trade_beacon.py
        timeout-minutes: 8  # Kill if it runs longer than 8 minutes
      
      - name: ğŸ“Š Display execution summary
        if: always() && (steps.check_day.outputs.weekend == 'false' || github.event.inputs.force_run == 'true')
        run: |
          if [ -f "logs/pipeline.log" ]; then
            echo "=== Last 50 lines of log ==="
            tail -n 50 logs/pipeline.log
          fi
          
          if [ -f "signal_state/dashboard_state.json" ]; then
            echo ""
            echo "=== Dashboard State ==="
            cat signal_state/dashboard_state.json | head -n 30
          fi
          
          if [ -f "signal_state/api_rate_limits.json" ]; then
            echo ""
            echo "=== API Usage ==="
            cat signal_state/api_rate_limits.json
          fi
      
      - name: ğŸ’¾ Commit updated state files
        if: always() && (steps.check_day.outputs.weekend == 'false' || github.event.inputs.force_run == 'true')
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add all state files
          git add signal_state/ memory/ data/ || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update trading state - $(date -u '+%Y-%m-%d %H:%M UTC')" || true
            git push || echo "Push failed, continuing anyway"
          fi
      
      - name: ğŸ’¾ Save state for next run
        if: always() && (steps.check_day.outputs.weekend == 'false' || github.event.inputs.force_run == 'true')
        uses: actions/cache/save@v4
        with:
          path: |
            data/
            memory/
            signal_state/
            database/
          key: forex-data-${{ github.run_number }}
      
      - name: ğŸ“¤ Upload logs as artifact
        if: always() && (steps.check_day.outputs.weekend == 'false' || github.event.inputs.force_run == 'true')
        uses: actions/upload-artifact@v4
        with:
          name: forex-logs-${{ github.run_number }}
          path: |
            logs/
            signal_state/
            outputs/
          retention-days: 7
      
      - name: ğŸš¨ Notify on failure
        if: failure()
        run: |
          echo "âŒ Forex trading system failed!"
          echo "Check the logs for details"
          exit 1
      
      - name: âœ… Success summary
        if: success() && (steps.check_day.outputs.weekend == 'false' || github.event.inputs.force_run == 'true')
        run: |
          echo "âœ… 10-minute cycle completed successfully"
          echo "â° Next run in ~10 minutes"

  # Optional: Send notifications (Discord/Telegram/Email)
  notify:
    runs-on: ubuntu-latest
    needs: forex-trading
    if: always() && needs.forex-trading.result == 'failure'
    steps:
      - name: ğŸ“§ Send failure notification
        run: |
          echo "System would send notification here"
          # Add your notification logic:
          # - Discord webhook
          # - Telegram bot
          # - Email via SendGrid/SES
          # - Slack webhook
