name: AI Forex Trading System

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Trading Mode'
        required: false
        type: choice
        options:
          - default
          - aggressive
          - conservative
        default: 'default'

  repository_dispatch:
    types: [update-mode]

  push:
    paths:
      - colab_trigger.txt
      - config.json

  schedule:
    - cron: "*/10 * * * 1-5"

env:
  PYTHON_VERSION: "3.10"
  ENTRY_SCRIPT: "trade_beacon.py"
  MAX_DAILY_TRIGGER_RUNS: "10"

jobs:
  forex-trading:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install holidays jq

      - name: âš™ï¸ Apply mode override
        if: github.event.inputs.mode != 'default' || github.event_name == 'repository_dispatch'
        run: |
          MODE="${{ github.event.inputs.mode }}"
          if [ -z "$MODE" ] || [ "$MODE" = "default" ]; then
            MODE="${{ github.event.client_payload.mode }}"
          fi
          
          if [ "$MODE" != "default" ] && [ -n "$MODE" ]; then
            echo "ðŸŽ¯ Applying mode: $MODE"
            if [ -f config.json ]; then
              jq --arg mode "$MODE" '.mode = $mode' config.json > tmp.json && mv tmp.json config.json
              echo "âœ… config.json updated to $MODE mode"
              cat config.json
            else
              echo "âš ï¸ config.json not found, creating default"
              cat > config.json << 'CONFIGEOF'
          {
            "mode": "aggressive",
            "settings": {
              "aggressive": {
                "threshold": 30,
                "min_adx": null,
                "rsi_oversold": 40,
                "rsi_overbought": 60
              },
              "conservative": {
                "threshold": 50,
                "min_adx": 20,
                "rsi_oversold": 35,
                "rsi_overbought": 65
              }
            }
          }
          CONFIGEOF
              jq --arg mode "$MODE" '.mode = $mode' config.json > tmp.json && mv tmp.json config.json
              echo "âœ… Created config.json with $MODE mode"
            fi
          fi

      - name: ðŸ” Decide run mode
        id: decide
        shell: bash
        run: |
          set -e

          EVENT="${GITHUB_EVENT_NAME}"
          TODAY="$(date -u +%Y-%m-%d)"
          STATE_FILE="trigger_state.json"

          # Initialize state if missing or invalid
          if [ ! -f "$STATE_FILE" ]; then
            echo "{\"date\":\"$TODAY\",\"trigger_count\":0,\"mode\":\"trigger\"}" > "$STATE_FILE"
          fi

          # Load state safely
          STORED_DATE=$(jq -r '.date // empty' "$STATE_FILE")
          COUNT=$(jq -r '.trigger_count // 0' "$STATE_FILE")
          MODE=$(jq -r '.mode // "trigger"' "$STATE_FILE")

          # Reset at midnight UTC
          if [ "$STORED_DATE" != "$TODAY" ]; then
            COUNT=0
            MODE="trigger"
          fi

          RUN=false

          # Manual run always allowed
          if [ "$EVENT" = "workflow_dispatch" ]; then
            RUN=true
            echo "ðŸš€ Manual trigger detected"
          fi

          # Repository dispatch (mode change)
          if [ "$EVENT" = "repository_dispatch" ]; then
            RUN=true
            echo "ðŸŽ¯ Mode change trigger detected"
          fi

          # Trigger-file push mode
          if [ "$MODE" = "trigger" ] && [ "$EVENT" = "push" ]; then
            if [ "$COUNT" -lt "$MAX_DAILY_TRIGGER_RUNS" ]; then
              RUN=true
              COUNT=$((COUNT + 1))
              echo "âœ… Trigger run #$COUNT"
              if [ "$COUNT" -ge "$MAX_DAILY_TRIGGER_RUNS" ]; then
                MODE="schedule"
                echo "âš ï¸ Max triggers reached, switching to schedule mode"
              fi
            else
              echo "âŒ Max daily triggers reached ($MAX_DAILY_TRIGGER_RUNS)"
            fi
          fi

          # Schedule mode
          if [ "$MODE" = "schedule" ] && [ "$EVENT" = "schedule" ]; then
            RUN=true
            echo "â° Scheduled run"
          fi

          # Save updated state
          echo "{\"date\":\"$TODAY\",\"trigger_count\":$COUNT,\"mode\":\"$MODE\"}" > "$STATE_FILE"

          # Output for GitHub Actions
          echo "run=$RUN" >> "$GITHUB_OUTPUT"
          echo "mode=$MODE" >> "$GITHUB_OUTPUT"

          echo "âœ… State file:"
          cat "$STATE_FILE"

      - name: ðŸ“… Check trading day
        if: steps.decide.outputs.run == 'true'
        id: market
        run: |
          python << 'EOF'
          import datetime
          import holidays
          import os

          today = datetime.date.today()
          us = holidays.US()

          skip = today.weekday() >= 5 or today in us

          status = "ðŸš« CLOSED" if skip else "âœ… OPEN"
          print(f"Market status: {status}")

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"skip={'true' if skip else 'false'}\n")
          EOF

      - name: ðŸ“Š Show current configuration
        if: steps.decide.outputs.run == 'true' && steps.market.outputs.skip != 'true'
        run: |
          echo "ðŸŽ¯ Current Trading Configuration:"
          if [ -f config.json ]; then
            cat config.json | jq .
          else
            echo "âš ï¸ No config.json found, using defaults"
          fi

      - name: ðŸš€ Run Trading Bot
        if: steps.decide.outputs.run == 'true' && steps.market.outputs.skip != 'true'
        env:
          ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}
          BROWSERLESS_TOKEN: ${{ secrets.BROWSERLESS_TOKEN }}
          MARKETAUX_API_KEY: ${{ secrets.MARKETAUX_API_KEY }}
        run: |
          echo "ðŸ¤– Starting Trade Beacon..."
          python ${{ env.ENTRY_SCRIPT }}

      - name: ðŸ’¾ Commit runtime data
        if: steps.decide.outputs.run == 'true'
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "Trade Beacon Bot"

          git add trigger_state.json logs/ signal_state/ memory/ config.json signals.csv || true

          if ! git diff --cached --quiet; then
            COMMIT_MSG="ðŸ”„ Trade beacon run $(date -u +"%Y-%m-%d %H:%M UTC")"
            
            # Add mode info if available
            if [ -f config.json ]; then
              MODE=$(jq -r '.mode // "unknown"' config.json)
              COMMIT_MSG="$COMMIT_MSG [${MODE} mode]"
            fi
            
            git commit -m "$COMMIT_MSG"
            git push
          else
            echo "âœ… No changes to commit"
          fi

      - name: ðŸ“¦ Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-logs-${{ github.run_number }}
          path: |
            logs/
            signal_state/
            memory/
            config.json
            signals.csv
          if-no-files-found: ignore

      - name: ðŸ“ Summary
        if: always()
        run: |
          echo "## ðŸ“Š Trade Beacon Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Mode**: ${{ steps.decide.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.market.outputs.skip }}" = "true" ]; then
            echo "- **Market Status**: ðŸš« Closed (Weekend/Holiday)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Market Status**: âœ… Open" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f config.json ]; then
            MODE=$(jq -r '.mode // "unknown"' config.json)
            THRESHOLD=$(jq -r ".settings.${MODE}.threshold // \"N/A\"" config.json)
            MIN_ADX=$(jq -r ".settings.${MODE}.min_adx // \"None\"" config.json)
            echo "- **Trading Mode**: ${MODE}" >> $GITHUB_STEP_SUMMARY
            echo "- **Signal Threshold**: ${THRESHOLD}" >> $GITHUB_STEP_SUMMARY
            echo "- **Min ADX**: ${MIN_ADX}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f signals.csv ]; then
            SIGNAL_COUNT=$(($(wc -l < signals.csv) - 1))
            if [ $SIGNAL_COUNT -lt 0 ]; then
              SIGNAL_COUNT=0
            fi
            echo "- **Signals Generated**: ${SIGNAL_COUNT}" >> $GITHUB_STEP_SUMMARY
            
            if [ $SIGNAL_COUNT -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸŽ¯ Active Signals" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat signals.csv >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Signals Generated**: 0" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> $GITHUB_STEP_SUMMARY
