<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trade Beacon | Intelligence Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --void: #0a0a0f; --surface: #1a1a24; --elevated: #232334;
      --orange: #ff6b35; --blue: #4facfe; --green: #00f2a9; --red: #ff4757; --yellow: #fbbf24;
      --text: #ffffff; --text-dim: #b8bdc9; --text-muted: #6b7280;
      --border: rgba(255,255,255,0.1);
      --shadow: 0 10px 40px rgba(0,0,0,0.4);
      --glow-orange: 0 0 30px rgba(255,107,53,0.4);
    }
    
    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--void);
      color: var(--text);
      line-height: 1.5;
      overflow-x: hidden;
    }
    
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 20% 30%, rgba(255,107,53,0.08) 0%, transparent 50%),
                  radial-gradient(circle at 80% 70%, rgba(79,172,254,0.08) 0%, transparent 50%);
      pointer-events: none;
      animation: pulse 15s ease-in-out infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    
    .candles { position: fixed; top: 0; right: 0; width: 400px; height: 100%; opacity: 0.03; pointer-events: none; }
    .candle { position: absolute; width: 20px; background: var(--green); animation: rise 4s ease-in-out infinite; }
    .candle:nth-child(1) { left: 50px; }
    .candle:nth-child(2) { left: 100px; animation-delay: 0.5s; background: var(--red); }
    .candle:nth-child(3) { left: 150px; animation-delay: 1s; }
    .candle:nth-child(4) { left: 200px; animation-delay: 1.5s; background: var(--red); }
    .candle:nth-child(5) { left: 250px; animation-delay: 2s; }
    @keyframes rise { 0%, 100% { height: 60%; bottom: 20%; } 50% { height: 80%; bottom: 10%; } }
    
    .container { max-width: 1920px; margin: 0 auto; padding: 24px; position: relative; z-index: 1; }
    
    .header {
      background: linear-gradient(135deg, var(--surface), var(--elevated));
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 32px;
      overflow: hidden;
      box-shadow: var(--shadow);
      position: relative;
    }
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--orange), var(--blue), var(--green));
      box-shadow: var(--glow-orange);
    }
    
    .header-grid { display: grid; grid-template-columns: auto 1fr auto; gap: 40px; align-items: center; }
    
    .brand { display: flex; align-items: center; gap: 20px; }
    .brand-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--orange), #ff8c61);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--glow-orange);
      animation: iconPulse 3s ease-in-out infinite;
    }
    @keyframes iconPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .brand-icon svg { width: 36px; height: 36px; color: white; }
    
    .brand-text h1 {
      font-family: 'Orbitron', monospace;
      font-size: 32px;
      font-weight: 900;
      letter-spacing: 2px;
      background: linear-gradient(135deg, var(--orange), var(--blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-transform: uppercase;
    }
    .brand-text p { font-size: 12px; color: var(--text-dim); font-weight: 600; letter-spacing: 1px; margin-top: 4px; }
    
    .header-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .mini-stat {
      text-align: center;
      padding: 16px;
      background: rgba(255,107,53,0.1);
      border: 1px solid rgba(255,107,53,0.2);
      border-radius: 12px;
      transition: all 0.3s;
    }
    .mini-stat:hover { background: rgba(255,107,53,0.15); transform: translateY(-2px); }
    .mini-stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
    .mini-stat-value { font-family: 'Orbitron', monospace; font-size: 20px; font-weight: 900; color: var(--orange); margin-top: 4px; }
    
    .status-badge {
      padding: 12px 20px;
      background: rgba(0,242,169,0.1);
      border: 1px solid rgba(0,242,169,0.3);
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      color: var(--green);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      background: var(--green);
      border-radius: 50%;
      box-shadow: 0 0 10px var(--green);
      animation: pulseDot 2s ease-in-out infinite;
    }
    @keyframes pulseDot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .metric {
      background: linear-gradient(135deg, var(--surface), var(--elevated));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .metric::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--orange), var(--blue));
      transform: scaleX(0);
      transition: transform 0.4s;
    }
    .metric:hover { transform: translateY(-8px); border-color: rgba(255,255,255,0.2); box-shadow: var(--glow-orange); }
    .metric:hover::before { transform: scaleX(1); }
    
    .metric-icon {
      width: 48px;
      height: 48px;
      background: rgba(255,107,53,0.15);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
    .metric-icon svg { width: 24px; height: 24px; color: var(--orange); }
    
    .metric-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 700; }
    .metric-value {
      font-family: 'Orbitron', monospace;
      font-size: 32px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--orange), var(--blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 8px 0;
    }
    .metric-sub { font-size: 12px; color: var(--text-dim); font-weight: 500; }
    
    .modes {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 8px;
      width: fit-content;
    }
    .mode-btn {
      padding: 14px 32px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      background: transparent;
      color: var(--text-dim);
      font-family: 'Rajdhani', sans-serif;
      display: flex;
      align-items: center;
      gap: 8px;
      letter-spacing: 1px;
    }
    .mode-btn.active {
      background: linear-gradient(135deg, var(--orange), #ff8c61);
      color: white;
      box-shadow: var(--glow-orange);
    }
    .mode-btn:not(.active):hover { background: rgba(255,107,53,0.1); color: var(--orange); }
    
    .tabs { display: flex; gap: 8px; margin-bottom: 32px; border-bottom: 2px solid var(--border); }
    .tab {
      padding: 16px 28px;
      border: none;
      background: transparent;
      color: var(--text-dim);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      border-radius: 12px 12px 0 0;
      transition: all 0.3s;
      font-family: 'Rajdhani', sans-serif;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
      letter-spacing: 1px;
    }
    .tab::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--orange), var(--blue));
      transform: scaleX(0);
      transition: transform 0.3s;
    }
    .tab.active { color: var(--orange); background: rgba(255,107,53,0.1); }
    .tab.active::after { transform: scaleX(1); }
    
    .tab-content { display: none; animation: fadeIn 0.5s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* âœ… SMART SIGNAL CARDS */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); gap: 20px; }
    
    .card {
      background: linear-gradient(135deg, var(--surface), var(--elevated));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--orange), var(--blue), var(--green));
    }
    .card:hover { transform: translateY(-8px) scale(1.02); border-color: rgba(255,255,255,0.2); box-shadow: var(--glow-orange); }
    
    /* Updated badge */
    .update-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 6px 12px;
      background: linear-gradient(135deg, var(--yellow), #f59e0b);
      border-radius: 8px;
      font-size: 10px;
      font-weight: 900;
      color: #78350f;
      display: flex;
      align-items: center;
      gap: 6px;
      animation: pulse 2s ease-in-out infinite;
    }
    
    /* Flash animation for newly updated cards */
    @keyframes flashUpdate {
      0%, 100% { box-shadow: var(--shadow); border-color: var(--border); }
      50% { box-shadow: 0 0 40px rgba(251, 191, 36, 0.8); border-color: var(--yellow); }
    }
    
    .card.just-updated {
      animation: flashUpdate 2s ease-in-out 3;
    }
    
    .signal-tier {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      font-weight: 900;
      color: white;
      margin-bottom: 12px;
    }
    .signal-tier.tier-aplus { background: linear-gradient(135deg, #fbbf24, #f59e0b); box-shadow: 0 0 20px rgba(251,191,36,0.5); }
    .signal-tier.tier-a { background: linear-gradient(135deg, var(--green), #00c787); box-shadow: 0 0 20px rgba(0,242,169,0.4); }
    .signal-tier.tier-b { background: linear-gradient(135deg, var(--blue), #3a8bd6); box-shadow: 0 0 20px rgba(79,172,254,0.4); }
    .signal-tier.tier-c { background: linear-gradient(135deg, #6b7280, #4b5563); }
    
    .strength {
      position: absolute;
      top: 24px;
      left: 24px;
      width: 50px;
      height: 50px;
    }
    .strength svg { transform: rotate(-90deg); }
    .strength-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 5; }
    .strength-bar { fill: none; stroke-width: 5; stroke-linecap: round; transition: stroke-dashoffset 1s ease-out; }
    .strength-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      font-weight: 900;
    }
    
    .pair {
      font-family: 'Orbitron', monospace;
      font-size: 28px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--orange), var(--blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      padding-left: 60px;
    }
    
    .dir {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: 1px;
      margin-bottom: 16px;
      margin-left: 60px;
    }
    .dir-buy { background: linear-gradient(135deg, var(--green), #33f5bf); color: white; box-shadow: 0 0 20px rgba(0,242,169,0.4); }
    .dir-sell { background: linear-gradient(135deg, var(--red), #ff6b7a); color: white; box-shadow: 0 0 20px rgba(255,71,87,0.4); }
    
    /* Current values section */
    .section-title {
      font-size: 12px;
      font-weight: 900;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 20px 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
    .metric-item {
      background: #121218;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      overflow: hidden;
    }
    .metric-item-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; margin-bottom: 4px; }
    .metric-item-value { font-family: 'Orbitron', monospace; font-size: 16px; font-weight: 700; color: white; word-break: break-all; }
    .metric-item-value.hl { color: var(--orange); }
    
    /* âœ… CHANGES SECTION */
    .changes-section {
      background: rgba(0,242,169,0.05);
      border: 1px solid rgba(0,242,169,0.2);
      border-radius: 10px;
      padding: 14px;
      margin: 16px 0;
    }
    
    .change-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .change-item:last-child { border-bottom: none; }
    
    .change-label {
      color: var(--text-dim);
      font-weight: 600;
    }
    
    .change-value {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: 'Orbitron', monospace;
      font-weight: 900;
    }
    .change-value.up { color: var(--green); }
    .change-value.down { color: var(--red); }
    .change-value.neutral { color: var(--text-muted); }
    
    .change-arrow {
      font-size: 16px;
      line-height: 1;
    }
    
    /* âœ… HISTORY SECTION */
    .history-section {
      background: rgba(79,172,254,0.05);
      border: 1px solid rgba(79,172,254,0.2);
      border-radius: 10px;
      padding: 14px;
      margin: 16px 0;
    }
    
    .history-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 11px;
      color: var(--text-dim);
    }
    .history-item::before {
      content: 'â€¢';
      color: var(--blue);
      font-size: 16px;
      line-height: 1;
    }
    .history-time {
      font-family: 'Orbitron', monospace;
      color: var(--blue);
      font-weight: 700;
    }
    .history-value {
      font-family: 'Orbitron', monospace;
      color: var(--text);
    }
    
    /* History Table Styles */
    .history-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
    }
    
    .history-scroll-container {
      max-height: 600px;
      overflow-x: auto;
      overflow-y: auto;
      position: relative;
    }
    
    .filters { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    .filter { display: flex; flex-direction: column; gap: 8px; }
    .filter-label { font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
    .filter-input {
      padding: 10px 16px;
      background: var(--elevated);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: white;
      font-size: 14px;
      font-family: 'Rajdhani', sans-serif;
      cursor: pointer;
    }
    .filter-input:focus { outline: none; border-color: var(--orange); box-shadow: 0 0 0 3px rgba(255,107,53,0.1); }
    
    table { width: 100%; min-width: 1000px; border-collapse: collapse; }
    thead { 
      background: var(--elevated);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th {
      padding: 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
    }
    tbody tr { border-bottom: 1px solid var(--border); transition: background 0.2s; }
    tbody tr:hover { background: rgba(255,107,53,0.05); }
    td {
      padding: 16px;
      font-size: 13px;
      font-family: 'Orbitron', monospace;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .win { color: var(--green); font-weight: 900; }
    .loss { color: var(--red); font-weight: 900; }
    .exp { color: var(--text-muted); font-weight: 700; }
    
    .history-tier-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 900;
      color: white;
    }
    .history-tier-badge.tier-aplus { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
    .history-tier-badge.tier-a { background: linear-gradient(135deg, var(--green), #00c787); }
    .history-tier-badge.tier-b { background: linear-gradient(135deg, var(--blue), #3a8bd6); }
    .history-tier-badge.tier-c { background: linear-gradient(135deg, #6b7280, #4b5563); }
    
    .history-scroll-container::-webkit-scrollbar {
      height: 10px;
      width: 10px;
    }
    .history-scroll-container::-webkit-scrollbar-track {
      background: var(--elevated);
      border-radius: 5px;
    }
    .history-scroll-container::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--orange), var(--blue));
      border-radius: 5px;
    }
    .history-scroll-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #ff8c61, #6bb8fe);
    }
    
    /* Analytics Styles */
    .analytics { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 24px; }
    .analytics-card {
      background: linear-gradient(135deg, var(--surface), var(--elevated));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      box-shadow: var(--shadow);
    }
    .analytics-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .analytics-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
    }
    .analytics-item:last-child { border-bottom: none; }
    .analytics-label { font-size: 14px; color: var(--text-dim); font-weight: 600; }
    .analytics-value { font-size: 18px; font-weight: 800; font-family: 'Orbitron', monospace; }
    .analytics-tier-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-family: 'Orbitron', monospace;
      font-size: 10px;
      font-weight: 900;
      color: white;
      margin-right: 8px;
    }
    .analytics-tier-badge.tier-aplus { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
    .analytics-tier-badge.tier-a { background: linear-gradient(135deg, var(--green), #00c787); }
    .analytics-tier-badge.tier-b { background: linear-gradient(135deg, var(--blue), #3a8bd6); }
    .analytics-tier-badge.tier-c { background: linear-gradient(135deg, #6b7280, #4b5563); }
    .progress {
      height: 8px;
      background: var(--elevated);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--orange), var(--blue));
      border-radius: 4px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px rgba(255,107,53,0.4);
    }
    
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .time {
      font-size: 11px;
      color: var(--text-dim);
      font-family: 'Orbitron', monospace;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .session {
      padding: 4px 10px;
      background: rgba(79,172,254,0.1);
      border: 1px solid rgba(79,172,254,0.3);
      border-radius: 6px;
      font-size: 10px;
      font-weight: 900;
      color: var(--blue);
      letter-spacing: 0.5px;
    }
    
    /* Weekend Mode Countdown */
    .countdown-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 24px;
    }
    .countdown-candle {
      position: relative;
      width: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .candle-stick {
      width: 40px;
      background: linear-gradient(180deg, var(--red), #c23542);
      border-radius: 4px;
      position: relative;
      box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
      animation: candleFlicker 2s ease-in-out infinite;
    }
    .candle-stick::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 8px;
      background: var(--red);
    }
    .candle-stick::after {
      content: '';
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 12px;
      background: radial-gradient(circle, #ffeb3b, #ff9800);
      border-radius: 50%;
      filter: blur(4px);
      animation: flame 1.5s ease-in-out infinite;
    }
    @keyframes candleFlicker {
      0%, 100% { transform: scaleY(1); opacity: 1; }
      50% { transform: scaleY(0.98); opacity: 0.95; }
    }
    @keyframes flame {
      0%, 100% { transform: translateX(-50%) scale(1); opacity: 1; }
      50% { transform: translateX(-50%) scale(1.1, 0.9); opacity: 0.8; }
    }
    .countdown-number {
      font-family: 'Orbitron', monospace;
      font-size: 32px;
      font-weight: 900;
      color: var(--red);
      text-shadow: 0 0 20px rgba(255, 71, 87, 0.6);
    }
    .countdown-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
    }
    
    .empty {
      text-align: center;
      padding: 80px 40px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
    }
    .empty-icon { width: 64px; height: 64px; margin: 0 auto 20px; color: var(--text-muted); }
    .empty-title { font-size: 20px; font-weight: 900; color: var(--text-dim); margin-bottom: 8px; }
    .empty-desc { font-size: 14px; color: var(--text-muted); }
    
    @media (max-width: 768px) {
      .header-grid { grid-template-columns: 1fr; }
      .metrics { grid-template-columns: repeat(2, 1fr); }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="candles">
    <div class="candle"></div><div class="candle"></div><div class="candle"></div><div class="candle"></div><div class="candle"></div>
  </div>

  <div class="container">
    <header class="header">
      <div class="header-grid">
        <div class="brand">
          <div class="brand-icon"><i data-lucide="activity"></i></div>
          <div class="brand-text">
            <h1>TRADE BEACON</h1>
            <p>MARKET INTELLIGENCE v2.1.3</p>
          </div>
        </div>
        <div class="header-stats">
          <div class="mini-stat"><div class="mini-stat-label">ACTIVE</div><div class="mini-stat-value" id="hActive">0</div></div>
          <div class="mini-stat"><div class="mini-stat-label">WIN RATE</div><div class="mini-stat-value" id="hWR">0%</div></div>
          <div class="mini-stat"><div class="mini-stat-label">PIPS</div><div class="mini-stat-value" id="hPips">0</div></div>
        </div>
        <div class="status-badge"><div class="status-dot"></div><span>LIVE MARKET</span></div>
      </div>
    </header>

    <div class="metrics">
      <div class="metric"><div class="metric-icon"><i data-lucide="signal"></i></div><div class="metric-label">Active Signals</div><div class="metric-value" id="mSignals">0</div><div class="metric-sub">Multi-mode</div></div>
      <div class="metric"><div class="metric-icon"><i data-lucide="target"></i></div><div class="metric-label">Win Rate</div><div class="metric-value" id="mWR">0%</div><div class="metric-sub" id="mWRSub">No trades</div></div>
      <div class="metric"><div class="metric-icon"><i data-lucide="trending-up"></i></div><div class="metric-label">Total Pips</div><div class="metric-value" id="mPips">0</div><div class="metric-sub" id="mPipsSub">Lifetime</div></div>
      <div class="metric"><div class="metric-icon"><i data-lucide="bar-chart-3"></i></div><div class="metric-label">Expectancy</div><div class="metric-value" id="mExp">0</div><div class="metric-sub">Pips per trade</div></div>
      <div class="metric"><div class="metric-icon"><i data-lucide="calendar"></i></div><div class="metric-label">Today</div><div class="metric-value" id="mToday">0</div><div class="metric-sub" id="mTodaySub">Signals</div></div>
      <div class="metric"><div class="metric-icon"><i data-lucide="globe-2"></i></div><div class="metric-label">Session</div><div class="metric-value" id="mSession" style="font-size:20px">---</div><div class="metric-sub" id="mTime">---</div></div>
    </div>

    <div class="modes">
      <button class="mode-btn active" id="modeAgg" onclick="switchMode('aggressive')"><i data-lucide="zap" style="width:16px;height:16px"></i>AGGRESSIVE</button>
      <button class="mode-btn" id="modeCon" onclick="switchMode('conservative')"><i data-lucide="shield" style="width:16px;height:16px"></i>CONSERVATIVE</button>
    </div>

    <nav class="tabs">
      <button class="tab active" onclick="switchTab('signals')"><i data-lucide="radio" style="width:16px;height:16px"></i>LIVE SIGNALS</button>
      <button class="tab" onclick="switchTab('history')"><i data-lucide="history" style="width:16px;height:16px"></i>HISTORY</button>
      <button class="tab" onclick="switchTab('analytics')"><i data-lucide="pie-chart" style="width:16px;height:16px"></i>ANALYTICS</button>
    </nav>

    <div id="tabSignals" class="tab-content active">
      <div class="grid" id="signalsGrid"></div>
    </div>

    <div id="tabHistory" class="tab-content">
      <div class="filters">
        <div class="filter"><label class="filter-label">Date Range</label><div style="display:flex;gap:12px;align-items:center"><input type="date" id="dateStart" class="filter-input"><span style="color:var(--text-muted)">â†’</span><input type="date" id="dateEnd" class="filter-input"></div></div>
        <div class="filter"><label class="filter-label">Status</label><select id="filterStatus" class="filter-input"><option value="all">All</option><option value="WIN">Wins</option><option value="LOSS">Losses</option><option value="EXPIRED">Expired</option></select></div>
        <div class="filter"><label class="filter-label">Pair</label><select id="filterPair" class="filter-input"><option value="all">All Pairs</option></select></div>
      </div>
      <div class="history-wrap">
        <div class="history-scroll-container">
          <table>
            <thead>
              <tr><th>DATE</th><th>PAIR</th><th>DIR</th><th>TIER</th><th>RESULT</th><th>PIPS</th><th>SESSION</th></tr>
            </thead>
            <tbody id="historyBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="tabAnalytics" class="tab-content">
      <div class="analytics">
        <div class="analytics-card"><h3 class="analytics-title"><i data-lucide="award" style="width:24px;height:24px;color:var(--orange)"></i>Performance by Tier</h3><div id="tierAnalytics"></div></div>
        <div class="analytics-card"><h3 class="analytics-title"><i data-lucide="globe-2" style="width:24px;height:24px;color:var(--blue)"></i>Performance by Session</h3><div id="sessionAnalytics"></div></div>
        <div class="analytics-card"><h3 class="analytics-title"><i data-lucide="trending-up" style="width:24px;height:24px;color:var(--green)"></i>Top Performing Pairs</h3><div id="pairAnalytics"></div></div>
        <div class="analytics-card"><h3 class="analytics-title"><i data-lucide="layers" style="width:24px;height:24px;color:var(--orange)"></i>Performance by Mode</h3><div id="modeAnalytics"></div></div>
      </div>
    </div>
  </div>

  <footer style="margin-top: 60px; padding: 32px; text-align: center; border-top: 1px solid var(--border);">
    <div style="display: inline-block; padding: 20px 40px; background: linear-gradient(135deg, var(--surface), var(--elevated)); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow);">
      <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px;">ENGINEERED BY</div>
      <div style="font-family: 'Orbitron', monospace; font-size: 24px; font-weight: 900; background: linear-gradient(135deg, var(--orange), var(--blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 12px;">RAHIM</div>
      <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 16px;">
        <i data-lucide="zap" style="width: 14px; height: 14px; vertical-align: middle; color: var(--orange);"></i>
        Building the future of trading intelligence
      </div>
      <button onclick="window.location.href='mailto:' + 'nakatonabira3' + '@' + 'gmail.com'" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: linear-gradient(135deg, var(--orange), #ff8c61); border: none; border-radius: 10px; color: white; font-weight: 700; font-size: 13px; letter-spacing: 0.5px; box-shadow: var(--glow-orange); transition: all 0.3s; cursor: pointer; font-family: 'Rajdhani', sans-serif;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 40px rgba(255,107,53,0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 0 30px rgba(255,107,53,0.4)'">
        <i data-lucide="mail" style="width: 16px; height: 16px;"></i>
        SHARE YOUR THOUGHTS
      </button>
      <div style="margin-top: 16px; font-size: 10px; color: var(--text-muted); font-family: 'Orbitron', monospace;">
        <span>nakatonabira3<span style="display:none">-removethis-</span>@<span style="display:none">-removethis-</span>gmail.com</span>
      </div>
    </div>
  </footer>

  <script>
    lucide.createIcons();
    let mode = 'aggressive';
    let data = null;
    let signalState = {}; // âœ… Store signal tracking per pair - PERSISTS across refreshes
    
    document.addEventListener('DOMContentLoaded', () => {
      mode = localStorage.getItem('tbMode') || 'aggressive';
      updateModeBtns();
      checkMarketStatus(); // Check if weekend
      load();
      setInterval(load, 30000);
      initFilters();
      updateSess();
      setInterval(updateSess, 60000);
    });
    
    function checkMarketStatus() {
      const now = new Date();
      const day = now.getUTCDay(); // 0 = Sunday, 6 = Saturday
      const hour = now.getUTCHours();
      
      // Market closed: Friday 22:00 UTC to Sunday 22:00 UTC
      // Friday after 22:00, all of Saturday (day 6), all of Sunday until 22:00
      const isWeekend = (day === 5 && hour >= 22) || day === 6 || (day === 0 && hour < 22);
      
      const statusBadge = document.querySelector('.status-badge');
      const statusText = statusBadge.querySelector('span');
      const statusDot = statusBadge.querySelector('.status-dot');
      
      if (isWeekend) {
        statusText.textContent = 'MARKET CLOSED';
        statusBadge.style.background = 'rgba(255, 71, 87, 0.1)';
        statusBadge.style.borderColor = 'rgba(255, 71, 87, 0.3)';
        statusBadge.style.color = 'var(--red)';
        statusDot.style.background = 'var(--red)';
        statusDot.style.boxShadow = '0 0 10px var(--red)';
        
        // Calculate time until Monday 00:00 UTC
        const nextMonday = new Date(now);
        nextMonday.setUTCDate(now.getUTCDate() + ((1 + 7 - now.getUTCDay()) % 7 || 7));
        nextMonday.setUTCHours(0, 0, 0, 0);
        
        // Add weekend notice with countdown
        const container = document.querySelector('.container');
        if (!document.getElementById('weekend-notice')) {
          const notice = document.createElement('div');
          notice.id = 'weekend-notice';
          notice.style.cssText = 'background: linear-gradient(135deg, rgba(255,71,87,0.1), rgba(194,53,66,0.1)); border: 1px solid rgba(255,71,87,0.3); border-radius: 16px; padding: 32px 24px; margin-bottom: 24px;';
          notice.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 20px;">
              <i data-lucide="power-off" style="width:24px;height:24px;color:var(--red)"></i>
              <span style="color:var(--red);font-size:18px;font-weight:900;letter-spacing:1px;">FOREX MARKET CLOSED</span>
            </div>
            
            <div style="text-align: center; margin-bottom: 24px;">
              <div style="font-size: 14px; color: var(--text-dim); margin-bottom: 8px;">Market reopens in:</div>
              <div id="countdown" class="countdown-container"></div>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
              <button id="replayBtn" onclick="playWeeklyReplay()" style="padding: 12px 24px; background: linear-gradient(135deg, var(--orange), #ff8c61); border: none; border-radius: 10px; color: white; font-weight: 700; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-family: 'Rajdhani', sans-serif; letter-spacing: 0.5px; box-shadow: var(--glow-orange); transition: all 0.3s;">
                <i data-lucide="play" style="width:16px;height:16px"></i>
                PLAY WEEKLY REPLAY
              </button>
            </div>
            
            <div id="replayProgress" style="display:none; width:100%; height:6px; background:var(--elevated); border-radius:3px; overflow:hidden; margin-top:16px;">
              <div id="replayBar" style="height:100%; width:0%; background:linear-gradient(90deg, var(--orange), var(--blue)); transition: width 0.3s;"></div>
            </div>
          `;
          container.insertBefore(notice, container.querySelector('.metrics'));
          lucide.createIcons();
          
          // Start countdown
          updateCountdown(nextMonday);
          setInterval(() => updateCountdown(nextMonday), 1000);
        }
      }
    }
    
    function updateCountdown(targetDate) {
      const now = new Date();
      const diff = targetDate - now;
      
      if (diff <= 0) {
        location.reload(); // Reload when market opens
        return;
      }
      
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      
      const countdownEl = document.getElementById('countdown');
      if (!countdownEl) return;
      
      countdownEl.innerHTML = `
        ${days > 0 ? `
        <div class="countdown-candle">
          <div class="candle-stick" style="height: ${60 + days * 5}px;"></div>
          <div class="countdown-number">${days}</div>
          <div class="countdown-label">DAY${days !== 1 ? 'S' : ''}</div>
        </div>` : ''}
        
        <div class="countdown-candle">
          <div class="candle-stick" style="height: ${60 + hours * 2}px;"></div>
          <div class="countdown-number">${String(hours).padStart(2, '0')}</div>
          <div class="countdown-label">HOURS</div>
        </div>
        
        <div class="countdown-candle">
          <div class="candle-stick" style="height: ${60 + Math.floor(minutes / 2)}px;"></div>
          <div class="countdown-number">${String(minutes).padStart(2, '0')}</div>
          <div class="countdown-label">MINS</div>
        </div>
        
        <div class="countdown-candle">
          <div class="candle-stick" style="height: ${60 + Math.floor(seconds / 2)}px;"></div>
          <div class="countdown-number">${String(seconds).padStart(2, '0')}</div>
          <div class="countdown-label">SECS</div>
        </div>
      `;
    }
    
    async function load() {
      try {
        const r = await fetch('signal_state/dashboard_state.json');
        data = await r.json();
        console.log('ðŸ“Š Dashboard data loaded');
        updateMetrics();
        processAndRenderSignals();
        renderHistory();
        renderAnalytics();
      } catch(e) {
        console.error('Load error:', e);
        showEmpty('signalsGrid', 'alert-triangle', 'Unable to load', 'Check system');
      }
    }
    
    function switchMode(m) {
      mode = m;
      localStorage.setItem('tbMode', m);
      updateModeBtns();
      processAndRenderSignals();
      lucide.createIcons();
    }
    
    function updateModeBtns() {
      document.getElementById('modeAgg').classList.toggle('active', mode === 'aggressive');
      document.getElementById('modeCon').classList.toggle('active', mode === 'conservative');
      lucide.createIcons();
    }
    
    function switchTab(t) {
      document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
      event.target.closest('.tab').classList.add('active');
      document.getElementById({signals:'tabSignals', history:'tabHistory', analytics:'tabAnalytics'}[t]).classList.add('active');
      lucide.createIcons();
    }
    
    function updateMetrics() {
      if (!data) return;
      
      // Count unique pairs (not signals)
      const aggSignals = data.signals_by_mode?.aggressive || [];
      const consSignals = data.signals_by_mode?.conservative || [];
      const allSignals = [...aggSignals, ...consSignals];
      
      // Get unique pairs
      const uniquePairs = new Set(allSignals.map(s => s.pair));
      const uniqueCount = uniquePairs.size;
      
      const st = data.stats || {};
      const wr = st.win_rate || 0, tp = st.total_pips || 0, ex = st.expectancy || 0, tt = st.total_trades || 0;
      
      document.getElementById('hActive').textContent = uniqueCount;
      document.getElementById('hWR').textContent = wr.toFixed(1) + '%';
      document.getElementById('hPips').textContent = tp > 0 ? '+' + tp.toFixed(0) : tp.toFixed(0);
      document.getElementById('mSignals').textContent = uniqueCount;
      document.getElementById('mWR').textContent = wr.toFixed(1) + '%';
      document.getElementById('mWRSub').textContent = `${st.wins||0}/${tt} trades`;
      document.getElementById('mPips').textContent = tp > 0 ? '+' + tp.toFixed(1) : tp.toFixed(1);
      document.getElementById('mPipsSub').textContent = tt > 0 ? `From ${tt} trades` : 'Lifetime';
      document.getElementById('mExp').textContent = ex > 0 ? '+' + ex.toFixed(1) : ex.toFixed(1);
      
      const today = new Date().toISOString().split('T')[0];
      const tc = allSignals.filter(s => s.timestamp && s.timestamp.startsWith(today)).length;
      document.getElementById('mToday').textContent = uniquePairs.size;
      document.getElementById('mTodaySub').textContent = uniquePairs.size === 0 ? 'No signals' : 'Generated today';
    }
    
    // âœ… SMART SIGNAL PROCESSING - Persists state across refreshes
    function processAndRenderSignals() {
      const g = document.getElementById('signalsGrid');
      if (!data) {
        g.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)">Loading...</div>';
        return;
      }

      let sigs = data.signals_by_mode?.[mode] || [];

      console.log(`ðŸŽ¯ Processing ${mode} signals:`, sigs.length);

      // Sort newest first
      sigs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      const justUpdated = []; // Track which cards just updated

      sigs.forEach(signal => {

        const key = `${signal.pair}_${signal.direction}`;

        // ðŸ†• First time seeing this pair
        if (!signalState[key]) {
          signalState[key] = {
            pair: signal.pair,
            direction: signal.direction,
            current: signal,
            previous: null,
            history: [signal],
            updates: 0
          };
          return;
        }

        const state = signalState[key];

        // Only update if newer
        if (new Date(signal.timestamp) > new Date(state.current.timestamp)) {

          state.previous = state.current;
          state.current = signal;
          state.history.unshift(signal);
          state.updates++;
          
          // Mark this card as just updated
          justUpdated.push(key);

          // Keep only last 10 history items
          if (state.history.length > 10) {
            state.history.length = 10;
          }
        }

      });

      const cards = Object.values(signalState)
        .filter(s => s.direction === signalState[s.pair + "_" + s.direction]?.direction)
        .sort((a, b) => new Date(b.current.timestamp) - new Date(a.current.timestamp));

      if (cards.length === 0) {
        showEmpty('signalsGrid', 'radio', 'No signals', `No ${mode} signals`);
        return;
      }

      g.innerHTML = cards.map(state => createSignalCard(state, justUpdated.includes(`${state.pair}_${state.direction}`))).join('');
      lucide.createIcons();
      
      // Scroll to first updated card if any
      if (justUpdated.length > 0) {
        setTimeout(() => {
          const firstUpdated = document.querySelector('.card.just-updated');
          if (firstUpdated) {
            firstUpdated.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);
      }
    }
    
    // âœ… CREATE SIGNAL CARD with change tracking
    function createSignalCard(state, justUpdated = false) {
      const s = state.current;
      const prev = state.previous;
      const hasChanges = prev !== null;
      
      // Calculate changes
      const changes = hasChanges ? {
        entry: calcChange(prev.entry_price, s.entry_price),
        sl: calcChange(prev.sl, s.sl),
        tp: calcChange(prev.tp, s.tp),
        rr: calcChange(prev.risk_reward, s.risk_reward)
      } : null;
      
      // Strength meter
      const sc = s.score || 50;
      const sp = Math.min(100, sc);
      const c = 2 * Math.PI * 23;
      const off = c - (sp / 100) * c;
      let col = '#6b7280';
      if (sc >= 80) col = '#fbbf24';
      else if (sc >= 70) col = '#00f2a9';
      else if (sc >= 60) col = '#4facfe';
      
      return `<div class="card${justUpdated ? ' just-updated' : ''}" id="card-${s.pair.replace('/', '-')}-${s.direction}">
        ${state.updates > 0 ? `<div class="update-badge">
          <i data-lucide="refresh-cw" style="width:12px;height:12px"></i>
          UPDATED ${state.updates}x
        </div>` : ''}
        
        <div class="strength">
          <svg viewBox="0 0 50 50">
            <circle class="strength-bg" cx="25" cy="25" r="23"></circle>
            <circle class="strength-bar" cx="25" cy="25" r="23" stroke="${col}" stroke-dasharray="${c}" stroke-dashoffset="${off}"></circle>
          </svg>
          <div class="strength-text" style="color:${col}">${sc}</div>
        </div>
        
        <div class="signal-tier tier-${getTier(s.tier||'C')}">${s.tier||'C'}</div>
        <div class="pair">${s.pair}</div>
        <div class="dir dir-${s.direction.toLowerCase()}">
          <i data-lucide="${s.direction==='BUY'?'arrow-up':'arrow-down'}" style="width:14px;height:14px"></i>
          ${s.direction}
        </div>
        
        <div class="section-title">
          <i data-lucide="trending-up" style="width:14px;height:14px"></i>
          CURRENT VALUES
        </div>
        <div class="metrics-grid">
          <div class="metric-item">
            <div class="metric-item-label">ENTRY</div>
            <div class="metric-item-value">${s.entry_price?.toFixed(5)||'N/A'}</div>
          </div>
          <div class="metric-item">
            <div class="metric-item-label">STOP LOSS</div>
            <div class="metric-item-value">${s.sl?.toFixed(5)||'N/A'}</div>
          </div>
          <div class="metric-item">
            <div class="metric-item-label">TAKE PROFIT</div>
            <div class="metric-item-value">${s.tp?.toFixed(5)||'N/A'}</div>
          </div>
          <div class="metric-item">
            <div class="metric-item-label">RISK:REWARD</div>
            <div class="metric-item-value hl">${s.risk_reward?.toFixed(2)||'N/A'}</div>
          </div>
        </div>
        
        ${hasChanges ? `
        <div class="changes-section">
          <div class="section-title" style="margin:0 0 12px 0">
            <i data-lucide="git-compare" style="width:14px;height:14px"></i>
            CHANGES FROM PREVIOUS
          </div>
          ${renderChange('Entry', changes.entry)}
          ${renderChange('Stop Loss', changes.sl)}
          ${renderChange('Take Profit', changes.tp)}
          ${renderChange('Risk:Reward', changes.rr)}
        </div>
        ` : ''}
        
        ${state.history.length > 1 ? `
        <div class="history-section">
          <div class="section-title" style="margin:0 0 12px 0">
            <i data-lucide="clock" style="width:14px;height:14px"></i>
            SIGNAL HISTORY (${state.history.length} updates)
          </div>
          ${state.history.slice(0, 3).map(h => `
            <div class="history-item">
              <span class="history-time">${fmt(h.timestamp)}</span>
              <span class="history-value">Entry ${h.entry_price?.toFixed(5)}</span>
            </div>
          `).join('')}
        </div>
        ` : ''}
        
        <div class="footer">
          <div class="time">
            <i data-lucide="clock" style="width:12px;height:12px"></i>
            ${fmt(s.timestamp)}
          </div>
          <div class="session">${s.session||'N/A'}</div>
        </div>
      </div>`;
    }
    
    // âœ… Calculate change between two values
    function calcChange(oldVal, newVal) {
      if (!oldVal || !newVal) return { diff: 0, dir: 'neutral', pct: 0 };
      
      const diff = newVal - oldVal;
      const pct = (diff / oldVal) * 100;
      
      return {
        diff: diff,
        dir: diff > 0 ? 'up' : diff < 0 ? 'down' : 'neutral',
        pct: pct
      };
    }
    
    // âœ… Render change indicator (showing all changes, including zero)
    function renderChange(label, change) {
      if (!change) return '';
      
      const arrow = change.dir === 'up' ? 'â†‘' : change.dir === 'down' ? 'â†“' : '=';
      const sign = change.diff > 0 ? '+' : '';
      
      return `
        <div class="change-item">
          <span class="change-label">${label}:</span>
          <span class="change-value ${change.dir}">
            <span class="change-arrow">${arrow}</span>
            ${sign}${Math.abs(change.diff).toFixed(5)}
          </span>
        </div>
      `;
    }
    
    function renderHistory() {
      const b = document.getElementById('historyBody');
      let sigs = data?.historical_signals || [];
      
      if (sigs.length === 0) {
        b.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">No historical data available</td></tr>';
        return;
      }
      
      sigs = sigs.filter(s => s.status && ['WIN', 'LOSS', 'EXPIRED'].includes(s.status));
      
      const sf = document.getElementById('filterStatus')?.value || 'all';
      const pf = document.getElementById('filterPair')?.value || 'all';
      const sd = document.getElementById('dateStart')?.value;
      const ed = document.getElementById('dateEnd')?.value;
      
      if (sf !== 'all') sigs = sigs.filter(s => s.status === sf);
      if (pf !== 'all') sigs = sigs.filter(s => s.pair === pf);
      if (sd) sigs = sigs.filter(s => s.timestamp >= sd);
      if (ed) sigs = sigs.filter(s => s.timestamp <= ed + 'T23:59:59');
      
      sigs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      if (sigs.length === 0) {
        b.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">No signals match the filters</td></tr>';
        return;
      }
      
      b.innerHTML = sigs.map(s => {
        const rc = s.status === 'WIN' ? 'win' : s.status === 'LOSS' ? 'loss' : 'exp';
        const pv = s.pips || 0;
        const rt = s.status === 'WIN' ? `+${pv.toFixed(1)}` : s.status === 'LOSS' ? `${pv.toFixed(1)}` : 'EXPIRED';
        return `<tr><td>${fmtDate(s.timestamp)}</td><td style="font-weight:900">${s.pair}</td><td>${s.direction}</td><td><span class="history-tier-badge tier-${getTier(s.tier || 'C')}">${s.tier || 'C'}</span></td><td class="${rc}">${s.status}</td><td class="${rc}">${rt}</td><td>${s.session || 'N/A'}</td></tr>`;
      }).join('');
      
      updatePairFilter(sigs);
    }
    
    function renderAnalytics() {
      if (!data) return;
      const an = data.performance_stats || data.analytics || {};
      renderTier(an.by_tier || {});
      renderSess(an.by_session || {});
      renderPair(an.by_pair || {});
      renderMode(an.by_mode || {});
    }
    
    function renderTier(ts) {
      const c = document.getElementById('tierAnalytics');
      const tiers = ['A+', 'A', 'B', 'C'];
      
      c.innerHTML = tiers.map(t => {
        const d = ts[t] || {trades: 0, wins: 0, losses: 0, win_rate: 0, total_pips: 0, avg_pips: 0};
        const wr = d.win_rate || 0;
        
        return `<div class="analytics-item">
          <div>
            <span class="analytics-tier-badge tier-${getTier(t)}">Tier ${t}</span>
            <span class="analytics-label">${d.trades} trades</span>
          </div>
          <div class="analytics-value" style="color:${wr >= 60 ? 'var(--green)' : 'var(--text)'}">${wr.toFixed(1)}%</div>
        </div>
        <div class="progress"><div class="progress-bar" style="width:${wr}%"></div></div>`;
      }).join('');
    }
    
    function renderSess(ss) {
      const c = document.getElementById('sessionAnalytics');
      const ses = Object.keys(ss).sort();
      c.innerHTML = ses.map(s => {
        const d = ss[s];
        const wr = d.win_rate || 0;
        return `<div class="analytics-item"><div class="analytics-label">${s}</div><div class="analytics-value">${d.trades} trades â€¢ ${wr.toFixed(1)}%</div></div><div class="progress"><div class="progress-bar" style="width:${wr}%"></div></div>`;
      }).join('');
    }
    
    function renderPair(ps) {
      const c = document.getElementById('pairAnalytics');
      const pairs = Object.entries(ps).sort((a, b) => (b[1].total_pips || 0) - (a[1].total_pips || 0)).slice(0, 10);
      if (pairs.length === 0) {
        c.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px">No data available</p>';
        return;
      }
      c.innerHTML = pairs.map(([p, d]) => {
        const pips = d.total_pips || 0;
        const wr = d.win_rate || 0;
        return `<div class="analytics-item"><div class="analytics-label" style="font-weight:800">${p}</div><div class="analytics-value" style="color:${pips > 0 ? 'var(--green)' : 'var(--red)'}">${pips > 0 ? '+' : ''}${pips.toFixed(1)} pips</div></div><div style="font-size:12px;color:var(--text-dim);margin-top:4px">${d.trades} trades â€¢ ${wr.toFixed(1)}% WR</div>`;
      }).join('');
    }
    
    function renderMode(ms) {
      const c = document.getElementById('modeAnalytics');
      const modes = ['all', 'aggressive', 'conservative'];
      c.innerHTML = modes.map(m => {
        const d = ms[m] || {trades: 0, wins: 0, win_rate: 0, total_pips: 0};
        const wr = d.win_rate || 0;
        const pips = d.total_pips || 0;
        return `<div class="analytics-item"><div class="analytics-label" style="text-transform:uppercase;font-weight:800">${m}</div><div class="analytics-value">${d.trades} trades</div></div><div style="display:flex;justify-content:space-between;margin-top:12px;font-size:14px"><span style="color:var(--text-dim)">Win Rate: ${wr.toFixed(1)}%</span><span style="color:${pips > 0 ? 'var(--green)' : 'var(--red)'};font-weight:900">${pips > 0 ? '+' : ''}${pips.toFixed(1)} pips</span></div><div class="progress"><div class="progress-bar" style="width:${wr}%"></div></div>`;
      }).join('');
    }
    
    function initFilters() {
      const ed = document.getElementById('dateEnd');
      const sd = document.getElementById('dateStart');
      const today = new Date().toISOString().split('T')[0];
      const week = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      ed.value = today;
      sd.value = week;
      ed.addEventListener('change', renderHistory);
      sd.addEventListener('change', renderHistory);
      document.getElementById('filterStatus').addEventListener('change', renderHistory);
      document.getElementById('filterPair').addEventListener('change', renderHistory);
    }
    
    function updatePairFilter(sigs) {
      const pairs = [...new Set(sigs.map(s => s.pair))].sort();
      const sel = document.getElementById('filterPair');
      const cv = sel.value;
      sel.innerHTML = '<option value="all">All Pairs</option>' + pairs.map(p => `<option value="${p}">${p}</option>`).join('');
      sel.value = cv;
    }
    
    function updateSess() {
      const now = new Date();
      const h = now.getUTCHours();
      let s = 'LATE_US';
      if (h >= 0 && h < 7) s = 'ASIAN';
      else if (h >= 7 && h < 12) s = 'EUROPEAN';
      else if (h >= 12 && h < 17) s = 'OVERLAP';
      else if (h >= 17 && h < 22) s = 'US';
      document.getElementById('mSession').textContent = s;
      document.getElementById('mTime').textContent = now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', timeZone:'UTC'}) + ' UTC';
    }
    
    function getTier(t) {
      if (!t) return 'c';
      return t === 'A+' ? 'aplus' : t.toLowerCase();
    }
    
    function fmt(ts) {
      if (!ts) return 'N/A';
      const d = new Date(ts);
      return d.toLocaleString('en-US', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
    }
    
    function fmtDate(ts) {
      if (!ts) return 'N/A';
      const d = new Date(ts);
      return d.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
    }
    
    function showEmpty(cid, icon, title, desc) {
      document.getElementById(cid).innerHTML = `<div class="empty"><i data-lucide="${icon}" class="empty-icon"></i><div class="empty-title">${title}</div><div class="empty-desc">${desc}</div></div>`;
      lucide.createIcons();
    }
    
    // âœ… WEEKLY REPLAY ANIMATION
    let isReplaying = false;
    
    function getWeeklySignals() {
      if (!data) return [];
      const now = new Date();
      const startOfWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); // 7 days ago
      
      const aggSignals = data.signals_by_mode?.aggressive || [];
      const consSignals = data.signals_by_mode?.conservative || [];
      const allSignals = [...aggSignals, ...consSignals];
      
      // Deduplicate and filter by week
      const seen = new Set();
      const weeklySignals = [];
      
      allSignals.forEach(s => {
        if (s.signal_id && !seen.has(s.signal_id) && new Date(s.timestamp) >= startOfWeek) {
          seen.add(s.signal_id);
          weeklySignals.push(s);
        }
      });
      
      // Sort oldest first for chronological replay
      return weeklySignals.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    }
    
    async function playWeeklyReplay() {
      if (isReplaying) return;
      
      isReplaying = true;
      const btn = document.getElementById('replayBtn');
      const progress = document.getElementById('replayProgress');
      const bar = document.getElementById('replayBar');
      
      // Change button state
      btn.innerHTML = '<i data-lucide="pause" style="width:14px;height:14px"></i>REPLAYING...';
      btn.disabled = true;
      btn.style.opacity = '0.6';
      progress.style.display = 'block';
      lucide.createIcons();
      
      const signals = getWeeklySignals();
      
      if (signals.length === 0) {
        alert('No signals from the past week to replay!');
        resetReplayButton();
        return;
      }
      
      const grid = document.getElementById('signalsGrid');
      const tempState = {}; // Temporary state for replay
      
      // Clear grid and start replay
      grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim);font-size:18px;font-weight:700;">ðŸ“½ï¸ Starting Weekly Replay...</div>';
      
      await new Promise(r => setTimeout(r, 1000));
      
      for (let i = 0; i < signals.length; i++) {
        const s = signals[i];
        const key = `${s.pair}_${s.direction}`;
        
        const justUpdated = [];
        
        if (!tempState[key]) {
          tempState[key] = {
            pair: s.pair,
            direction: s.direction,
            current: s,
            previous: null,
            history: [s],
            updates: 0
          };
        } else {
          const state = tempState[key];
          state.previous = state.current;
          state.current = s;
          state.history.unshift(s);
          state.updates++;
          justUpdated.push(key);
          
          if (state.history.length > 10) state.history.length = 10;
        }
        
        // Render current state
        const cards = Object.values(tempState).sort((a, b) => 
          new Date(b.current.timestamp) - new Date(a.current.timestamp)
        );
        
        grid.innerHTML = cards.map(state => 
          createSignalCard(state, justUpdated.includes(`${state.pair}_${state.direction}`))
        ).join('');
        lucide.createIcons();
        
        // Update progress bar
        bar.style.width = ((i + 1) / signals.length * 100) + '%';
        
        // Scroll to updated card if any
        if (justUpdated.length > 0) {
          const firstUpdated = document.querySelector('.card.just-updated');
          if (firstUpdated) {
            firstUpdated.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
        
        // Show timestamp in console
        console.log(`ðŸŽ¬ Replay [${i + 1}/${signals.length}]: ${s.pair} ${s.direction} at ${fmt(s.timestamp)}`);
        
        // Delay between signals (faster for more signals)
        const delay = signals.length > 20 ? 500 : 800;
        await new Promise(r => setTimeout(r, delay));
      }
      
      // Replay complete
      await new Promise(r => setTimeout(r, 1000));
      grid.innerHTML = '<div style="text-align:center;padding:60px 40px;background:var(--surface);border:1px solid var(--border);border-radius:16px;"><i data-lucide="check-circle" style="width:64px;height:64px;color:var(--green);margin:0 auto 20px;display:block;"></i><div style="font-size:24px;font-weight:900;color:var(--green);margin-bottom:12px;">Weekly Replay Complete!</div><div style="font-size:14px;color:var(--text-dim);">Replayed ${signals.length} signals from the past 7 days</div></div>';
      lucide.createIcons();
      
      // Reset after 3 seconds
      await new Promise(r => setTimeout(r, 3000));
      processAndRenderSignals(); // Return to normal view
      resetReplayButton();
    }
    
    function resetReplayButton() {
      isReplaying = false;
      const btn = document.getElementById('replayBtn');
      const progress = document.getElementById('replayProgress');
      const bar = document.getElementById('replayBar');
      
      if (btn) {
        btn.innerHTML = '<i data-lucide="play" style="width:14px;height:14px"></i>PLAY WEEKLY REPLAY';
        btn.disabled = false;
        btn.style.opacity = '1';
      }
      if (progress) progress.style.display = 'none';
      if (bar) bar.style.width = '0%';
      
      lucide.createIcons();
    }
  </script>
</body>
</html>
