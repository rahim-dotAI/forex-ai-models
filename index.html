<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trade Beacon | Intelligence Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --void: #0a0a0f; --surface: #1a1a24; --elevated: #232334;
      --orange: #ff6b35; --blue: #4facfe; --green: #00f2a9; --red: #ff4757; --yellow: #fbbf24;
      --text: #ffffff; --text-dim: #b8bdc9; --text-muted: #6b7280;
      --border: rgba(255,255,255,0.1);
      --shadow: 0 10px 40px rgba(0,0,0,0.4);
      --glow-orange: 0 0 30px rgba(255,107,53,0.4);
    }
    
    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--void);
      color: var(--text);
      line-height: 1.5;
      overflow-x: hidden;
    }
    
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 20% 30%, rgba(255,107,53,0.08) 0%, transparent 50%),
                  radial-gradient(circle at 80% 70%, rgba(79,172,254,0.08) 0%, transparent 50%);
      pointer-events: none;
      animation: pulse 15s ease-in-out infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    
    .candles { position: fixed; top: 0; right: 0; width: 400px; height: 100%; opacity: 0.03; pointer-events: none; }
    .candle { position: absolute; width: 20px; background: var(--green); animation: rise 4s ease-in-out infinite; }
    .candle:nth-child(1) { left: 50px; }
    .candle:nth-child(2) { left: 100px; animation-delay: 0.5s; background: var(--red); }
    .candle:nth-child(3) { left: 150px; animation-delay: 1s; }
    .candle:nth-child(4) { left: 200px; animation-delay: 1.5s; background: var(--red); }
    .candle:nth-child(5) { left: 250px; animation-delay: 2s; }
    @keyframes rise { 0%, 100% { height: 60%; bottom: 20%; } 50% { height: 80%; bottom: 10%; } }
    
    .container { max-width: 1920px; margin: 0 auto; padding: 24px; position: relative; z-index: 1; }
    
    .header {
      background: linear-gradient(135deg, var(--surface), var(--elevated));
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 32px;
      margin-bottom: 32px;
      overflow: hidden;
      box-shadow: var(--shadow);
      position: relative;
    }
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--orange), var(--blue), var(--green));
      box-shadow: var(--glow-orange);
    }
    
    .header-grid { display: grid; grid-template-columns: auto 1fr auto; gap: 40px; align-items: center; }
    
    .brand { display: flex; align-items: center; gap: 20px; }
    .brand-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--orange), #ff8c61);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--glow-orange);
      animation: iconPulse 3s ease-in-out infinite;
    }
    @keyframes iconPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .brand-icon svg { width: 36px; height: 36px; color: white; }
    
    .brand-text h1 {
      font-family: 'Orbitron', monospace;
      font-size: 32px;
      font-weight: 900;
      letter-spacing: 2px;
      background: linear-gradient(135deg, var(--orange), var(--blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-transform: uppercase;
    }
    .brand-text p { font-size: 12px; color: var(--text-dim); font-weight: 600; letter-spacing: 1px; margin-top: 4px; }
    
    .header-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .mini-stat {
      text-align: center;
      padding: 16px;
      background: rgba(255,107,53,0.1);
      border: 1px solid rgba(255,107,53,0.2);
      border-radius: 12px;
      transition: all 0.3s;
    }
    .mini-stat:hover { background: rgba(255,107,53,0.15); transform: translateY(-2px); }
    .mini-stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
    .mini-stat-value { font-family: 'Orbitron', monospace; font-size: 20px; font-weight: 900; color: var(--orange); margin-top: 4px; }
    
    .status-badge {
      padding: 12px 20px;
      background: rgba(0,242,169,0.1);
      border: 1px solid rgba(0,242,169,0.3);
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      color: var(--green);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      background: var(--green);
      border-radius: 50%;
      box-shadow: 0 0 10px var(--green);
      animation: pulseDot 2s ease-in-out infinite;
    }
    @keyframes pulseDot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .metric {
      background: linear-gradient(135deg, var(--surface), var(--elevated));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .metric::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--orange), var(--blue));
      transform: scaleX(0);
      transition: transform 0.4s;
    }
    .metric:hover { transform: translateY(-8px); border-color: rgba(255,255,255,0.2); box-shadow: var(--glow-orange); }
    .metric:hover::before { transform: scaleX(1); }
    
    .metric-icon {
      width: 48px;
      height: 48px;
      background: rgba(255,107,53,0.15);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
    .metric-icon svg { width: 24px; height: 24px; color: var(--orange); }
    
    .metric-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 700; }
    .metric-value {
      font-family: 'Orbitron', monospace;
      font-size: 32px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--orange), var(--blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 8px 0;
    }
    .metric-sub { font-size: 12px; color: var(--text-dim); font-weight: 500; }
    
    .modes {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 8px;
      width: fit-content;
    }
    .mode-btn {
      padding: 14px 32px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      background: transparent;
      color: var(--text-dim);
      font-family: 'Rajdhani', sans-serif;
      display: flex;
      align-items: center;
      gap: 8px;
      letter-spacing: 1px;
    }
    .mode-btn.active {
      background: linear-gradient(135deg, var(--orange), #ff8c61);
      color: white;
      box-shadow: var(--glow-orange);
    }
    .mode-btn:not(.active):hover { background: rgba(255,107,53,0.1); color: var(--orange); }
    
    .tabs { display: flex; gap: 8px; margin-bottom: 32px; border-bottom: 2px solid var(--border); }
    .tab {
      padding: 16px 28px;
      border: none;
      background: transparent;
      color: var(--text-dim);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      border-radius: 12px 12px 0 0;
      transition: all 0.3s;
      font-family: 'Rajdhani', sans-serif;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
      letter-spacing: 1px;
    }
    .tab::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--orange), var(--blue));
      transform: scaleX(0);
      transition: transform 0.3s;
    }
    .tab.active { color: var(--orange); background: rgba(255,107,53,0.1); }
    .tab.active::after { transform: scaleX(1); }
    
    .tab-content { display: none; animation: fadeIn 0.5s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* âœ… SMART SIGNAL CARDS */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); gap: 20px; }
    
    .card {
      background: linear-gradient(135deg, var(--surface), var(--elevated));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--orange), var(--blue), var(--green));
    }
    .card:hover { transform: translateY(-8px) scale(1.02); border-color: rgba(255,255,255,0.2); box-shadow: var(--glow-orange); }
    
    /* Updated badge */
    .update-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 6px 12px;
      background: linear-gradient(135deg, var(--yellow), #f59e0b);
      border-radius: 8px;
      font-size: 10px;
      font-weight: 900;
      color: #78350f;
      display: flex;
      align-items: center;
      gap: 6px;
      animation: pulse 2s ease-in-out infinite;
    }
    
    .signal-tier {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      font-weight: 900;
      color: white;
      margin-bottom: 12px;
    }
    .signal-tier.tier-aplus { background: linear-gradient(135deg, #fbbf24, #f59e0b); box-shadow: 0 0 20px rgba(251,191,36,0.5); }
    .signal-tier.tier-a { background: linear-gradient(135deg, var(--green), #00c787); box-shadow: 0 0 20px rgba(0,242,169,0.4); }
    .signal-tier.tier-b { background: linear-gradient(135deg, var(--blue), #3a8bd6); box-shadow: 0 0 20px rgba(79,172,254,0.4); }
    .signal-tier.tier-c { background: linear-gradient(135deg, #6b7280, #4b5563); }
    
    .strength {
      position: absolute;
      top: 24px;
      left: 24px;
      width: 50px;
      height: 50px;
    }
    .strength svg { transform: rotate(-90deg); }
    .strength-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 5; }
    .strength-bar { fill: none; stroke-width: 5; stroke-linecap: round; transition: stroke-dashoffset 1s ease-out; }
    .strength-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      font-weight: 900;
    }
    
    .pair {
      font-family: 'Orbitron', monospace;
      font-size: 28px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--orange), var(--blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      padding-left: 60px;
    }
    
    .dir {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: 1px;
      margin-bottom: 16px;
      margin-left: 60px;
    }
    .dir-buy { background: linear-gradient(135deg, var(--green), #33f5bf); color: white; box-shadow: 0 0 20px rgba(0,242,169,0.4); }
    .dir-sell { background: linear-gradient(135deg, var(--red), #ff6b7a); color: white; box-shadow: 0 0 20px rgba(255,71,87,0.4); }
    
    /* Current values section */
    .section-title {
      font-size: 12px;
      font-weight: 900;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 20px 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
    .metric-item {
      background: #121218;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      overflow: hidden;
    }
    .metric-item-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; margin-bottom: 4px; }
    .metric-item-value { font-family: 'Orbitron', monospace; font-size: 16px; font-weight: 700; color: white; word-break: break-all; }
    .metric-item-value.hl { color: var(--orange); }
    
    /* âœ… CHANGES SECTION */
    .changes-section {
      background: rgba(0,242,169,0.05);
      border: 1px solid rgba(0,242,169,0.2);
      border-radius: 10px;
      padding: 14px;
      margin: 16px 0;
    }
    
    .change-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .change-item:last-child { border-bottom: none; }
    
    .change-label {
      color: var(--text-dim);
      font-weight: 600;
    }
    
    .change-value {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: 'Orbitron', monospace;
      font-weight: 900;
    }
    .change-value.up { color: var(--green); }
    .change-value.down { color: var(--red); }
    .change-value.neutral { color: var(--text-muted); }
    
    .change-arrow {
      font-size: 16px;
      line-height: 1;
    }
    
    /* âœ… HISTORY SECTION */
    .history-section {
      background: rgba(79,172,254,0.05);
      border: 1px solid rgba(79,172,254,0.2);
      border-radius: 10px;
      padding: 14px;
      margin: 16px 0;
    }
    
    .history-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 11px;
      color: var(--text-dim);
    }
    .history-item::before {
      content: 'â€¢';
      color: var(--blue);
      font-size: 16px;
      line-height: 1;
    }
    .history-time {
      font-family: 'Orbitron', monospace;
      color: var(--blue);
      font-weight: 700;
    }
    .history-value {
      font-family: 'Orbitron', monospace;
      color: var(--text);
    }
    
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .time {
      font-size: 11px;
      color: var(--text-dim);
      font-family: 'Orbitron', monospace;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .session {
      padding: 4px 10px;
      background: rgba(79,172,254,0.1);
      border: 1px solid rgba(79,172,254,0.3);
      border-radius: 6px;
      font-size: 10px;
      font-weight: 900;
      color: var(--blue);
      letter-spacing: 0.5px;
    }
    
    .empty {
      text-align: center;
      padding: 80px 40px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
    }
    .empty-icon { width: 64px; height: 64px; margin: 0 auto 20px; color: var(--text-muted); }
    .empty-title { font-size: 20px; font-weight: 900; color: var(--text-dim); margin-bottom: 8px; }
    .empty-desc { font-size: 14px; color: var(--text-muted); }
    
    @media (max-width: 768px) {
      .header-grid { grid-template-columns: 1fr; }
      .metrics { grid-template-columns: repeat(2, 1fr); }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="candles">
    <div class="candle"></div><div class="candle"></div><div class="candle"></div><div class="candle"></div><div class="candle"></div>
  </div>

  <div class="container">
    <header class="header">
      <div class="header-grid">
        <div class="brand">
          <div class="brand-icon"><i data-lucide="activity"></i></div>
          <div class="brand-text">
            <h1>TRADE BEACON</h1>
            <p>MARKET INTELLIGENCE v2.1.3</p>
          </div>
        </div>
        <div class="header-stats">
          <div class="mini-stat"><div class="mini-stat-label">ACTIVE</div><div class="mini-stat-value" id="hActive">0</div></div>
          <div class="mini-stat"><div class="mini-stat-label">WIN RATE</div><div class="mini-stat-value" id="hWR">0%</div></div>
          <div class="mini-stat"><div class="mini-stat-label">PIPS</div><div class="mini-stat-value" id="hPips">0</div></div>
        </div>
        <div class="status-badge"><div class="status-dot"></div><span>LIVE MARKET</span></div>
      </div>
    </header>

    <div class="metrics">
      <div class="metric"><div class="metric-icon"><i data-lucide="signal"></i></div><div class="metric-label">Active Signals</div><div class="metric-value" id="mSignals">0</div><div class="metric-sub">Multi-mode</div></div>
      <div class="metric"><div class="metric-icon"><i data-lucide="target"></i></div><div class="metric-label">Win Rate</div><div class="metric-value" id="mWR">0%</div><div class="metric-sub" id="mWRSub">No trades</div></div>
      <div class="metric"><div class="metric-icon"><i data-lucide="trending-up"></i></div><div class="metric-label">Total Pips</div><div class="metric-value" id="mPips">0</div><div class="metric-sub" id="mPipsSub">Lifetime</div></div>
      <div class="metric"><div class="metric-icon"><i data-lucide="bar-chart-3"></i></div><div class="metric-label">Expectancy</div><div class="metric-value" id="mExp">0</div><div class="metric-sub">Pips per trade</div></div>
      <div class="metric"><div class="metric-icon"><i data-lucide="calendar"></i></div><div class="metric-label">Today</div><div class="metric-value" id="mToday">0</div><div class="metric-sub" id="mTodaySub">Signals</div></div>
      <div class="metric"><div class="metric-icon"><i data-lucide="globe-2"></i></div><div class="metric-label">Session</div><div class="metric-value" id="mSession" style="font-size:20px">---</div><div class="metric-sub" id="mTime">---</div></div>
    </div>

    <div class="modes">
      <button class="mode-btn active" id="modeAgg" onclick="switchMode('aggressive')"><i data-lucide="zap" style="width:16px;height:16px"></i>AGGRESSIVE</button>
      <button class="mode-btn" id="modeCon" onclick="switchMode('conservative')"><i data-lucide="shield" style="width:16px;height:16px"></i>CONSERVATIVE</button>
    </div>

    <nav class="tabs">
      <button class="tab active" onclick="switchTab('signals')"><i data-lucide="radio" style="width:16px;height:16px"></i>LIVE SIGNALS</button>
      <button class="tab" onclick="switchTab('history')"><i data-lucide="history" style="width:16px;height:16px"></i>HISTORY</button>
      <button class="tab" onclick="switchTab('analytics')"><i data-lucide="pie-chart" style="width:16px;height:16px"></i>ANALYTICS</button>
    </nav>

    <div id="tabSignals" class="tab-content active">
      <div class="grid" id="signalsGrid"></div>
    </div>

    <div id="tabHistory" class="tab-content">
      <p style="text-align:center;padding:40px;color:var(--text-muted)">History view - Coming soon</p>
    </div>

    <div id="tabAnalytics" class="tab-content">
      <p style="text-align:center;padding:40px;color:var(--text-muted)">Analytics view - Coming soon</p>
    </div>
  </div>

  <script>
    lucide.createIcons();
    let mode = 'aggressive';
    let data = null;
    let signalState = {}; // âœ… Store signal tracking per pair - PERSISTS across refreshes
    
    document.addEventListener('DOMContentLoaded', () => {
      mode = localStorage.getItem('tbMode') || 'aggressive';
      updateModeBtns();
      load();
      setInterval(load, 30000);
      updateSess();
      setInterval(updateSess, 60000);
    });
    
    async function load() {
      try {
        const r = await fetch('signal_state/dashboard_state.json');
        data = await r.json();
        console.log('ðŸ“Š Dashboard data loaded');
        updateMetrics();
        processAndRenderSignals();
      } catch(e) {
        console.error('Load error:', e);
        showEmpty('signalsGrid', 'alert-triangle', 'Unable to load', 'Check system');
      }
    }
    
    function switchMode(m) {
      mode = m;
      localStorage.setItem('tbMode', m);
      updateModeBtns();
      processAndRenderSignals();
      lucide.createIcons();
    }
    
    function updateModeBtns() {
      document.getElementById('modeAgg').classList.toggle('active', mode === 'aggressive');
      document.getElementById('modeCon').classList.toggle('active', mode === 'conservative');
      lucide.createIcons();
    }
    
    function switchTab(t) {
      document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
      event.target.closest('.tab').classList.add('active');
      document.getElementById({signals:'tabSignals', history:'tabHistory', analytics:'tabAnalytics'}[t]).classList.add('active');
      lucide.createIcons();
    }
    
    function updateMetrics() {
      if (!data) return;
      
      // Count unique pairs (not signals)
      const aggSignals = data.signals_by_mode?.aggressive || [];
      const consSignals = data.signals_by_mode?.conservative || [];
      const allSignals = [...aggSignals, ...consSignals];
      
      // Get unique pairs
      const uniquePairs = new Set(allSignals.map(s => s.pair));
      const uniqueCount = uniquePairs.size;
      
      const st = data.stats || {};
      const wr = st.win_rate || 0, tp = st.total_pips || 0, ex = st.expectancy || 0, tt = st.total_trades || 0;
      
      document.getElementById('hActive').textContent = uniqueCount;
      document.getElementById('hWR').textContent = wr.toFixed(1) + '%';
      document.getElementById('hPips').textContent = tp > 0 ? '+' + tp.toFixed(0) : tp.toFixed(0);
      document.getElementById('mSignals').textContent = uniqueCount;
      document.getElementById('mWR').textContent = wr.toFixed(1) + '%';
      document.getElementById('mWRSub').textContent = `${st.wins||0}/${tt} trades`;
      document.getElementById('mPips').textContent = tp > 0 ? '+' + tp.toFixed(1) : tp.toFixed(1);
      document.getElementById('mPipsSub').textContent = tt > 0 ? `From ${tt} trades` : 'Lifetime';
      document.getElementById('mExp').textContent = ex > 0 ? '+' + ex.toFixed(1) : ex.toFixed(1);
      
      const today = new Date().toISOString().split('T')[0];
      const tc = allSignals.filter(s => s.timestamp && s.timestamp.startsWith(today)).length;
      document.getElementById('mToday').textContent = uniquePairs.size;
      document.getElementById('mTodaySub').textContent = uniquePairs.size === 0 ? 'No signals' : 'Generated today';
    }
    
    // âœ… SMART SIGNAL PROCESSING - Persists state across refreshes
    function processAndRenderSignals() {
      const g = document.getElementById('signalsGrid');
      if (!data) {
        g.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)">Loading...</div>';
        return;
      }

      let sigs = data.signals_by_mode?.[mode] || [];

      console.log(`ðŸŽ¯ Processing ${mode} signals:`, sigs.length);

      // Sort newest first
      sigs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      sigs.forEach(signal => {

        const key = `${signal.pair}_${signal.direction}`;

        // ðŸ†• First time seeing this pair
        if (!signalState[key]) {
          signalState[key] = {
            pair: signal.pair,
            direction: signal.direction,
            current: signal,
            previous: null,
            history: [signal],
            updates: 0
          };
          return;
        }

        const state = signalState[key];

        // Only update if newer
        if (new Date(signal.timestamp) > new Date(state.current.timestamp)) {

          state.previous = state.current;
          state.current = signal;
          state.history.unshift(signal);
          state.updates++;

          // Keep only last 10 history items
          if (state.history.length > 10) {
            state.history.length = 10;
          }
        }

      });

      const cards = Object.values(signalState)
        .filter(s => s.direction === signalState[s.pair + "_" + s.direction]?.direction)
        .sort((a, b) => new Date(b.current.timestamp) - new Date(a.current.timestamp));

      if (cards.length === 0) {
        showEmpty('signalsGrid', 'radio', 'No signals', `No ${mode} signals`);
        return;
      }

      g.innerHTML = cards.map(state => createSignalCard(state)).join('');
      lucide.createIcons();
    }
    
    // âœ… CREATE SIGNAL CARD with change tracking
    function createSignalCard(state) {
      const s = state.current;
      const prev = state.previous;
      const hasChanges = prev !== null;
      
      // Calculate changes
      const changes = hasChanges ? {
        entry: calcChange(prev.entry_price, s.entry_price),
        sl: calcChange(prev.sl, s.sl),
        tp: calcChange(prev.tp, s.tp),
        rr: calcChange(prev.risk_reward, s.risk_reward)
      } : null;
      
      // Strength meter
      const sc = s.score || 50;
      const sp = Math.min(100, sc);
      const c = 2 * Math.PI * 23;
      const off = c - (sp / 100) * c;
      let col = '#6b7280';
      if (sc >= 80) col = '#fbbf24';
      else if (sc >= 70) col = '#00f2a9';
      else if (sc >= 60) col = '#4facfe';
      
      return `<div class="card">
        ${state.updates > 0 ? `<div class="update-badge">
          <i data-lucide="refresh-cw" style="width:12px;height:12px"></i>
          UPDATED ${state.updates}x
        </div>` : ''}
        
        <div class="strength">
          <svg viewBox="0 0 50 50">
            <circle class="strength-bg" cx="25" cy="25" r="23"></circle>
            <circle class="strength-bar" cx="25" cy="25" r="23" stroke="${col}" stroke-dasharray="${c}" stroke-dashoffset="${off}"></circle>
          </svg>
          <div class="strength-text" style="color:${col}">${sc}</div>
        </div>
        
        <div class="signal-tier tier-${getTier(s.tier||'C')}">${s.tier||'C'}</div>
        <div class="pair">${s.pair}</div>
        <div class="dir dir-${s.direction.toLowerCase()}">
          <i data-lucide="${s.direction==='BUY'?'arrow-up':'arrow-down'}" style="width:14px;height:14px"></i>
          ${s.direction}
        </div>
        
        <div class="section-title">
          <i data-lucide="trending-up" style="width:14px;height:14px"></i>
          CURRENT VALUES
        </div>
        <div class="metrics-grid">
          <div class="metric-item">
            <div class="metric-item-label">ENTRY</div>
            <div class="metric-item-value">${s.entry_price?.toFixed(5)||'N/A'}</div>
          </div>
          <div class="metric-item">
            <div class="metric-item-label">STOP LOSS</div>
            <div class="metric-item-value">${s.sl?.toFixed(5)||'N/A'}</div>
          </div>
          <div class="metric-item">
            <div class="metric-item-label">TAKE PROFIT</div>
            <div class="metric-item-value">${s.tp?.toFixed(5)||'N/A'}</div>
          </div>
          <div class="metric-item">
            <div class="metric-item-label">RISK:REWARD</div>
            <div class="metric-item-value hl">${s.risk_reward?.toFixed(2)||'N/A'}</div>
          </div>
        </div>
        
        ${hasChanges ? `
        <div class="changes-section">
          <div class="section-title" style="margin:0 0 12px 0">
            <i data-lucide="git-compare" style="width:14px;height:14px"></i>
            CHANGES FROM PREVIOUS
          </div>
          ${renderChange('Entry', changes.entry)}
          ${renderChange('Stop Loss', changes.sl)}
          ${renderChange('Take Profit', changes.tp)}
          ${renderChange('Risk:Reward', changes.rr)}
        </div>
        ` : ''}
        
        ${state.history.length > 1 ? `
        <div class="history-section">
          <div class="section-title" style="margin:0 0 12px 0">
            <i data-lucide="clock" style="width:14px;height:14px"></i>
            SIGNAL HISTORY (${state.history.length} updates)
          </div>
          ${state.history.slice(0, 3).map(h => `
            <div class="history-item">
              <span class="history-time">${fmt(h.timestamp)}</span>
              <span class="history-value">Entry ${h.entry_price?.toFixed(5)}</span>
            </div>
          `).join('')}
        </div>
        ` : ''}
        
        <div class="footer">
          <div class="time">
            <i data-lucide="clock" style="width:12px;height:12px"></i>
            ${fmt(s.timestamp)}
          </div>
          <div class="session">${s.session||'N/A'}</div>
        </div>
      </div>`;
    }
    
    // âœ… Calculate change between two values
    function calcChange(oldVal, newVal) {
      if (!oldVal || !newVal) return { diff: 0, dir: 'neutral', pct: 0 };
      
      const diff = newVal - oldVal;
      const pct = (diff / oldVal) * 100;
      
      return {
        diff: diff,
        dir: diff > 0 ? 'up' : diff < 0 ? 'down' : 'neutral',
        pct: pct
      };
    }
    
    // âœ… Render change indicator (showing all changes, including zero)
    function renderChange(label, change) {
      if (!change) return '';
      
      const arrow = change.dir === 'up' ? 'â†‘' : change.dir === 'down' ? 'â†“' : '=';
      const sign = change.diff > 0 ? '+' : '';
      
      return `
        <div class="change-item">
          <span class="change-label">${label}:</span>
          <span class="change-value ${change.dir}">
            <span class="change-arrow">${arrow}</span>
            ${sign}${Math.abs(change.diff).toFixed(5)}
          </span>
        </div>
      `;
    }
    
    function updateSess() {
      const now = new Date();
      const h = now.getUTCHours();
      let s = 'LATE_US';
      if (h >= 0 && h < 7) s = 'ASIAN';
      else if (h >= 7 && h < 12) s = 'EUROPEAN';
      else if (h >= 12 && h < 17) s = 'OVERLAP';
      else if (h >= 17 && h < 22) s = 'US';
      document.getElementById('mSession').textContent = s;
      document.getElementById('mTime').textContent = now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', timeZone:'UTC'}) + ' UTC';
    }
    
    function getTier(t) {
      if (!t) return 'c';
      return t === 'A+' ? 'aplus' : t.toLowerCase();
    }
    
    function fmt(ts) {
      if (!ts) return 'N/A';
      const d = new Date(ts);
      return d.toLocaleString('en-US', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
    }
    
    function showEmpty(cid, icon, title, desc) {
      document.getElementById(cid).innerHTML = `<div class="empty"><i data-lucide="${icon}" class="empty-icon"></i><div class="empty-title">${title}</div><div class="empty-desc">${desc}</div></div>`;
      lucide.createIcons();
    }
  </script>
</body>
</html>
